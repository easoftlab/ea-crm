{% extends 'base.html' %}
{% block title %}Add Lead{% endblock %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-10 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-primary text-white">
        <h4 class="mb-0">Lead Generation</h4>
      </div>
      <div class="card-body">
        <form method="POST" novalidate id="leadForm">
          {{ form.hidden_tag() }}
          <!-- Company Info -->
          <div class="mb-3">
            <label class="form-label">Company Name <span class="text-danger">*</span></label>
            {{ form.company_name(class="form-control", placeholder="Enter company name", required=True) }}
            <div class="invalid-feedback">Company Name is required.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Company Website <span class="text-danger">*</span></label>
            {{ form.company_website(class="form-control", placeholder="https://company.com", required=True) }}
            <div class="invalid-feedback">Company Website is required.</div>
          </div>
          <div class="row mb-3">
            <div class="col-md-12">
              <label class="form-label">Country <span class="text-danger">*</span></label>
              <select name="country" id="country-select" class="form-control" required>
                <option value="">Select or type...</option>
                <option value="USA">USA</option>
                <option value="UK">UK</option>
                <option value="Australia">Australia</option>
                {% for val in countries %}
                  {% if val not in ['USA', 'UK', 'Australia'] %}
                    <option value="{{ val }}" {% if form.country.data == val %}selected{% endif %}>{{ val }}</option>
                  {% endif %}
                {% endfor %}
              </select>
              <div class="invalid-feedback">Country is required.</div>
            </div>
          </div>
          <div id="us-fields" class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">State</label>
              <select name="state" id="state-select" class="form-control">
                <option value="">Select or type...</option>
                {% for val in states %}
                  <option value="{{ val }}" {% if form.state.data == val %}selected{% endif %}>{{ val }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Timezone</label>
              <select name="timezone" id="timezone-select" class="form-control">
                <option value="">Select or type...</option>
                <option value="EST" {% if form.timezone.data == 'EST' %}selected{% endif %}>EST</option>
                <option value="CST" {% if form.timezone.data == 'CST' %}selected{% endif %}>CST</option>
                <option value="MST" {% if form.timezone.data == 'MST' %}selected{% endif %}>MST</option>
                <option value="PST" {% if form.timezone.data == 'PST' %}selected{% endif %}>PST</option>
                <option value="AKST" {% if form.timezone.data == 'AKST' %}selected{% endif %}>AKST</option>
                <option value="HST" {% if form.timezone.data == 'HST' %}selected{% endif %}>HST</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Industry</label>
            <select name="industry" id="industry-select" class="form-control">
              <option value="">Select or type...</option>
              {% for val in industries %}
                <option value="{{ val }}" {% if form.industry.data == val %}selected{% endif %}>{{ val }}</option>
              {% endfor %}
            </select>
          </div>
          <!-- Source field is hidden for now -->
          <div class="mb-3">
            {{ form.source.label(class="form-label") }}
            {{ form.source(class="form-select") }}
          </div>
          <!-- Dynamic Contacts Section -->
          <div class="mb-3">
            <label class="form-label">Contacts</label>
            <div id="contacts-list"></div>
            <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-contact-btn">+ Add Contact</button>
          </div>
          <!-- Notes -->
          <div class="mb-3">
            {{ form.notes.label(class="form-label") }}
            {{ form.notes(class="form-control", rows=2, placeholder="Write down notes (Company Details)") }}
          </div>
          <!-- Hidden field for contacts JSON -->
          <input type="hidden" name="contacts_json" id="contacts-json">
          <div class="d-grid">
            {{ form.submit(class="btn btn-primary btn-lg") }}
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Duplicate Warning Card -->
<div id="duplicate-warning" class="row justify-content-center mt-3" style="display: none;">
  <div class="col-md-10 col-lg-8">
    <div class="card border-warning">
      <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">
          <i class="bi bi-exclamation-triangle"></i> 
          Potential Duplicates Found!
        </h5>
      </div>
      <div class="card-body">
        <p class="text-muted mb-3">
          The following leads appear to be duplicates. Please review before proceeding:
        </p>
        
        <!-- Company Name Duplicates -->
        <div id="company-name-duplicates" class="mb-3" style="display: none;">
          <h6 class="text-danger">
            <i class="bi bi-building"></i> Company Name Duplicates
          </h6>
          <div class="duplicate-list"></div>
        </div>
        
        <!-- Company Website Duplicates -->
        <div id="company-website-duplicates" class="mb-3" style="display: none;">
          <h6 class="text-danger">
            <i class="bi bi-globe"></i> Company Website Duplicates
          </h6>
          <div class="duplicate-list"></div>
        </div>
        
        <!-- Email Duplicates -->
        <div id="email-duplicates" class="mb-3" style="display: none;">
          <h6 class="text-danger">
            <i class="bi bi-envelope"></i> Email Duplicates
          </h6>
          <div class="duplicate-list"></div>
        </div>
        
        <!-- Phone Duplicates -->
        <div id="phone-duplicates" class="mb-3" style="display: none;">
          <h6 class="text-danger">
            <i class="bi bi-telephone"></i> Phone Duplicates
          </h6>
          <div class="duplicate-list"></div>
        </div>
        
        <div class="d-flex justify-content-between align-items-center">
          <button type="button" class="btn btn-outline-secondary" onclick="hideDuplicateWarning()">
            <i class="bi bi-x-circle"></i> Dismiss Warning
          </button>
          <button type="button" class="btn btn-warning" onclick="proceedAnyway()">
            <i class="bi bi-arrow-right"></i> Proceed Anyway
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Choices.js for country, state, timezone
  new Choices('#country-select', { removeItemButton: true, allowHTML: false, addItems: true, duplicateItemsAllowed: false, allowAddItem: true, placeholder: true, placeholderValue: 'Select or type...', shouldSort: false });
  new Choices('#state-select', { removeItemButton: true, allowHTML: false, addItems: true, duplicateItemsAllowed: false, allowAddItem: true, placeholder: true, placeholderValue: 'Select or type...', shouldSort: true });
  const timezoneChoices = new Choices('#timezone-select', { removeItemButton: true, allowHTML: false, addItems: true, duplicateItemsAllowed: false, allowAddItem: true, placeholder: true, placeholderValue: 'Select or type...', shouldSort: false });
  new Choices('#industry-select', { removeItemButton: true, allowHTML: false, addItems: true, duplicateItemsAllowed: false, allowAddItem: true, placeholder: true, placeholderValue: 'Select or type...', shouldSort: false });

  // Show/hide US fields based on country
  function showHideUSFields() {
    const country = document.getElementById('country-select').value;
    const usFields = document.getElementById('us-fields');
    if (country === 'USA') {
      usFields.style.display = '';
    } else {
      usFields.style.display = 'none';
      document.getElementById('state-select').value = '';
      timezoneChoices.removeActiveItems();
    }
  }
  document.getElementById('country-select').addEventListener('change', showHideUSFields);
  showHideUSFields();

  // US state to timezone mapping
  const stateToTimezone = {
    'Maine': 'EST', 'New Hampshire': 'EST', 'Vermont': 'EST', 'Massachusetts': 'EST', 'Rhode Island': 'EST', 'Connecticut': 'EST',
    'New York': 'EST', 'New Jersey': 'EST', 'Pennsylvania': 'EST', 'Delaware': 'EST', 'Maryland': 'EST', 'District of Columbia': 'EST',
    'Virginia': 'EST', 'West Virginia': 'EST', 'North Carolina': 'EST', 'South Carolina': 'EST', 'Georgia': 'EST', 'Florida': 'EST',
    'Ohio': 'EST', 'Michigan': 'EST', 'Indiana': 'EST', 'Kentucky': 'EST', 'Tennessee': 'CST', 'Alabama': 'CST', 'Mississippi': 'CST',
    'Illinois': 'CST', 'Wisconsin': 'CST', 'Minnesota': 'CST', 'Iowa': 'CST', 'Missouri': 'CST', 'Arkansas': 'CST', 'Louisiana': 'CST',
    'Texas': 'CST', 'Oklahoma': 'CST', 'Kansas': 'CST', 'Nebraska': 'CST', 'South Dakota': 'CST', 'North Dakota': 'CST',
    'Montana': 'MST', 'Wyoming': 'MST', 'Colorado': 'MST', 'New Mexico': 'MST', 'Arizona': 'MST', 'Utah': 'MST', 'Idaho': 'MST',
    'California': 'PST', 'Oregon': 'PST', 'Washington': 'PST', 'Nevada': 'PST', 'Alaska': 'AKST', 'Hawaii': 'HST'
  };
  function updateTimezone() {
    const country = document.getElementById('country-select').value;
    const state = document.getElementById('state-select').value;
    if (country === 'USA' && stateToTimezone[state]) {
      timezoneChoices.removeActiveItems();
      timezoneChoices.setChoiceByValue(stateToTimezone[state]);
    }
  }
  document.getElementById('state-select').addEventListener('change', updateTimezone);
  document.getElementById('country-select').addEventListener('change', updateTimezone);

  // Dynamic contacts logic
  let contactIdx = 0;
  function createContactBlock(idx) {
    return `
    <div class="card mb-3 contact-block" data-idx="${idx}">
      <div class="card-body">
        <div class="row">
          <div class="col-md-4 mb-2">
            <input type="text" class="form-control contact-name" placeholder="Contact Name *" required>
          </div>
          <div class="col-md-4 mb-2">
            <input type="text" class="form-control contact-position" placeholder="Position/Title">
          </div>
          <div class="col-md-4 mb-2">
            <input type="text" class="form-control contact-linkedin" placeholder="LinkedIn Profile (optional)">
          </div>
        </div>
        <div class="row">
          <div class="col-md-6 mb-2">
            <label class="form-label small">Phone(s) *</label>
            <div class="phones-list"></div>
            <button type="button" class="btn btn-outline-secondary btn-sm add-phone-btn">+ Add Phone</button>
          </div>
          <div class="col-md-6 mb-2">
            <label class="form-label contact-emails-label">Email(s) <span class="text-danger">*</span></label>
            <div class="emails-list"></div>
            <button type="button" class="btn btn-outline-secondary btn-sm add-email-btn">+ Add Email</button>
          </div>
        </div>
        <div class="mb-2">
          <label class="form-label small">Social Profiles</label>
          <div class="socials-list"></div>
          <button type="button" class="btn btn-outline-secondary btn-sm add-social-btn">+ Add Social</button>
        </div>
        <div class="mb-2">
          <textarea class="form-control contact-notes" rows="1" placeholder="Contact Notes (optional)"></textarea>
        </div>
        <button type="button" class="btn btn-danger btn-sm remove-contact-btn">Remove Contact</button>
      </div>
    </div>
    `;
  }
  function createPhoneInput() {
    return `<div class="input-group mb-1"><input type="text" class="form-control contact-phone" placeholder="Phone *" required><button type="button" class="btn btn-outline-danger btn-sm remove-phone-btn">&times;</button></div>`;
  }
  function createEmailInput() {
    return `<div class="input-group mb-1"><input type="email" class="form-control contact-email" placeholder="Email"><button type="button" class="btn btn-outline-danger btn-sm remove-email-btn">&times;</button></div>`;
  }
  function createSocialInput() {
    return `<div class="input-group mb-1">
      <select class="form-control social-type" placeholder="Type (LinkedIn, Facebook, etc.)">
        <option value="">Select or type...</option>
        <option value="LinkedIn">LinkedIn</option>
        <option value="Facebook">Facebook</option>
        <option value="Twitter">Twitter</option>
        <option value="Instagram">Instagram</option>
        <option value="WhatsApp">WhatsApp</option>
        <option value="Telegram">Telegram</option>
        <option value="Skype">Skype</option>
        <option value="WeChat">WeChat</option>
        <option value="TikTok">TikTok</option>
        <option value="YouTube">YouTube</option>
        <option value="Other">Other</option>
      </select>
      <input type="url" class="form-control social-url" placeholder="Profile URL">
      <button type="button" class="btn btn-outline-danger btn-sm remove-social-btn">&times;</button>
    </div>`;
  }
  function updateContactsJson() {
    const contacts = [];
    document.querySelectorAll('.contact-block').forEach(block => {
      const name = block.querySelector('.contact-name').value.trim();
      const position = block.querySelector('.contact-position').value.trim();
      const linkedin = block.querySelector('.contact-linkedin').value.trim();
      const notes = block.querySelector('.contact-notes').value.trim();
      const phones = Array.from(block.querySelectorAll('.contact-phone')).map(p => p.value.trim()).filter(Boolean);
      const emails = Array.from(block.querySelectorAll('.contact-email')).map(e => e.value.trim()).filter(Boolean);
      const socials = Array.from(block.querySelectorAll('.social-type')).map((typeInput, i) => {
        const urlInput = block.querySelectorAll('.social-url')[i];
        return { type: typeInput.value.trim(), url: urlInput.value.trim() };
      }).filter(s => s.type || s.url);
      if (name && phones.length) {
        contacts.push({ name, position, linkedin, notes, phones, emails, socials });
      }
    });
    document.getElementById('contacts-json').value = JSON.stringify(contacts);
    
    // Trigger duplicate check when contacts are modified
    if (typeof checkDuplicates === 'function') {
      clearTimeout(duplicateCheckTimeout);
      duplicateCheckTimeout = setTimeout(checkDuplicates, 1000);
    }
  }
  document.getElementById('add-contact-btn').addEventListener('click', function() {
    const idx = contactIdx++;
    const block = document.createElement('div');
    block.innerHTML = createContactBlock(idx);
    document.getElementById('contacts-list').appendChild(block.firstElementChild);
    updateContactsJson();
  });
  document.getElementById('contacts-list').addEventListener('click', function(e) {
    if (e.target.classList.contains('remove-contact-btn')) {
      e.target.closest('.contact-block').remove();
      updateContactsJson();
    } else if (e.target.classList.contains('add-phone-btn')) {
      const phonesList = e.target.closest('.contact-block').querySelector('.phones-list');
      phonesList.insertAdjacentHTML('beforeend', createPhoneInput());
      updateContactsJson();
    } else if (e.target.classList.contains('remove-phone-btn')) {
      e.target.closest('.input-group').remove();
      updateContactsJson();
    } else if (e.target.classList.contains('add-email-btn')) {
      const emailsList = e.target.closest('.contact-block').querySelector('.emails-list');
      emailsList.insertAdjacentHTML('beforeend', createEmailInput());
      updateContactsJson();
    } else if (e.target.classList.contains('remove-email-btn')) {
      e.target.closest('.input-group').remove();
      updateContactsJson();
    } else if (e.target.classList.contains('add-social-btn')) {
      const socialsList = e.target.closest('.contact-block').querySelector('.socials-list');
      socialsList.insertAdjacentHTML('beforeend', createSocialInput());
      // Initialize Choices.js for the new social-type select
      const newSocialType = socialsList.querySelector('.social-type:last-child');
      new Choices(newSocialType, { removeItemButton: true, allowHTML: false, addItems: true, duplicateItemsAllowed: false, allowAddItem: true, placeholder: true, placeholderValue: 'Select or type...', shouldSort: false });
      updateContactsJson();
    } else if (e.target.classList.contains('remove-social-btn')) {
      e.target.closest('.input-group').remove();
      updateContactsJson();
    }
  });
  document.getElementById('contacts-list').addEventListener('input', function(e) {
    updateContactsJson();
    
    // Trigger duplicate check for contact fields
    if (e.target.classList.contains('contact-name') || 
        e.target.classList.contains('contact-phone') || 
        e.target.classList.contains('contact-email')) {
      if (typeof checkDuplicates === 'function') {
        clearTimeout(duplicateCheckTimeout);
        duplicateCheckTimeout = setTimeout(checkDuplicates, 1000);
      }
    }
  });
  
  document.getElementById('leadForm').addEventListener('submit', function() {
    updateContactsJson();
  });
  // Add one contact by default
  if (document.getElementById('contacts-list').children.length === 0) {
    document.getElementById('add-contact-btn').click();
  }
  // Make contact name, position/title, phone, and email required
  document.getElementById('contacts-list').addEventListener('input', function(e) {
    if (e.target.classList.contains('contact-name')) {
      e.target.required = true;
    }
    if (e.target.classList.contains('contact-position')) {
      e.target.required = true;
    }
    if (e.target.classList.contains('contact-phone')) {
      e.target.required = true;
    }
    if (e.target.classList.contains('contact-email')) {
      e.target.required = true;
    }
  });
  // Custom validation for main form
  const leadForm = document.getElementById('leadForm');
  leadForm.addEventListener('submit', function(e) {
    let valid = true;
    // Validate main required fields
    ['company_name', 'company_website', 'country'].forEach(function(id) {
      const el = document.getElementsByName(id)[0];
      if (el && !el.value.trim()) {
        el.classList.add('is-invalid');
        valid = false;
      } else if (el) {
        el.classList.remove('is-invalid');
      }
    });
    // Validate state/timezone if USA
    if (document.getElementById('country-select').value === 'USA') {
      ['state', 'timezone'].forEach(function(id) {
        const el = document.getElementsByName(id)[0];
        if (el && !el.value.trim()) {
          el.classList.add('is-invalid');
          valid = false;
        } else if (el) {
          el.classList.remove('is-invalid');
        }
      });
    }
    // Validate dynamic contacts
    document.querySelectorAll('.contact-block').forEach(function(block) {
      const name = block.querySelector('.contact-name');
      const position = block.querySelector('.contact-position');
      const phones = block.querySelectorAll('.contact-phone');
      const emails = block.querySelectorAll('.contact-email');
      let contactValid = true;
      if (!name.value.trim()) {
        name.classList.add('is-invalid');
        contactValid = false;
      } else {
        name.classList.remove('is-invalid');
      }
      if (!position.value.trim()) {
        position.classList.add('is-invalid');
        contactValid = false;
      } else {
        position.classList.remove('is-invalid');
      }
      let hasPhone = false;
      phones.forEach(function(phone) {
        if (phone.value.trim()) hasPhone = true;
        phone.required = true;
        if (!phone.value.trim()) phone.classList.add('is-invalid');
        else phone.classList.remove('is-invalid');
      });
      if (!hasPhone) contactValid = false;
      let hasEmail = false;
      emails.forEach(function(email) {
        if (email.value.trim()) hasEmail = true;
        email.required = true;
        if (!email.value.trim()) email.classList.add('is-invalid');
        else email.classList.remove('is-invalid');
      });
      if (!hasEmail) contactValid = false;
      // Add asterisk to Email(s) label if not present
      const emailLabel = block.querySelector('.contact-emails-label');
      if (emailLabel && !emailLabel.innerHTML.includes('*')) {
        emailLabel.innerHTML = 'Email(s) <span class="text-danger">*</span>';
      }
      if (!contactValid) valid = false;
    });
    if (!valid) {
      e.preventDefault();
      e.stopPropagation();
    }
  });
  // Remove is-invalid on input
  leadForm.addEventListener('input', function(e) {
    if (e.target.classList.contains('is-invalid')) {
      e.target.classList.remove('is-invalid');
    }
  });
  flatpickr('#datepicker', {
    enableTime: true,
    dateFormat: 'Y-m-d H:i',
    time_24hr: true,
    allowInput: true,
    altInput: true,
    altFormat: 'F j, Y H:i',
    placeholder: 'YYYY-MM-DD HH:MM'
  });

  // Deduplication functionality
  let duplicateCheckTimeout;
  let hasDuplicates = false;

  // Function to collect form data
  function collectFormData() {
    const companyName = document.getElementById('company_name').value.trim();
    const companyWebsite = document.getElementById('company_website').value.trim();
    const contacts = [];
    
    document.querySelectorAll('.contact-block').forEach(block => {
      const name = block.querySelector('.contact-name').value.trim();
      const position = block.querySelector('.contact-position').value.trim();
      const phones = Array.from(block.querySelectorAll('.contact-phone')).map(p => p.value.trim()).filter(p => p);
      const emails = Array.from(block.querySelectorAll('.contact-email')).map(e => e.value.trim()).filter(e => e);
      
      if (name) {
        contacts.push({
          name: name,
          position: position,
          phones: phones,
          emails: emails
        });
      }
    });
    
    return {
      company_name: companyName,
      company_website: companyWebsite,
      contacts: contacts
    };
  }

  // Function to check for duplicates
  async function checkDuplicates() {
    const formData = collectFormData();
    
    // Only check if we have meaningful data
    if (!formData.company_name && !formData.company_website && formData.contacts.length === 0) {
      hideDuplicateWarning();
      return;
    }
    
    try {
      const response = await fetch('/api/check_duplicates', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      });
      
      const result = await response.json();
      
      if (result.success && result.has_duplicates) {
        showDuplicateWarning(result.duplicates);
        hasDuplicates = true;
      } else {
        hideDuplicateWarning();
        hasDuplicates = false;
      }
    } catch (error) {
      console.error('Error checking duplicates:', error);
    }
  }

  // Function to show duplicate warning
  function showDuplicateWarning(duplicates) {
    const warningCard = document.getElementById('duplicate-warning');
    
    // Clear previous content
    document.querySelectorAll('.duplicate-list').forEach(list => list.innerHTML = '');
    
    // Show company name duplicates
    if (duplicates.company_name.length > 0) {
      const container = document.getElementById('company-name-duplicates');
      container.style.display = 'block';
      const list = container.querySelector('.duplicate-list');
      
      duplicates.company_name.forEach(dupe => {
        const card = createDuplicateCard(dupe, 'Company Name');
        list.appendChild(card);
      });
    }
    
    // Show company website duplicates
    if (duplicates.company_website.length > 0) {
      const container = document.getElementById('company-website-duplicates');
      container.style.display = 'block';
      const list = container.querySelector('.duplicate-list');
      
      duplicates.company_website.forEach(dupe => {
        const card = createDuplicateCard(dupe, 'Company Website');
        list.appendChild(card);
      });
    }
    
    // Show email duplicates
    if (duplicates.email.length > 0) {
      const container = document.getElementById('email-duplicates');
      container.style.display = 'block';
      const list = container.querySelector('.duplicate-list');
      
      duplicates.email.forEach(dupe => {
        const card = createDuplicateCard(dupe, 'Email', dupe.matching_email);
        list.appendChild(card);
      });
    }
    
    // Show phone duplicates
    if (duplicates.phone.length > 0) {
      const container = document.getElementById('phone-duplicates');
      container.style.display = 'block';
      const list = container.querySelector('.duplicate-list');
      
      duplicates.phone.forEach(dupe => {
        const card = createDuplicateCard(dupe, 'Phone', dupe.matching_phone);
        list.appendChild(card);
      });
    }
    
    warningCard.style.display = 'block';
  }

  // Function to create duplicate card
  function createDuplicateCard(dupe, matchType, matchingValue = '') {
    const card = document.createElement('div');
    card.className = 'card mb-2 border-danger';
    card.innerHTML = `
      <div class="card-body p-3">
        <div class="row">
          <div class="col-md-8">
            <h6 class="card-title mb-1">
              <a href="/lead/${dupe.id}" target="_blank" class="text-decoration-none">
                ${dupe.company_name}
              </a>
            </h6>
            <p class="card-text mb-1">
              <small class="text-muted">
                <i class="bi bi-globe"></i> ${dupe.company_website}<br>
                <i class="bi bi-geo-alt"></i> ${dupe.country}${dupe.state ? ', ' + dupe.state : ''}<br>
                <i class="bi bi-briefcase"></i> ${dupe.industry || 'N/A'}<br>
                <i class="bi bi-calendar"></i> Created: ${dupe.created_at}<br>
                <span class="badge bg-${getStatusColor(dupe.status)}">${dupe.status}</span>
              </small>
            </p>
            ${matchingValue ? `<p class="mb-1"><small class="text-danger"><strong>Matching ${matchType}:</strong> ${matchingValue}</small></p>` : ''}
          </div>
          <div class="col-md-4">
            <h6 class="text-muted">Contacts:</h6>
            ${dupe.contacts.map(contact => `
              <div class="mb-1">
                <strong>${contact.name}</strong>${contact.position ? ` (${contact.position})` : ''}<br>
                ${contact.phones.map(phone => `<small class="text-muted">üìû ${phone}</small>`).join('<br>')}
                ${contact.emails.map(email => `<small class="text-muted">‚úâÔ∏è ${email}</small>`).join('<br>')}
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
    return card;
  }

  // Function to get status color
  function getStatusColor(status) {
    const colors = {
      'New': 'secondary',
      'Follow Up': 'primary',
      'Interested': 'info',
      'Converted': 'success',
      'Not Interested': 'danger',
      'Call not reach': 'warning',
      'No Answer': 'warning',
      'Do Not Call': 'dark'
    };
    return colors[status] || 'secondary';
  }

  // Function to hide duplicate warning
  function hideDuplicateWarning() {
    document.getElementById('duplicate-warning').style.display = 'none';
    document.querySelectorAll('.duplicate-list').forEach(list => list.innerHTML = '');
    document.querySelectorAll('[id$="-duplicates"]').forEach(div => div.style.display = 'none');
    hasDuplicates = false;
  }

  // Function to proceed anyway
  function proceedAnyway() {
    hasDuplicates = false;
    hideDuplicateWarning();
    document.getElementById('leadForm').submit();
  }

  // Add event listeners for duplicate checking
  const duplicateCheckFields = ['company_name', 'company_website'];
  duplicateCheckFields.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      field.addEventListener('input', function() {
        clearTimeout(duplicateCheckTimeout);
        duplicateCheckTimeout = setTimeout(checkDuplicates, 1000); // Check after 1 second of no typing
      });
    }
  });

  // Check duplicates when contacts are added/modified
  document.addEventListener('contactAdded', checkDuplicates);
  document.addEventListener('contactModified', checkDuplicates);

  // Override form submission to check for duplicates
  document.getElementById('leadForm').addEventListener('submit', function(e) {
    if (hasDuplicates) {
      e.preventDefault();
      alert('Please review the duplicate warnings before proceeding.');
      return false;
    }
  });
});
</script>
{% endblock %} 