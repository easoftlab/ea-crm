{% extends 'base.html' %}
{% block title %}{{ user.get_full_name() }} - My Converted Clients{% endblock %}
{% block content %}
<!-- Header & Navigation -->
<div class="d-flex justify-content-between align-items-center mt-4 mb-3">
  <div>
    <h2 class="mb-0"><span>üèÜ</span> My Converted Clients</h2>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item"><a href="{{ url_for('main.personal_dashboard') }}">My Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">My Converted Clients</li>
      </ol>
    </nav>
    <small class="text-muted">Showing only your converted leads and performance metrics</small>
  </div>
  <div>
    <a href="{{ url_for('main.personal_dashboard') }}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back to My Dashboard
    </a>
  </div>
</div>
<!-- End Header & Navigation -->
<!-- Summary Cards (Top Row) -->
<div class="row mb-4">
  <div class="col-md-4 mb-3 mb-md-0">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex align-items-center">
        <span class="fs-2 me-3">üèÜ</span>
        <div>
          <h6 class="card-title mb-1">My Total Converted</h6>
          <h4 class="mb-0">{{ total_converted }}</h4>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4 mb-3 mb-md-0">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex align-items-center">
        <span class="fs-2 me-3">üìà</span>
        <div>
          <h6 class="card-title mb-1">My Conversion Rate</h6>
          <h4 class="mb-0">{{ conversion_rate }}%</h4>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-body d-flex align-items-center">
        <span class="fs-2 me-3">üïí</span>
        <div>
          <h6 class="card-title mb-1">My Recent Conversions</h6>
          <h4 class="mb-0">{{ recent_conversions }}</h4>
          <small class="text-muted">(This week)</small>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End Summary Cards -->
<!-- Filter & Search Bar -->
<form method="get" class="mb-4">
  <div class="row g-2 align-items-end">
    <div class="col-md-4">
      <label for="search" class="form-label mb-0">Search</label>
      <input type="text" class="form-control" id="search" name="search" placeholder="Name, Company, Email, Phone" value="{{ request.args.get('search', '') }}">
    </div>
    <div class="col-md-3">
      <label for="industry" class="form-label mb-0">Industry</label>
      <select class="form-select" id="industry" name="industry">
        <option value="">All</option>
        {% for ind in industries %}
          <option value="{{ ind }}" {% if request.args.get('industry') == ind %}selected{% endif %}>{{ ind }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="country" class="form-label mb-0">Country</label>
      <select class="form-select" id="country" name="country">
        <option value="">All</option>
        {% for c in countries %}
          <option value="{{ c }}" {% if request.args.get('country') == c %}selected{% endif %}>{{ c }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2 d-grid">
      <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Filter</button>
    </div>
  </div>
</form>
<!-- End Filter & Search Bar -->
<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th><span>üè¢</span> Company</th>
        <th><span>üåç</span> Country/State</th>
        <th><span>üè∑Ô∏è</span> Industry</th>
        <th><span>üë§</span> Contact</th>
        <th><span>üíº</span> Position</th>
        <th><span>üìû</span> Phone</th>
        <th><span>‚úâÔ∏è</span> Email</th>
        <th><span>üü¢</span> Status</th>
        <th><span>üìÖ</span> Follow-up</th>
      </tr>
    </thead>
    <tbody id="converted-table-body" class="accordion" data-bs-parent="#converted-table-body">
      {% for lead in leads %}
      <tr class="accordion-item">
        <td>
          <div class="d-flex align-items-center">
            <button class="btn btn-sm btn-outline-primary me-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ lead.id }}" aria-expanded="false">
              <i class="bi bi-chevron-down"></i>
            </button>
            <div>
              <strong>{{ lead.company_name }}</strong>
              {% if lead.company_website %}
              <br><small class="text-muted">{{ lead.company_website }}</small>
              {% endif %}
            </div>
          </div>
        </td>
        <td>
          {% if lead.country %}{{ lead.country }}{% endif %}
          {% if lead.state and lead.country %}, {% endif %}
          {% if lead.state %}{{ lead.state }}{% endif %}
        </td>
        <td>
          {% if lead.industry %}
          <span class="badge bg-info">{{ lead.industry }}</span>
          {% endif %}
        </td>
        <td>
          {% if lead.contacts %}
          <span class="badge bg-success">{{ lead.contacts|length }} contact{{ 's' if lead.contacts|length != 1 else '' }}</span>
          {% else %}
          <span class="badge bg-warning">No contacts</span>
          {% endif %}
        </td>
        <td>
          {% if lead.contacts and lead.contacts[0].position %}
          {{ lead.contacts[0].position }}
          {% else %}
          <span class="text-muted">-</span>
          {% endif %}
        </td>
        <td>
          {% if lead.contacts and lead.contacts[0].phones %}
          <div class="d-flex flex-column">
            {% for phone in lead.contacts[0].phones[:2] %}
            <span class="copy-on-click" data-copy="{{ phone }}" style="cursor: pointer;">{{ phone }}</span>
            {% endfor %}
            {% if lead.contacts[0].phones|length > 2 %}
            <small class="text-muted">+{{ lead.contacts[0].phones|length - 2 }} more</small>
            {% endif %}
          </div>
          {% else %}
          <span class="text-muted">-</span>
          {% endif %}
        </td>
        <td>
          {% if lead.contacts and lead.contacts[0].emails %}
          <div class="d-flex flex-column">
            {% for email in lead.contacts[0].emails[:2] %}
            <span class="copy-on-click" data-copy="{{ email }}" style="cursor: pointer;">{{ email }}</span>
            {% endfor %}
            {% if lead.contacts[0].emails|length > 2 %}
            <small class="text-muted">+{{ lead.contacts[0].emails|length - 2 }} more</small>
            {% endif %}
          </div>
          {% else %}
          <span class="text-muted">-</span>
          {% endif %}
        </td>
        <td>
          <span class="badge bg-success">{{ lead.status }}</span>
        </td>
        <td>
          {% if lead.followup_date %}
          <span class="badge bg-warning">{{ lead.followup_date }}</span>
          {% else %}
          <span class="text-muted">-</span>
          {% endif %}
        </td>
      </tr>
      <!-- Expanded Details Row -->
      <tr class="accordion-collapse collapse" id="collapse-{{ lead.id }}" data-bs-parent="#converted-table-body">
        <td colspan="9">
          <div class="p-3 bg-light">
            <div class="row">
              <div class="col-md-6">
                <h6><i class="bi bi-info-circle"></i> Lead Details</h6>
                <p><strong>Created:</strong> {{ lead.created_at }}</p>
                <p><strong>Last Updated:</strong> {{ lead.updated_at }}</p>
                {% if lead.source %}
                <p><strong>Source:</strong> {{ lead.source }}</p>
                {% endif %}
                {% if lead.timezone %}
                <p><strong>Timezone:</strong> {{ lead.timezone }}</p>
                {% endif %}
                {% if lead.notes %}
                <div>
                  <strong>Notes:</strong>
                  <div class="mt-2 p-2 bg-white border rounded">
                    {{ lead.notes|nl2br }}
                  </div>
                </div>
                {% endif %}
              </div>
              <div class="col-md-6">
                <h6><i class="bi bi-people"></i> All Contacts</h6>
                {% if lead.contacts %}
                {% for contact in lead.contacts %}
                <div class="card mb-2">
                  <div class="card-body p-2">
                    <h6 class="mb-1">{{ contact.name }}</h6>
                    {% if contact.position %}
                    <p class="mb-1 text-muted">{{ contact.position }}</p>
                    {% endif %}
                    {% if contact.phones %}
                    <div class="mb-1">
                      <strong>Phones:</strong>
                      {% for phone in contact.phones %}
                      <span class="copy-on-click d-block" data-copy="{{ phone }}" style="cursor: pointer;">{{ phone }}</span>
                      {% endfor %}
                    </div>
                    {% endif %}
                    {% if contact.emails %}
                    <div class="mb-1">
                      <strong>Emails:</strong>
                      {% for email in contact.emails %}
                      <span class="copy-on-click d-block" data-copy="{{ email }}" style="cursor: pointer;">{{ email }}</span>
                      {% endfor %}
                    </div>
                    {% endif %}
                    {% if contact.socials %}
                    <div>
                      <strong>Social:</strong>
                      {% for social in contact.socials %}
                      <a href="{{ social.url }}" target="_blank" class="d-block">{{ social.type }}</a>
                      {% endfor %}
                    </div>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-muted">No contacts added</p>
                {% endif %}
              </div>
            </div>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- No results message -->
{% if not leads %}
<div class="text-center py-5">
  <div class="display-1 text-muted mb-3">üèÜ</div>
  <h3>No Converted Clients Yet</h3>
  <p class="text-muted">You haven't converted any leads yet. Keep working on your leads and they'll appear here!</p>
  <a href="{{ url_for('main.add_lead') }}" class="btn btn-primary">
    <i class="bi bi-plus-circle"></i> Add New Lead
  </a>
</div>
{% endif %}

<script>
// Copy functionality
document.addEventListener('DOMContentLoaded', function() {
  const copyElements = document.querySelectorAll('.copy-on-click');
  copyElements.forEach(function(element) {
    element.addEventListener('click', function() {
      const text = this.getAttribute('data-copy');
      navigator.clipboard.writeText(text).then(function() {
        const originalText = element.textContent;
        element.textContent = 'Copied!';
        element.style.color = '#28a745';
        setTimeout(function() {
          element.textContent = originalText;
          element.style.color = '';
        }, 1000);
      });
    });
  });
});
</script>
{% endblock %} 