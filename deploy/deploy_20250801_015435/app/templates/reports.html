{% extends 'base.html' %}
{% block title %}üìà Reports{% endblock %}
{% block content %}
<div class="container-fluid">
  <div class="d-flex align-items-center mb-4">
    <h2 class="me-2">üìà Reporting Dashboard</h2>
    <span class="badge bg-secondary">Beta</span>
  </div>
  <!-- Export/Print Buttons - Admin Only -->
  {% if current_user.has_permission('admin') %}
  <div class="mb-3">
    <button class="btn btn-outline-success me-2" id="export-csv">Export CSV</button>
    <button class="btn btn-outline-primary me-2" id="export-excel">Export Excel</button>
    <button class="btn btn-outline-secondary" id="print-report">Print</button>
  </div>
  {% endif %}
  <!-- Filter Bar -->
  <form id="report-filters" class="row g-2 mb-4 align-items-end">
    <div class="col-md-3">
      <label for="filter-date-from" class="form-label">From</label>
      <input type="date" class="form-control" id="filter-date-from" name="from">
    </div>
    <div class="col-md-3">
      <label for="filter-date-to" class="form-label">To</label>
      <input type="date" class="form-control" id="filter-date-to" name="to">
    </div>
    <div class="col-md-2">
      <label for="filter-status" class="form-label">Status</label>
      <select class="form-select" id="filter-status" name="status">
        <option value="">All</option>
        <option>New</option>
        <option>Follow Up</option>
        <option>Converted</option>
        <option>Not Interested</option>
      </select>
    </div>
    <div class="col-md-2">
      <label for="filter-industry" class="form-label">Industry</label>
      <input type="text" class="form-control" id="filter-industry" name="industry" placeholder="All">
    </div>
    <div class="col-md-2">
      <label for="filter-country" class="form-label">Country</label>
      <input type="text" class="form-control" id="filter-country" name="country" placeholder="All">
    </div>
    <div class="col-12 mt-2">
      <button type="submit" class="btn btn-primary me-2">Apply Filters</button>
      <button type="button" class="btn btn-outline-secondary" id="clear-filters">Clear</button>
    </div>
  </form>
  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3 col-6 mb-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <div class="fs-2">üóÇÔ∏è</div>
          <h5 class="card-title">Total Leads</h5>
          <div id="summary-total-leads" class="fs-4 fw-bold">-</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <div class="fs-2">üÜï</div>
          <h5 class="card-title">New Today</h5>
          <div id="summary-new-today" class="fs-4 fw-bold">-</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <div class="fs-2">‚úÖ</div>
          <h5 class="card-title">Converted</h5>
          <div id="summary-converted" class="fs-4 fw-bold">-</div>
        </div>
      </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
      <div class="card text-center shadow-sm">
        <div class="card-body">
          <div class="fs-2">‚è∞</div>
          <h5 class="card-title">Overdue Follow-ups</h5>
          <div id="summary-overdue" class="fs-4 fw-bold">-</div>
        </div>
      </div>
    </div>
  </div>
  <!-- Pipeline & Follow-Up Insights Section -->
  <div class="row mb-4">
    <div class="col-md-4 mb-3">
      <div class="card text-center border-info">
        <div class="card-header bg-info text-white">‚è≥ Avg. Days to Follow-Up</div>
        <div class="card-body">
          <div class="fs-1" id="insight-followup-avg">-</div>
          <div class="text-muted">Median: <span id="insight-followup-median">-</span></div>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card text-center border-danger">
        <div class="card-header bg-danger text-white">‚ö†Ô∏è Overdue Follow-Ups</div>
        <div class="card-body">
          <div class="fs-1" id="insight-overdue">-</div>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card text-center border-success">
        <div class="card-header bg-success text-white">üöÄ Pipeline Velocity</div>
        <div class="card-body">
          <div>Converted: <span class="fw-bold" id="insight-velocity-conv">-</span> days</div>
          <div>Not Interested: <span class="fw-bold" id="insight-velocity-notint">-</span> days</div>
        </div>
      </div>
    </div>
  </div>
  <!-- Charts Row -->
  <div class="row mb-4">
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">Leads by Status</div>
        <div class="card-body">
          <canvas id="chart-status"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">Leads Over Time</div>
        <div class="card-body">
          <canvas id="chart-date"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="row mb-4">
    <div class="col-md-4 mb-4">
      <div class="card h-100">
        <div class="card-header">By Industry</div>
        <div class="card-body">
          <canvas id="chart-industry"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-4">
      <div class="card h-100">
        <div class="card-header">By Country</div>
        <div class="card-body">
          <canvas id="chart-country"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-4">
      <div class="card h-100">
        <div class="card-header">By Source</div>
        <div class="card-body">
          <canvas id="chart-source"></canvas>
        </div>
      </div>
    </div>
  </div>
  <!-- Conversion Funnel Section -->
  <div class="row mb-4">
    <div class="col-md-4 mb-4">
      <div class="card h-100">
        <div class="card-header">üîó Conversion by Source</div>
        <div class="card-body">
          <canvas id="chart-funnel-source"></canvas>
          <div class="table-responsive mt-3">
            <table class="table table-sm table-bordered">
              <thead><tr><th>Source</th><th>Total</th><th>Converted</th><th>Rate (%)</th></tr></thead>
              <tbody id="table-funnel-source"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-4">
      <div class="card h-100">
        <div class="card-header">üè≠ Conversion by Industry</div>
        <div class="card-body">
          <canvas id="chart-funnel-industry"></canvas>
          <div class="table-responsive mt-3">
            <table class="table table-sm table-bordered">
              <thead><tr><th>Industry</th><th>Total</th><th>Converted</th><th>Rate (%)</th></tr></thead>
              <tbody id="table-funnel-industry"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-4">
      <div class="card h-100">
        <div class="card-header">üåç Conversion by Country</div>
        <div class="card-body">
          <canvas id="chart-funnel-country"></canvas>
          <div class="table-responsive mt-3">
            <table class="table table-sm table-bordered">
              <thead><tr><th>Country</th><th>Total</th><th>Converted</th><th>Rate (%)</th></tr></thead>
              <tbody id="table-funnel-country"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Contact Engagement Section -->
  <div class="row mb-4">
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">üë• Contacts per Lead</div>
        <div class="card-body">
          <canvas id="chart-contacts-per-lead"></canvas>
        </div>
      </div>
    </div>
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">üìû Contact Method Usage</div>
        <div class="card-body text-center">
          <div class="d-flex justify-content-around align-items-center fs-3">
            <div><span title="Phone">üìû</span><br><span id="usage-phone">-</span></div>
            <div><span title="Email">‚úâÔ∏è</span><br><span id="usage-email">-</span></div>
            <div><span title="Social">üîó</span><br><span id="usage-social">-</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Missing Data Report Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-danger">
        <div class="card-header bg-danger text-white">‚ö†Ô∏è Data Quality: Missing Information</div>
        <div class="card-body">
          <ul class="list-group" id="missing-data-list">
            <li class="list-group-item">Loading...</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <!-- Duplicate Detection Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-warning">
        <div class="card-header bg-warning text-dark">‚ö†Ô∏è Data Quality: Possible Duplicates</div>
        <div class="card-body">
          <ul class="list-group" id="duplicates-list">
            <li class="list-group-item">Loading...</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Chart.js and dashboard script will be added in the next step -->
{% endblock %}

{% block scripts %}
  {{ super() }}
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Geo plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-geo@4.3.0/build/index.umd.min.js"></script>
  <!-- World GeoJSON -->
  <script src="https://cdn.jsdelivr.net/npm/world-atlas/countries-110m.json"></script>
  <script>
    // Reports dashboard initialization
    console.log('Basic script loaded!');
    
    // Initialize dashboard when page loads
    window.onload = function() {
      console.log('Window loaded!');
      console.log('Loading real data from database...');
      
      // Initialize the dashboard
      loadSummaryData();
      loadStatusChart();
      loadIndustryChart();
      loadCountryChart();
      loadSourceChart();
      loadPipelineInsights();
      loadContactEngagement();
      loadMissingData();
      loadDuplicates();
      loadConversionFunnel();
      loadDateChart(); // <-- Add this line to load the Leads Over Time chart
      
    };
    
    // Load summary data
    async function loadSummaryData() {
      try {
        console.log('Attempting to load summary data...');
        const res = await fetch('/api/reports/summary', {
          credentials: 'same-origin',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
        });
        console.log('Response status:', res.status);
        console.log('Response headers:', res.headers);
        
        if (!res.ok) {
          console.error('Response not ok:', res.status, res.statusText);
          const text = await res.text();
          console.error('Response text:', text);
          return;
        }
        
        const data = await res.json();
        console.log('Summary data loaded:', data);
        document.getElementById('summary-total-leads').textContent = data.total_leads;
        document.getElementById('summary-new-today').textContent = data.new_leads_today;
        document.getElementById('summary-converted').textContent = data.converted;
        document.getElementById('summary-overdue').textContent = data.follow_ups_due;
      } catch (error) {
        console.error('Error loading summary data:', error);
      }
    }
    
    // Load status chart
    async function loadStatusChart() {
      try {
        const res = await fetch('/api/reports/by_status', {
          credentials: 'same-origin'
        });
        const data = await res.json();
        const ctx = document.getElementById('chart-status').getContext('2d');
        renderChart(ctx, 'doughnut', Object.keys(data), Object.values(data), 'Leads by Status');
        console.log('Status chart loaded:', data);
      } catch (error) {
        console.error('Error loading status chart:', error);
      }
    }
    
    // Load industry chart
    async function loadIndustryChart() {
      try {
        const res = await fetch('/api/reports/by_industry', {
          credentials: 'same-origin'
        });
        const data = await res.json();
        const ctx = document.getElementById('chart-industry').getContext('2d');
        renderChart(ctx, 'bar', Object.keys(data), Object.values(data), 'Leads by Industry');
        console.log('Industry chart loaded:', data);
      } catch (error) {
        console.error('Error loading industry chart:', error);
      }
    }
    
    // Load country chart
    async function loadCountryChart() {
      try {
        const res = await fetch('/api/reports/by_country', {
          credentials: 'same-origin'
        });
        const data = await res.json();
        const ctx = document.getElementById('chart-country').getContext('2d');
        renderChart(ctx, 'bar', Object.keys(data), Object.values(data), 'Leads by Country');
        console.log('Country chart loaded:', data);
      } catch (error) {
        console.error('Error loading country chart:', error);
      }
    }
    
    // Load source chart
    async function loadSourceChart() {
      try {
        const res = await fetch('/api/reports/by_source', {
          credentials: 'same-origin'
        });
        const data = await res.json();
        const ctx = document.getElementById('chart-source').getContext('2d');
        renderChart(ctx, 'pie', Object.keys(data), Object.values(data), 'Leads by Source');
        console.log('Source chart loaded:', data);
      } catch (error) {
        console.error('Error loading source chart:', error);
      }
    }
    
    // Generic chart rendering function
    function renderChart(ctx, type, labels, data, title) {
      if (ctx._chartInstance) {
        ctx._chartInstance.destroy();
      }
      ctx._chartInstance = new Chart(ctx, {
        type: type,
        data: {
          labels: labels,
          datasets: [{
            label: title,
            data: data,
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
              '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: true, text: title }
          }
        }
      });
    }
    
    // Load missing data report
    async function loadMissingData() {
      const res = await fetch('/api/reports/missing_data', {
        credentials: 'same-origin'
      });
      const data = await res.json();
      const list = document.getElementById('missing-data-list');
      list.innerHTML = '';
      function leadLinks(ids) {
        return ids.length ? ids.map(id => `<a href="/lead/${id}" target="_blank">#${id}</a>`).join(', ') : '<span class="text-success">None</span>';
      }
      list.innerHTML += `<li class='list-group-item d-flex justify-content-between align-items-center'>
        <span>No Contacts</span>
        <span><b>${data.no_contacts.count}</b> ${leadLinks(data.no_contacts.leads)}</span>
      </li>`;
      list.innerHTML += `<li class='list-group-item d-flex justify-content-between align-items-center'>
        <span>No Email</span>
        <span><b>${data.no_email.count}</b> ${leadLinks(data.no_email.leads)}</span>
      </li>`;
      list.innerHTML += `<li class='list-group-item d-flex justify-content-between align-items-center'>
        <span>No Phone</span>
        <span><b>${data.no_phone.count}</b> ${leadLinks(data.no_phone.leads)}</span>
      </li>`;
    }

    // Load duplicate detection report
    async function loadDuplicates() {
      const res = await fetch('/api/reports/duplicates', {
        credentials: 'same-origin'
      });
      const data = await res.json();
      const list = document.getElementById('duplicates-list');
      list.innerHTML = '';
      function groupLinks(group) {
        return Object.entries(group).length
          ? Object.entries(group).map(([key, ids]) => `<div><b>${key}</b>: ${ids.map(id => `<a href='/lead/${id}' target='_blank'>#${id}</a>`).join(', ')}</div>`).join('')
          : '<span class="text-success">No duplicates found</span>';
      }
      list.innerHTML += `<li class='list-group-item'><b>By Company Name:</b><br>${groupLinks(data.company)}</li>`;
      list.innerHTML += `<li class='list-group-item'><b>By Email:</b><br>${groupLinks(data.email)}</li>`;
      list.innerHTML += `<li class='list-group-item'><b>By Phone:</b><br>${groupLinks(data.phone)}</li>`;
    }

    // Load contact engagement analytics
    async function loadContactEngagement() {
      const res = await fetch('/api/reports/contact_engagement', {
        credentials: 'same-origin'
      });
      const data = await res.json();
      // Contacts per lead distribution
      const counts = {};
      data.contacts_per_lead.forEach(item => {
        counts[item.count] = (counts[item.count] || 0) + 1;
      });
      const ctx = document.getElementById('chart-contacts-per-lead').getContext('2d');
      renderChart(
        ctx,
        'bar',
        Object.keys(counts),
        Object.values(counts),
        'Leads by Number of Contacts'
      );
      // Contact method usage
      document.getElementById('usage-phone').textContent = data.method_usage.phone;
      document.getElementById('usage-email').textContent = data.method_usage.email;
      document.getElementById('usage-social').textContent = data.method_usage.social;
    }

    // Load pipeline & follow-up insights
    async function loadPipelineInsights() {
      const res = await fetch('/api/reports/pipeline_insights', {
        credentials: 'same-origin'
      });
      const data = await res.json();
      
      // Round the average days to 1 decimal place
      const avgDays = Math.round(data.followup_aging.average_days * 10) / 10;
      const medianDays = Math.round(data.followup_aging.median_days * 10) / 10;
      const overdueCount = data.overdue_followups;
      const convDays = Math.round(data.pipeline_velocity.converted_avg_days * 10) / 10;
      const notIntDays = Math.round(data.pipeline_velocity.not_interested_avg_days * 10) / 10;
      
      document.getElementById('insight-followup-avg').textContent = avgDays;
      document.getElementById('insight-followup-median').textContent = medianDays;
      document.getElementById('insight-overdue').textContent = overdueCount;
      document.getElementById('insight-velocity-conv').textContent = convDays;
      document.getElementById('insight-velocity-notint').textContent = notIntDays;
      
      console.log('Pipeline insights loaded:', {
        avgDays, medianDays, overdueCount, convDays, notIntDays
      });
    }

    // Load conversion funnel analytics
    async function loadConversionFunnel() {
      const res = await fetch('/api/reports/conversion_funnel', {
        credentials: 'same-origin'
      });
      const data = await res.json();
      function renderFunnelChart(ctxId, group) {
        const ctx = document.getElementById(ctxId).getContext('2d');
        const labels = Object.keys(group);
        const rates = labels.map(k => group[k].conversion_rate);
        renderChart(ctx, 'bar', labels, rates, 'Conversion Rate (%)');
      }
      function renderFunnelTable(tbodyId, group) {
        const tbody = document.getElementById(tbodyId);
        tbody.innerHTML = Object.entries(group).map(([k, v]) =>
          `<tr><td>${k}</td><td>${v.total}</td><td>${v.converted}</td><td>${v.conversion_rate}</td></tr>`
        ).join('');
      }
      renderFunnelChart('chart-funnel-source', data.source);
      renderFunnelTable('table-funnel-source', data.source);
      renderFunnelChart('chart-funnel-industry', data.industry);
      renderFunnelTable('table-funnel-industry', data.industry);
      renderFunnelChart('chart-funnel-country', data.country);
      renderFunnelTable('table-funnel-country', data.country);
    }

    // Load Leads Over Time chart
    async function loadDateChart() {
      try {
        const res = await fetch('/api/reports/by_date', {
          credentials: 'same-origin'
        });
        const data = await res.json();
        const ctx = document.getElementById('chart-date').getContext('2d');
        const labels = data.map(d => d.date);
        const counts = data.map(d => d.count);
        renderChart(ctx, 'line', labels, counts, 'Leads Over Time');
        console.log('Leads Over Time chart loaded:', data);
      } catch (error) {
        console.error('Error loading Leads Over Time chart:', error);
      }
    }
  </script>
  <style>
    @media print {
      body * { visibility: hidden; }
      #content, #content * { visibility: visible; }
      #content { position: absolute; left: 0; top: 0; width: 100vw; background: #fff; }
      .btn, .form-label, form, .badge, nav, .navbar, .mb-3, .mb-4, .g-2, .align-items-end { display: none !important; }
      .card, .card-body, .card-header { page-break-inside: avoid; }
      h2, h5, .fs-2, .fs-4, .fw-bold { color: #000 !important; }
    }
  </style>
{% endblock %} 