{% extends "base.html" %}

{% block title %}{{ current_user.first_name or current_user.username }}'s Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="fw-bold"><i class="fas fa-user-circle"></i> {{ current_user.first_name or current_user.username }}'s Dashboard</h2>
                <div>
                    {% if current_user.role.name == 'Caller' %}
                    <a href="{{ url_for('main.personal_converted_clients') }}" class="btn btn-outline-warning">
                        <i class="fas fa-trophy"></i> My Converted Clients
                    </a>
                    {% endif %}
                    <a href="{{ url_for('main.my_tasks') }}" class="btn btn-outline-primary">
                        <i class="fas fa-tasks"></i> My Tasks
                    </a>
                    <a href="{{ url_for('main.add_lead') }}" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Lead
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Personalized Greeting and Inspiration -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body text-center">
                    <h4 class="mb-2" style="color: #2c3e50 !important;">
                        <i class="fas fa-sun"></i> Hello {{ current_user.first_name or current_user.username }}!
                    </h4>
                    <p class="mb-0 inspiration-text" id="inspirationLine" style="color: #2c3e50 !important;">
                        <!-- Inspiration line will be populated by JavaScript -->
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Personal Metrics Cards -->
    <div class="row mb-4">
        <!-- Today's Metrics -->
        <div class="col-md-2">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-plus-circle fa-2x mb-2"></i>
                    <h6 class="card-title">Today's Leads</h6>
                    <h3>{{ personal_metrics.today_leads }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-phone fa-2x mb-2"></i>
                    <h6 class="card-title">Today's Follow-ups</h6>
                    <h3>{{ personal_metrics.today_followups }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-warning text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-trophy fa-2x mb-2"></i>
                    <h6 class="card-title">Today's Conversions</h6>
                    <h3>{{ personal_metrics.today_conversions }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-info text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-calendar-week fa-2x mb-2"></i>
                    <h6 class="card-title">Week's Leads</h6>
                    <h3>{{ personal_metrics.week_leads }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-secondary text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-phone fa-2x mb-2"></i>
                    <h6 class="card-title">Week's Follow-ups</h6>
                    <h3>{{ personal_metrics.week_followups }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-dark text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-trophy fa-2x mb-2"></i>
                    <h6 class="card-title">Week's Conversions</h6>
                    <h3>{{ personal_metrics.week_conversions }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Performance Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-list fa-2x mb-2"></i>
                    <h6 class="card-title">Total Leads</h6>
                    <h3>{{ personal_metrics.total_leads }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-warning text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-trophy fa-2x mb-2"></i>
                    <h6 class="card-title">Total Converted</h6>
                    <h3>{{ personal_metrics.total_converted }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-info text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-percentage fa-2x mb-2"></i>
                    <h6 class="card-title">Conversion Rate</h6>
                    <h3>{{ personal_metrics.conversion_rate }}%</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-calendar-day fa-2x mb-2"></i>
                    <h6 class="card-title">Recent Conversions</h6>
                    <h3>{{ personal_metrics.recent_conversions }}</h3>
                    <small>This Week</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-secondary text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                    <h6 class="card-title">Month's Conversions</h6>
                    <h3>{{ personal_metrics.month_conversions }}</h3>
                    <small>This Month</small>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-dark text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                    <h6 class="card-title">Month's Leads</h6>
                    <h3>{{ personal_metrics.month_leads }}</h3>
                    <small>This Month</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Call Analytics Cards (Centered) -->
    <div class="row mb-4 justify-content-center">
        <div class="col-md-2">
            <div class="card bg-warning text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-phone fa-2x mb-2"></i>
                    <h6 class="card-title">Today's Calls</h6>
                    <h3>{{ personal_metrics.today_calls }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-success text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-calendar-week fa-2x mb-2"></i>
                    <h6 class="card-title">Week's Calls</h6>
                    <h3>{{ personal_metrics.week_calls }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-primary text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                    <h6 class="card-title">Month's Calls</h6>
                    <h3>{{ personal_metrics.month_calls }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card bg-info text-white h-100">
                <div class="card-body text-center d-flex flex-column justify-content-center">
                    <i class="fas fa-phone-alt fa-2x mb-2"></i>
                    <h6 class="card-title">Total Calls</h6>
                    <h3>{{ personal_metrics.total_calls }}</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Tasks and Activities Row -->
    <div class="row mb-4">
        <!-- Pending Tasks -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-clock"></i> Pending Tasks ({{ personal_metrics.pending_tasks }})</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    {% if pending_tasks %}
                        <div class="list-group list-group-flush flex-grow-1">
                            {% for task in pending_tasks %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ task.title }}</h6>
                                    <small class="text-muted">{{ task.description[:50] }}{% if task.description|length > 50 %}...{% endif %}</small>
                                    <br>
                                    <span class="badge bg-{{ 'danger' if task.priority == 'urgent' else 'warning' if task.priority == 'high' else 'info' if task.priority == 'medium' else 'secondary' }}">
                                        {{ task.priority|title }}
                                    </span>
                                    {% if task.due_date %}
                                        <small class="text-muted ms-2">Due: {{ task.due_date.strftime('%Y-%m-%d') }}</small>
                                    {% endif %}
                                </div>
                                <a href="{{ url_for('main.my_tasks') }}" class="btn btn-sm btn-outline-primary">View</a>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="flex-grow-1 d-flex align-items-center justify-content-center">
                            <p class="text-muted text-center py-3">No pending tasks!</p>
                        </div>
                    {% endif %}
                    <div class="mt-3">
                        <a href="{{ url_for('main.my_tasks') }}" class="btn btn-warning btn-sm">View All Tasks</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Recent Activities</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    {% if recent_activities %}
                        <div class="list-group list-group-flush flex-grow-1">
                            {% for activity in recent_activities %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ activity.description }}</h6>
                                        <small class="text-muted">{{ activity.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                    </div>
                                    <span class="badge bg-secondary">{{ activity.activity_type|replace('_', ' ')|title }}</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="flex-grow-1 d-flex align-items-center justify-content-center">
                            <p class="text-muted text-center py-3">No recent activities!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- My Recent Leads -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-list"></i> My Recent Leads</h5>
                </div>
                <div class="card-body">
                    {% if user_leads %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Company</th>
                                        <th>Industry</th>
                                        <th>Country</th>
                                        <th>Status</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for lead in user_leads %}
                                    <tr>
                                        <td>
                                            <strong>{{ lead.company_name }}</strong>
                                            <br>
                                            <small class="text-muted">{{ lead.company_website }}</small>
                                        </td>
                                        <td>{{ lead.industry }}</td>
                                        <td>{{ lead.country }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if lead.status == 'Converted' else 'warning' if lead.status == 'Interested' else 'info' if lead.status == 'Contacted' else 'secondary' }}">
                                                {{ lead.status }}
                                            </span>
                                        </td>
                                        <td>{{ lead.created_at.strftime('%Y-%m-%d') }}</td>
                                        <td>
                                            <a href="{{ url_for('main.get_lead', lead_id=lead.id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted text-center py-3">No leads created yet!</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leads by Status Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> My Leads by Status</h5>
            </div>
            <div class="card-body">
                {% if personal_metrics.leads_by_status %}
                    <div class="row">
                        {% for status_data in personal_metrics.leads_by_status %}
                        <div class="col-md-3 mb-3">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h6 class="card-title">{{ status_data.status or 'Unknown' }}</h6>
                                    <h3 class="text-primary">{{ status_data.count }}</h3>
                                    <small class="text-muted">leads</small>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center py-3">No leads data available yet!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Charts Section -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> My Performance</h5>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Activity Breakdown</h5>
            </div>
            <div class="card-body">
                <canvas id="activityChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Inspirational Lines for 22 Working Days
const inspirationalLines = [
    "Every call is an opportunity to change someone's life.",
    "Success is not final, failure is not fatal: it is the courage to continue that counts.",
    "The only way to do great work is to love what you do.",
    "Your attitude determines your direction.",
    "Make today amazing so tomorrow can be extraordinary.",
    "Small progress is still progress.",
    "Believe you can and you're halfway there.",
    "The future belongs to those who believe in the beauty of their dreams.",
    "Don't count the days, make the days count.",
    "Success is walking from failure to failure with no loss of enthusiasm.",
    "The harder you work, the luckier you get.",
    "Your potential is greater than your past.",
    "Every expert was once a beginner.",
    "The only limit to your impact is your imagination and commitment.",
    "Today's efforts are tomorrow's achievements.",
    "Focus on progress, not perfection.",
    "You are capable of more than you know.",
    "The best way to predict the future is to create it.",
    "Your voice matters, your story matters.",
    "Every 'no' brings you closer to 'yes'.",
    "You have the power to create change.",
    "Dream big, work hard, stay focused."
];

// Function to get today's inspirational line (randomized per user)
function getTodaysInspiration() {
    const today = new Date();
    const dayOfMonth = today.getDate();
    const userId = '{{ current_user.id }}'; // Get user ID from template
    
    // Create a seed based on user ID and day of month for consistent randomization
    const seed = userId + '_' + dayOfMonth;
    const hash = seed.split('').reduce((a, b) => {
        a = ((a << 5) - a) + b.charCodeAt(0);
        return a & a;
    }, 0);
    
    // Use the hash to determine which inspirational line to show
    const lineIndex = Math.abs(hash) % inspirationalLines.length;
    
    return inspirationalLines[lineIndex];
}

// Function to adjust font size based on text length
function adjustFontSize(element, text) {
    const maxFontSize = 1.1; // Maximum font size in rem
    const minFontSize = 0.8; // Minimum font size in rem
    const containerWidth = element.offsetWidth;
    
    // Set initial font size
    element.style.fontSize = maxFontSize + 'rem';
    element.textContent = text;
    
    // Check if text fits, if not, reduce font size
    while (element.scrollWidth > containerWidth && parseFloat(element.style.fontSize) > minFontSize) {
        const currentSize = parseFloat(element.style.fontSize);
        element.style.fontSize = (currentSize - 0.05) + 'rem';
    }
}

// Set the inspirational line when page loads
document.addEventListener('DOMContentLoaded', function() {
    const inspirationElement = document.getElementById('inspirationLine');
    if (inspirationElement) {
        const todaysInspiration = getTodaysInspiration();
        adjustFontSize(inspirationElement, todaysInspiration);
    }
});

// Adjust font size on window resize
window.addEventListener('resize', function() {
    const inspirationElement = document.getElementById('inspirationLine');
    if (inspirationElement) {
        const todaysInspiration = getTodaysInspiration();
        adjustFontSize(inspirationElement, todaysInspiration);
    }
});

// Performance Chart
const performanceCtx = document.getElementById('performanceChart').getContext('2d');
const performanceChart = new Chart(performanceCtx, {
    type: 'line',
    data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
            label: 'Leads Created',
            data: [{{ personal_metrics.week_leads }}, 0, 0, 0, 0, 0, 0],
            borderColor: 'rgb(75, 192, 192)',
            tension: 0.1
        }, {
            label: 'Follow-ups',
            data: [{{ personal_metrics.week_conversions }}, 0, 0, 0, 0, 0, 0],
            borderColor: 'rgb(255, 99, 132)',
            tension: 0.1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'Weekly Performance'
            }
        }
    }
});

// Activity Chart
const activityCtx = document.getElementById('activityChart').getContext('2d');
const activityChart = new Chart(activityCtx, {
    type: 'doughnut',
    data: {
        labels: ['Leads Created', 'Follow-ups', 'Conversions', 'Tasks'],
        datasets: [{
            data: [{{ personal_metrics.week_leads }}, {{ personal_metrics.week_conversions }}, {{ personal_metrics.week_conversions }}, {{ personal_metrics.pending_tasks }}],
            backgroundColor: [
                'rgb(255, 99, 132)',
                'rgb(54, 162, 235)',
                'rgb(255, 205, 86)',
                'rgb(75, 192, 192)'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'Activity Breakdown'
            }
        }
    }
});
</script>
{% endblock %} 