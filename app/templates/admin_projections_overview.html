{% extends "base.html" %}

{% block title %}Projections Overview{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/projections.css') }}">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Top Bar - Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="mb-0">
                            <i class="fas fa-chart-line"></i> Projections Dashboard
                        </h2>
                        <div class="d-flex align-items-center gap-3">
                            <!-- Month Selector -->
                            <div class="d-flex align-items-center">
                                <label for="month-selector" class="form-label me-2">Month:</label>
                                <select id="month-selector" class="form-select" style="width: auto;">
                                    {% for i in range(12) %}
                                        {% set month_date = current_month.replace(month=((current_month.month - i - 1) % 12) + 1) %}
                                        <option value="{{ month_date.strftime('%Y-%m') }}" 
                                                {% if month_date == selected_month %}selected{% endif %}>
                                            {{ month_date.strftime('%B %Y') }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <!-- Entity Type Filter -->
                            <select id="entity-type-filter" class="form-select" style="width: auto;">
                                <option value="">All Types</option>
                                <option value="Client">Clients Only</option>
                                <option value="User">Users Only</option>
                            </select>
                            
                            <!-- Quick Action Buttons -->
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-success btn-sm" onclick="window.location.href='{{ url_for('main.create_projection') }}'">
                                    <i class="fas fa-plus"></i> Add User Projection
                                </button>
                                <button type="button" class="btn btn-primary btn-sm" onclick="window.location.href='{{ url_for('main.converted_clients_management') }}'">
                                    <i class="fas fa-plus"></i> Add Client Projection
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary KPI Cards -->
    <div class="row mb-4">
        {% for card in kpi_cards %}
        <div class="col-md-3 mb-3">
            <div class="card h-100 border-{{ card.color }}">
                <div class="card-body text-center">
                    <div class="mb-2">
                        <i class="fas fa-{{ card.icon }} fa-2x text-{{ card.color }}"></i>
                    </div>
                    <h3 class="card-title mb-1">{{ card.value }}</h3>
                    <h6 class="card-subtitle mb-2 text-muted">{{ card.title }}</h6>
                    <small class="text-muted">{{ card.subtitle }}</small>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Global Projections Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-globe"></i> Global Projections Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-primary">REVENUE</h6>
                                    <p class="mb-1"><strong>$ {{ "{:,}".format(global_projections.revenue.target) }}</strong></p>
                                    <p class="mb-1"><strong>$ {{ "{:,}".format(global_projections.revenue.actual) }}</strong></p>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-warning" style="width: {{ global_projections.revenue.completion if global_projections.revenue.completion <= 100 else 100 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.0f"|format(global_projections.revenue.completion) }}% Complete</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-success">WORK VOLUME</h6>
                                    <p class="mb-1"><strong>{{ "{:,}".format(global_projections.work_volume.target) }}</strong></p>
                                    <p class="mb-1"><strong>{{ "{:,}".format(global_projections.work_volume.actual) }}</strong></p>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-warning" style="width: {{ global_projections.work_volume.completion if global_projections.work_volume.completion <= 100 else 100 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.0f"|format(global_projections.work_volume.completion) }}% Complete</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-info">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-info">TASKS</h6>
                                    <p class="mb-1"><strong>{{ "{:,}".format(global_projections.tasks.target) }}</strong></p>
                                    <p class="mb-1"><strong>{{ "{:,}".format(global_projections.tasks.actual) }}</strong></p>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-warning" style="width: {{ global_projections.tasks.completion if global_projections.tasks.completion <= 100 else 100 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.0f"|format(global_projections.tasks.completion) }}% Complete</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-warning">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-warning">LEADS</h6>
                                    <p class="mb-1"><strong>{{ "{:,}".format(global_projections.leads.target) }}</strong></p>
                                    <p class="mb-1"><strong>{{ "{:,}".format(global_projections.leads.actual) }}</strong></p>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-warning" style="width: {{ global_projections.leads.completion if global_projections.leads.completion <= 100 else 100 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.0f"|format(global_projections.leads.completion) }}% Complete</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-secondary">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-secondary">CALLS</h6>
                                    <p class="mb-1"><strong>{{ "{:,}".format(global_projections.calls.target) }}</strong></p>
                                    <p class="mb-1"><strong>{{ "{:,}".format(global_projections.calls.actual) }}</strong></p>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-warning" style="width: {{ global_projections.calls.completion if global_projections.calls.completion <= 100 else 100 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.0f"|format(global_projections.calls.completion) }}% Complete</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-danger">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-danger">CONVERSIONS</h6>
                                    <p class="mb-1"><strong>{{ "{:,}".format(global_projections.conversions.target) }}</strong></p>
                                    <p class="mb-1"><strong>{{ "{:,}".format(global_projections.conversions.actual) }}</strong></p>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-warning" style="width: {{ global_projections.conversions.completion if global_projections.conversions.completion <= 100 else 100 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.0f"|format(global_projections.conversions.completion) }}% Complete</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-primary">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-primary">LEADS CREATED</h6>
                                    <p class="mb-1"><strong>{{ "{:,}".format(global_projections.leads_created.target) }}</strong></p>
                                    <p class="mb-1"><strong>{{ "{:,}".format(global_projections.leads_created.actual) }}</strong></p>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-warning" style="width: {{ global_projections.leads_created.completion if global_projections.leads_created.completion <= 100 else 100 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.0f"|format(global_projections.leads_created.completion) }}% Complete</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card border-success">
                                <div class="card-body text-center">
                                    <h6 class="card-title text-success">FOLLOWUPS ADDED</h6>
                                    <p class="mb-1"><strong>{{ "{:,}".format(global_projections.followups_added.target) }}</strong></p>
                                    <p class="mb-1"><strong>{{ "{:,}".format(global_projections.followups_added.actual) }}</strong></p>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-warning" style="width: {{ global_projections.followups_added.completion if global_projections.followups_added.completion <= 100 else 100 }}%"></div>
                                    </div>
                                    <small class="text-muted">{{ "%.0f"|format(global_projections.followups_added.completion) }}% Complete</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Health Index -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-heartbeat"></i> Performance Health Index
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success" id="avg-completion">0%</h4>
                                <small class="text-muted">Average Completion</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-warning" id="at-risk-count">0</h4>
                                <small class="text-muted">At Risk (< 50%)</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-success" id="on-track-count">0</h4>
                                <small class="text-muted">On Track (75%+)</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h4 class="text-info" id="exceeding-count">0</h4>
                                <small class="text-muted">Exceeding (100%+)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Risk Analysis & Alerts -->
    {% if risk_analysis and (risk_analysis.at_risk or risk_analysis.needs_attention) %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> Risk Alerts
                    </h5>
                </div>
                <div class="card-body">
                    {% if risk_analysis.at_risk %}
                    <div class="mb-3">
                        <h6 class="text-danger">
                            <i class="fas fa-times-circle"></i> Critical Risk (< 50% Completion)
                        </h6>
                        <div class="row">
                            {% for item in risk_analysis.at_risk %}
                            <div class="col-md-6 mb-2">
                                <div class="alert alert-danger mb-0">
                                    <strong>{{ item.entity_name }}</strong> ({{ item.entity_type }})
                                    <span class="badge bg-danger float-end">{{ "%.0f"|format(item.avg_completion) }}%</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if risk_analysis.needs_attention %}
                    <div>
                        <h6 class="text-warning">
                            <i class="fas fa-exclamation-circle"></i> Needs Attention (50-74% Completion)
                        </h6>
                        <div class="row">
                            {% for item in risk_analysis.needs_attention %}
                            <div class="col-md-6 mb-2">
                                <div class="alert alert-warning mb-0">
                                    <strong>{{ item.entity_name }}</strong> ({{ item.entity_type }})
                                    <span class="badge bg-warning float-end">{{ "%.0f"|format(item.avg_completion) }}%</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Top Performers -->
    {% if risk_analysis and (risk_analysis.exceeding or risk_analysis.on_track) %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-trophy"></i> Top Performers
                    </h5>
                </div>
                <div class="card-body">
                    {% if risk_analysis.exceeding %}
                    <div class="mb-3">
                        <h6 class="text-success">
                            <i class="fas fa-star"></i> Exceeding Targets (100%+ Completion)
                        </h6>
                        <div class="row">
                            {% for item in risk_analysis.exceeding %}
                            <div class="col-md-6 mb-2">
                                <div class="alert alert-success mb-0">
                                    <strong>{{ item.entity_name }}</strong> ({{ item.entity_type }})
                                    <span class="badge bg-success float-end">{{ "%.0f"|format(item.avg_completion) }}%</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if risk_analysis.on_track %}
                    <div>
                        <h6 class="text-info">
                            <i class="fas fa-check-circle"></i> On Track (75-99% Completion)
                        </h6>
                        <div class="row">
                            {% for item in risk_analysis.on_track %}
                            <div class="col-md-6 mb-2">
                                <div class="alert alert-info mb-0">
                                    <strong>{{ item.entity_name }}</strong> ({{ item.entity_type }})
                                    <span class="badge bg-info float-end">{{ "%.0f"|format(item.avg_completion) }}%</span>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Detailed Table View -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                                 <div class="card-header bg-dark text-white">
                     <div class="d-flex justify-content-between align-items-center">
                         <h5 class="mb-0">
                             <i class="fas fa-table"></i> Individual Entity Projections
                         </h5>
                         <div class="d-flex gap-2">
                             <div class="btn-group" role="group">
                                 <button type="button" class="btn btn-sm btn-outline-light" id="view-cards-btn">
                                     <i class="fas fa-th-large"></i> Cards
                                 </button>
                                 <button type="button" class="btn btn-sm btn-light active" id="view-table-btn">
                                     <i class="fas fa-table"></i> Table
                                 </button>
                             </div>
                             <input type="text" id="table-search" class="form-control form-control-sm" placeholder="Search entities..." style="width: 200px;">
                             <button class="btn btn-sm btn-outline-light" onclick="exportTable()">
                                 <i class="fas fa-download"></i> Export
                             </button>
                         </div>
                     </div>
                 </div>
                                 <div class="card-body">
                     <!-- Cards View -->
                     <div id="cards-view" style="display: none;">
                         <div class="row" id="cards-container">
                             {% set grouped_projections = {} %}
                             {% for row in projections_table %}
                                 {% set entity_key = row.entity_id ~ '_' ~ row.entity_type %}
                                 {% if entity_key not in grouped_projections %}
                                     {% set _ = grouped_projections.update({entity_key: {'entity_name': row.entity_name, 'entity_type': row.entity_type, 'entity_id': row.entity_id, 'projections': []}}) %}
                                 {% endif %}
                                 {% set _ = grouped_projections[entity_key]['projections'].append(row) %}
                             {% endfor %}
                             
                             {% for entity_key, entity_data in grouped_projections.items() %}
                             <div class="col-md-6 col-lg-4 mb-3" data-entity-type="{{ entity_data.entity_type }}">
                                 <div class="card h-100 border-{{ 'primary' if entity_data.entity_type == 'Lead' else 'success' if entity_data.entity_type == 'Client' else 'info' }}">
                                     <div class="card-header bg-{{ 'primary' if entity_data.entity_type == 'Lead' else 'success' if entity_data.entity_type == 'Client' else 'info' }} text-white">
                                         <div class="d-flex justify-content-between align-items-center">
                                             <h6 class="mb-0">
                                                 {% if entity_data.entity_type == 'Client' %}
                                                     <i class="fas fa-building me-1"></i>
                                                 {% elif entity_data.entity_type == 'User' %}
                                                     <i class="fas fa-user me-1"></i>
                                                 {% else %}
                                                     <i class="fas fa-chart-line me-1"></i>
                                                 {% endif %}
                                                 {{ entity_data.entity_name }}
                                             </h6>
                                             <span class="badge bg-light text-dark">{{ entity_data.entity_type }}</span>
                                         </div>
                                     </div>
                                     <div class="card-body">
                                         <div class="projection-list">
                                             {% for projection in entity_data.projections %}
                                             <div class="projection-item mb-3 p-2 border rounded">
                                                 <div class="d-flex justify-content-between align-items-center mb-2">
                                                     <h6 class="mb-0 text-muted">{{ projection.projection_type.replace('_', ' ').title() }}</h6>
                                                     <span class="badge bg-{{ 'success' if projection.completion_percentage >= 100 else 'warning' if projection.completion_percentage >= 75 else 'info' if projection.completion_percentage >= 50 else 'danger' }}">
                                                         {{ projection.status_icon }}
                                                     </span>
                                                 </div>
                                                 <div class="row mb-2">
                                                     <div class="col-6">
                                                         <small class="text-muted">Target</small>
                                                         <div class="fw-bold">
                                                             {% if projection.projection_type == 'revenue' %}${% endif %}
                                                             {{ "{:,}".format(projection.target_value) }}
                                                         </div>
                                                     </div>
                                                     <div class="col-6">
                                                         <small class="text-muted">Actual</small>
                                                         <div class="fw-bold">
                                                             {% if projection.projection_type == 'revenue' %}${% endif %}
                                                             {{ "{:,}".format(projection.actual_value) }}
                                                         </div>
                                                     </div>
                                                 </div>
                                                 <div class="mb-2">
                                                     <div class="d-flex justify-content-between mb-1">
                                                         <small class="text-muted">Progress</small>
                                                         <small class="text-muted">{{ "%.0f"|format(projection.completion_percentage) }}%</small>
                                                     </div>
                                                     <div class="progress" style="height: 6px;">
                                                         <div class="progress-bar bg-{{ 'success' if projection.completion_percentage >= 100 else 'warning' if projection.completion_percentage >= 75 else 'info' if projection.completion_percentage >= 50 else 'danger' }}" 
                                                              style="width: {{ projection.completion_percentage if projection.completion_percentage <= 100 else 100 }}%"></div>
                                                     </div>
                                                 </div>
                                             </div>
                                             {% endfor %}
                                         </div>
                                         <div class="mt-3 text-center">
                                             {% if entity_data.entity_type == 'Client' %}
                                                 <a href="{{ url_for('main.client_dashboard', client_id=entity_data.entity_id) }}" class="btn btn-sm btn-outline-primary">
                                                     <i class="fas fa-external-link-alt"></i> View Details
                                                 </a>
                                             {% elif entity_data.entity_type == 'User' %}
                                                 <a href="{{ url_for('main.admin_user_activity', user_id=entity_data.entity_id) }}" class="btn btn-sm btn-outline-info">
                                                     <i class="fas fa-external-link-alt"></i> View Details
                                                 </a>
                                             {% endif %}
                                         </div>
                                     </div>
                                 </div>
                             </div>
                             {% endfor %}
                         </div>
                     </div>
                     
                     <!-- Table View -->
                     <div id="table-view">
                         <div class="table-responsive">
                             <table class="table table-striped table-hover" id="projections-table">
                            <thead class="table-dark">
                                <tr>
                                    <th>Type</th>
                                    <th>Entity</th>
                                    <th>Projection Type</th>
                                    <th>Target</th>
                                    <th>Actual</th>
                                    <th>% Complete</th>
                                    <th>Status</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in projections_table %}
                                <tr data-entity-type="{{ row.entity_type }}" data-projection-type="{{ row.projection_type }}">
                                    <td>
                                        <span class="badge bg-{{ 'primary' if row.entity_type == 'Lead' else 'success' if row.entity_type == 'Client' else 'info' }}">
                                            {{ row.entity_type }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if row.entity_type == 'Client' %}
                                            <a href="{{ url_for('main.client_dashboard', client_id=row.entity_id) }}" class="text-decoration-none">
                                                <i class="fas fa-building text-success me-1"></i>{{ row.entity_name }}
                                            </a>
                                        {% elif row.entity_type == 'User' %}
                                            <a href="{{ url_for('main.admin_user_activity', user_id=row.entity_id) }}" class="text-decoration-none">
                                                <i class="fas fa-user text-info me-1"></i>{{ row.entity_name }}
                                            </a>
                                        {% else %}
                                            {{ row.entity_name }}
                                        {% endif %}
                                    </td>
                                    <td>{{ row.projection_type.replace('_', ' ').title() }}</td>
                                    <td>
                                        {% if row.projection_type == 'revenue' %}${% endif %}
                                        {{ "{:,}".format(row.target_value) }}
                                    </td>
                                    <td>
                                        {% if row.projection_type == 'revenue' %}${% endif %}
                                        {{ "{:,}".format(row.actual_value) }}
                                    </td>
                                    <td>
                                        <div class="progress" style="height: 20px;">
                                            <div class="progress-bar bg-{{ 'success' if row.completion_percentage >= 100 else 'warning' if row.completion_percentage >= 75 else 'info' if row.completion_percentage >= 50 else 'danger' }}" 
                                                 style="width: {{ row.completion_percentage if row.completion_percentage <= 100 else 100 }}%">
                                                {{ "%.0f"|format(row.completion_percentage) }}%
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if row.completion_percentage >= 100 else 'warning' if row.completion_percentage >= 75 else 'info' if row.completion_percentage >= 50 else 'danger' }}">
                                            {{ row.status_icon }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if row.notes %}
                                            <small class="text-muted">{{ row.notes }}</small>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                                         </tbody>
                         </table>
                     </div>
                     </div>
                 </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar"></i> Projection Types Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="projectionTypesChart" height="300"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie"></i> Completion Status Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="completionStatusChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const monthSelector = document.getElementById('month-selector');
    const entityTypeFilter = document.getElementById('entity-type-filter');
    const tableSearch = document.getElementById('table-search');
    const projectionsTable = document.getElementById('projections-table');
    const viewCardsBtn = document.getElementById('view-cards-btn');
    const viewTableBtn = document.getElementById('view-table-btn');
    const cardsView = document.getElementById('cards-view');
    const tableView = document.getElementById('table-view');

    // Month selector
    monthSelector.addEventListener('change', function() {
        const selectedMonth = this.value;
        window.location.href = `{{ url_for('main.admin_projections_overview') }}?month=${selectedMonth}`;
    });

    // Entity type filter
    entityTypeFilter.addEventListener('change', function() {
        filterTable();
    });

    // Table search
    tableSearch.addEventListener('input', function() {
        filterTable();
    });

    // View toggle functionality
    viewCardsBtn.addEventListener('click', function() {
        cardsView.style.display = 'block';
        tableView.style.display = 'none';
        viewCardsBtn.classList.add('active', 'btn-light');
        viewCardsBtn.classList.remove('btn-outline-light');
        viewTableBtn.classList.remove('active', 'btn-light');
        viewTableBtn.classList.add('btn-outline-light');
    });

    viewTableBtn.addEventListener('click', function() {
        cardsView.style.display = 'none';
        tableView.style.display = 'block';
        viewTableBtn.classList.add('active', 'btn-light');
        viewTableBtn.classList.remove('btn-outline-light');
        viewCardsBtn.classList.remove('active', 'btn-light');
        viewCardsBtn.classList.add('btn-outline-light');
    });

    function filterTable() {
        const entityType = entityTypeFilter.value.toLowerCase();
        const searchTerm = tableSearch.value.toLowerCase();
        const rows = projectionsTable.querySelectorAll('tbody tr');
        const cards = document.querySelectorAll('#cards-container .col-md-6');

        // Filter table rows
        rows.forEach(row => {
            const entityTypeMatch = !entityType || row.dataset.entityType.toLowerCase() === entityType;
            const searchMatch = !searchTerm || row.textContent.toLowerCase().includes(searchTerm);
            
            if (entityTypeMatch && searchMatch) {
                row.style.display = 'table-row';
            } else {
                row.style.display = 'none';
            }
        });

        // Filter cards
        cards.forEach(card => {
            const entityTypeMatch = !entityType || card.dataset.entityType.toLowerCase() === entityType;
            const searchMatch = !searchTerm || card.textContent.toLowerCase().includes(searchTerm);
            
            if (entityTypeMatch && searchMatch) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Export table function
    window.exportTable = function() {
        const table = document.getElementById('projections-table');
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        
        let csv = 'Type,Entity,Projection Type,Target,Actual,% Complete,Status,Notes\n';
        
        rows.forEach(row => {
            if (row.style.display !== 'none') {
                const cells = Array.from(row.querySelectorAll('td'));
                const rowData = cells.map(cell => {
                    let text = cell.textContent.trim();
                    // Remove progress bar text and keep only percentage
                    if (text.includes('%')) {
                        text = text.match(/\d+\.?\d*%/)[0];
                    }
                    return `"${text}"`;
                });
                csv += rowData.join(',') + '\n';
            }
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'projections_export.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    };

    // Calculate health index
    function calculateHealthIndex() {
        const rows = projectionsTable.querySelectorAll('tbody tr');
        let totalCompletion = 0;
        let atRiskCount = 0;
        let onTrackCount = 0;
        let exceedingCount = 0;
        let validProjections = 0;

        rows.forEach(row => {
            const progressBar = row.querySelector('.progress-bar');
            if (progressBar) {
                const completionText = progressBar.textContent;
                const completion = parseFloat(completionText.replace('%', ''));
                
                if (!isNaN(completion)) {
                    totalCompletion += completion;
                    validProjections++;
                    
                    if (completion < 50) atRiskCount++;
                    else if (completion >= 75) onTrackCount++;
                    if (completion >= 100) exceedingCount++;
                }
            }
        });

        const avgCompletion = validProjections > 0 ? (totalCompletion / validProjections).toFixed(1) : 0;
        
        document.getElementById('avg-completion').textContent = avgCompletion + '%';
        document.getElementById('at-risk-count').textContent = atRiskCount;
        document.getElementById('on-track-count').textContent = onTrackCount;
        document.getElementById('exceeding-count').textContent = exceedingCount;
    }

    // Initialize charts
    initializeCharts();
    calculateHealthIndex();
});

function initializeCharts() {
    // Projection Types Chart
    const projectionTypesCtx = document.getElementById('projectionTypesChart').getContext('2d');
    new Chart(projectionTypesCtx, {
        type: 'bar',
        data: {
            labels: ['Revenue', 'Work Volume', 'Tasks', 'Leads', 'Calls', 'Conversions', 'Leads Created', 'Followups Added'],
            datasets: [{
                label: 'Target Value',
                data: {{ chart_data.target_values | safe }},
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }, {
                label: 'Actual Value',
                data: {{ chart_data.actual_values | safe }},
                backgroundColor: 'rgba(255, 99, 132, 0.8)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Completion Status Chart
    const completionStatusCtx = document.getElementById('completionStatusChart').getContext('2d');
    new Chart(completionStatusCtx, {
        type: 'doughnut',
        data: {
            labels: ['Exceeding (100%+)', 'On Track (75-99%)', 'Progressing (50-74%)', 'At Risk (<50%)'],
            datasets: [{
                data: {{ chart_data.status_distribution | safe }},
                backgroundColor: [
                    'rgba(40, 167, 69, 0.8)',
                    'rgba(255, 193, 7, 0.8)',
                    'rgba(23, 162, 184, 0.8)',
                    'rgba(220, 53, 69, 0.8)'
                ],
                borderColor: [
                    'rgba(40, 167, 69, 1)',
                    'rgba(255, 193, 7, 1)',
                    'rgba(23, 162, 184, 1)',
                    'rgba(220, 53, 69, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}
</script>
{% endblock %} 