{% extends 'base.html' %}
{% block title %}üìÅ Media Gallery{% endblock %}

{% block content %}
<div class="media-gallery-container">
    <!-- Header -->
    <div class="media-gallery-header">
        <div class="media-gallery-header-left">
            <h1><i class="fas fa-images"></i> Media Gallery</h1>
            <span class="media-gallery-subtitle">Browse and manage shared media files</span>
        </div>
        <div class="media-gallery-header-right">
            <button class="btn btn-primary" id="upload-media-btn">
                <i class="fas fa-upload"></i> Upload Media
            </button>
            <button class="btn btn-outline-secondary" onclick="window.history.back()">
                <i class="fas fa-arrow-left"></i> Back
            </button>
        </div>
    </div>

    <!-- Media Type Tabs -->
    <div class="media-tabs">
        <button class="media-tab active" data-type="all">
            <i class="fas fa-th"></i> All Media
        </button>
        <button class="media-tab" data-type="image">
            <i class="fas fa-image"></i> Photos
        </button>
        <button class="media-tab" data-type="video">
            <i class="fas fa-video"></i> Videos
        </button>
        <button class="media-tab" data-type="audio">
            <i class="fas fa-music"></i> Audio
        </button>
        <button class="media-tab" data-type="document">
            <i class="fas fa-file-alt"></i> Files
        </button>
        <button class="media-tab" data-type="link">
            <i class="fas fa-link"></i> Links
        </button>
    </div>

    <!-- Media Grid -->
    <div class="media-grid-container">
        <div class="media-grid" id="media-grid">
            <!-- Media items will be loaded here -->
        </div>
        
        <!-- Loading indicator -->
        <div class="media-loading" id="media-loading" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="sr-only">Loading...</span>
            </div>
            <p>Loading media...</p>
        </div>
        
        <!-- No media message -->
        <div class="no-media" id="no-media" style="display: none;">
            <i class="fas fa-images"></i>
            <h3>No media found</h3>
            <p>No media files have been shared yet.</p>
            <button class="btn btn-primary" onclick="showUploadModal()">
                <i class="fas fa-upload"></i> Upload First Media
            </button>
        </div>
        
        <!-- Load more button -->
        <div class="load-more-container" id="load-more-container" style="display: none;">
            <button class="btn btn-outline-primary" id="load-more-btn">
                <i class="fas fa-plus"></i> Load More
            </button>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-upload"></i> Upload Media
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Drag & Drop Zone -->
                <div class="upload-zone" id="upload-zone">
                    <div class="upload-zone-content">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h4>Drag & Drop Files Here</h4>
                        <p>or click to browse files</p>
                        <input type="file" id="file-input" multiple accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt" style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                            <i class="fas fa-folder-open"></i> Choose Files
                        </button>
                    </div>
                </div>
                
                <!-- Upload Progress -->
                <div class="upload-progress" id="upload-progress" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar" id="upload-progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="upload-status">Preparing upload...</p>
                </div>
                
                <!-- Uploaded Files List -->
                <div class="uploaded-files" id="uploaded-files">
                    <!-- Uploaded files will be listed here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="upload-submit-btn" disabled>
                    <i class="fas fa-upload"></i> Upload Files
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Media Preview Modal -->
<div class="modal fade" id="mediaPreviewModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="media-preview-title">
                    <i class="fas fa-file"></i> Media Preview
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="media-preview-content" id="media-preview-content">
                    <!-- Media preview will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="download-media-btn">
                    <i class="fas fa-download"></i> Download
                </button>
                <button type="button" class="btn btn-danger" id="delete-media-btn">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Styles -->
<style>
.media-gallery-container {
    height: 100vh;
    display: flex;
    flex-direction: column;
    background: #f8f9fa;
}

.media-gallery-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 30px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.media-gallery-header-left h1 {
    margin: 0;
    font-size: 24px;
    font-weight: 600;
}

.media-gallery-subtitle {
    font-size: 14px;
    opacity: 0.9;
}

.media-tabs {
    background: white;
    border-bottom: 1px solid #e9ecef;
    padding: 0 30px;
    display: flex;
    gap: 10px;
    overflow-x: auto;
}

.media-tab {
    background: none;
    border: none;
    padding: 15px 20px;
    color: #6c757d;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.media-tab:hover {
    color: #495057;
    background: #f8f9fa;
}

.media-tab.active {
    color: #007bff;
    border-bottom-color: #007bff;
}

.media-grid-container {
    flex: 1;
    padding: 30px;
    overflow-y: auto;
}

.media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.media-item {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: all 0.3s ease;
    cursor: pointer;
}

.media-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.media-item-image {
    position: relative;
    height: 200px;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.media-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.media-item-image .media-icon {
    font-size: 48px;
    color: #6c757d;
}

.media-item-info {
    padding: 15px;
}

.media-item-title {
    font-weight: 600;
    margin-bottom: 5px;
    color: #495057;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.media-item-meta {
    font-size: 12px;
    color: #6c757d;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.media-item-type {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
}

.media-loading, .no-media {
    text-align: center;
    padding: 60px 20px;
    color: #6c757d;
}

.media-loading i, .no-media i {
    font-size: 48px;
    margin-bottom: 20px;
    opacity: 0.5;
}

.load-more-container {
    text-align: center;
    margin-top: 30px;
}

/* Upload Zone Styles */
.upload-zone {
    border: 2px dashed #dee2e6;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    transition: all 0.3s ease;
    background: #f8f9fa;
}

.upload-zone.dragover {
    border-color: #007bff;
    background: #e3f2fd;
}

.upload-zone-content i {
    font-size: 48px;
    color: #6c757d;
    margin-bottom: 20px;
}

.upload-progress {
    margin: 20px 0;
}

.uploaded-files {
    margin-top: 20px;
}

.uploaded-file {
    display: flex;
    align-items: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    margin-bottom: 10px;
}

.uploaded-file-icon {
    margin-right: 10px;
    color: #6c757d;
}

.uploaded-file-info {
    flex: 1;
}

.uploaded-file-name {
    font-weight: 600;
    margin-bottom: 2px;
}

.uploaded-file-size {
    font-size: 12px;
    color: #6c757d;
}

/* Media Preview Styles */
.media-preview-content {
    text-align: center;
}

.media-preview-content img {
    max-width: 100%;
    max-height: 500px;
    border-radius: 10px;
}

.media-preview-content video {
    max-width: 100%;
    max-height: 500px;
    border-radius: 10px;
}

.media-preview-content audio {
    width: 100%;
    margin: 20px 0;
}

.media-preview-info {
    margin-top: 20px;
    text-align: left;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
}

.media-preview-info h5 {
    margin-bottom: 10px;
    color: #495057;
}

.media-preview-info p {
    margin-bottom: 5px;
    color: #6c757d;
    font-size: 14px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .media-grid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .media-gallery-header {
        padding: 15px 20px;
    }
    
    .media-gallery-header-left h1 {
        font-size: 20px;
    }
    
    .media-tabs {
        padding: 0 20px;
    }
    
    .media-grid-container {
        padding: 20px;
    }
}
</style>

<!-- JavaScript -->
<script>
let currentMediaType = 'all';
let currentPage = 1;
let hasMorePages = false;
let selectedMediaId = null;

// Initialize media gallery
document.addEventListener('DOMContentLoaded', function() {
    loadMedia();
    setupEventListeners();
});

function setupEventListeners() {
    // Media type tabs
    document.querySelectorAll('.media-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.media-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            currentMediaType = this.dataset.type;
            currentPage = 1;
            loadMedia();
        });
    });
    
    // Upload button
    document.getElementById('upload-media-btn').addEventListener('click', showUploadModal);
    
    // Load more button
    document.getElementById('load-more-btn').addEventListener('click', loadMoreMedia);
    
    // File input
    document.getElementById('file-input').addEventListener('change', handleFileSelect);
    
    // Drag and drop
    setupDragAndDrop();
}

function loadMedia() {
    const grid = document.getElementById('media-grid');
    const loading = document.getElementById('media-loading');
    const noMedia = document.getElementById('no-media');
    
    if (currentPage === 1) {
        grid.innerHTML = '';
        loading.style.display = 'block';
        noMedia.style.display = 'none';
    }
    
    fetch(`/production/api/media/gallery?type=${currentMediaType}&page=${currentPage}`)
        .then(response => response.json())
        .then(data => {
            loading.style.display = 'none';
            
            if (data.media_items.length === 0 && currentPage === 1) {
                noMedia.style.display = 'block';
                document.getElementById('load-more-container').style.display = 'none';
                return;
            }
            
            noMedia.style.display = 'none';
            
            if (currentPage === 1) {
                grid.innerHTML = '';
            }
            
            data.media_items.forEach(media => {
                grid.appendChild(createMediaItem(media));
            });
            
            hasMorePages = currentPage < data.total_pages;
            document.getElementById('load-more-container').style.display = hasMorePages ? 'block' : 'none';
        })
        .catch(error => {
            console.error('Error loading media:', error);
            loading.style.display = 'none';
            noMedia.style.display = 'block';
        });
}

function createMediaItem(media) {
    const item = document.createElement('div');
    item.className = 'media-item';
    item.onclick = () => showMediaPreview(media);
    
    const isImage = media.media_type === 'image';
    const isVideo = media.media_type === 'video';
    
    item.innerHTML = `
        <div class="media-item-image">
            ${isImage ? `<img src="${media.file_path}" alt="${media.original_filename}">` : ''}
            ${isVideo ? `<video src="${media.file_path}" muted></video>` : ''}
            ${!isImage && !isVideo ? `<i class="${media.icon} media-icon"></i>` : ''}
        </div>
        <div class="media-item-info">
            <div class="media-item-title">${media.original_filename}</div>
            <div class="media-item-meta">
                <span>${media.file_size} MB</span>
                <span class="media-item-type" style="color: ${media.color}">
                    <i class="${media.icon}"></i>
                    ${media.media_type}
                </span>
            </div>
        </div>
    `;
    
    return item;
}

function loadMoreMedia() {
    currentPage++;
    loadMedia();
}

function showUploadModal() {
    $('#uploadModal').modal('show');
}

function setupDragAndDrop() {
    const uploadZone = document.getElementById('upload-zone');
    const fileInput = document.getElementById('file-input');
    
    uploadZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadZone.classList.add('dragover');
    });
    
    uploadZone.addEventListener('dragleave', () => {
        uploadZone.classList.remove('dragover');
    });
    
    uploadZone.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        handleFiles(files);
    });
    
    uploadZone.addEventListener('click', () => {
        fileInput.click();
    });
}

function handleFileSelect(event) {
    const files = event.target.files;
    handleFiles(files);
}

function handleFiles(files) {
    const uploadedFiles = document.getElementById('uploaded-files');
    uploadedFiles.innerHTML = '';
    
    Array.from(files).forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'uploaded-file';
        fileItem.innerHTML = `
            <i class="fas fa-file uploaded-file-icon"></i>
            <div class="uploaded-file-info">
                <div class="uploaded-file-name">${file.name}</div>
                <div class="uploaded-file-size">${(file.size / (1024 * 1024)).toFixed(2)} MB</div>
            </div>
        `;
        uploadedFiles.appendChild(fileItem);
    });
    
    document.getElementById('upload-submit-btn').disabled = files.length === 0;
}

function showMediaPreview(media) {
    selectedMediaId = media.id;
    const modal = $('#mediaPreviewModal');
    const content = document.getElementById('media-preview-content');
    const title = document.getElementById('media-preview-title');
    
    title.innerHTML = `<i class="${media.icon}"></i> ${media.original_filename}`;
    
    let previewHtml = '';
    
    if (media.media_type === 'image') {
        previewHtml = `<img src="${media.file_path}" alt="${media.original_filename}">`;
    } else if (media.media_type === 'video') {
        previewHtml = `<video src="${media.file_path}" controls></video>`;
    } else if (media.media_type === 'audio') {
        previewHtml = `<audio src="${media.file_path}" controls></audio>`;
    } else {
        previewHtml = `<i class="${media.icon}" style="font-size: 64px; color: ${media.color}; margin: 20px;"></i>`;
    }
    
    previewHtml += `
        <div class="media-preview-info">
            <h5>File Information</h5>
            <p><strong>Name:</strong> ${media.original_filename}</p>
            <p><strong>Size:</strong> ${media.file_size} MB</p>
            <p><strong>Type:</strong> ${media.media_type}</p>
            <p><strong>Uploaded by:</strong> ${media.uploaded_by}</p>
            <p><strong>Uploaded:</strong> ${new Date(media.uploaded_at).toLocaleString()}</p>
        </div>
    `;
    
    content.innerHTML = previewHtml;
    modal.modal('show');
}

// Download and delete functionality
document.getElementById('download-media-btn').addEventListener('click', () => {
    if (selectedMediaId) {
        window.open(`/production/api/media/download/${selectedMediaId}`, '_blank');
    }
});

document.getElementById('delete-media-btn').addEventListener('click', () => {
    if (selectedMediaId && confirm('Are you sure you want to delete this media file?')) {
        fetch(`/production/api/media/delete/${selectedMediaId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                $('#mediaPreviewModal').modal('hide');
                loadMedia(); // Reload the gallery
                showToast('Media file deleted successfully');
            } else {
                showToast('Error deleting media file', 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting media:', error);
            showToast('Error deleting media file', 'error');
        });
    }
});

function showToast(message, type = 'success') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
</script>
{% endblock %} 