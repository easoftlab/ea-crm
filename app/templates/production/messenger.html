{% extends "base.html" %}

{% block title %}Team Messenger{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/messenger.css') }}">
{% endblock %}

{% block content %}
<div class="messenger-container">
    <!-- Messenger Header -->
    <div class="messenger-header">
        <div class="messenger-header-left">
            <h2><i class="fas fa-comments"></i> Team Messenger</h2>
            <span class="online-users-count" id="online-users-count">0 online</span>
        </div>
        <div class="messenger-header-right">
            {% if current_user.role and current_user.role.name in ['productions_manager', 'marketing_manager', 'admin'] %}
            <button class="btn btn-outline-primary btn-sm" id="create-group-btn">
                <i class="fas fa-users"></i> Create Group
            </button>
            {% else %}
            <span class="text-muted small">
                <i class="fas fa-info-circle"></i> Only managers can create groups
            </span>
            {% endif %}
            <button class="btn btn-outline-secondary btn-sm" id="media-gallery-btn">
                <i class="fas fa-images"></i> Media Gallery
            </button>
        </div>
    </div>

    <div class="messenger-content">
        <!-- Users Sidebar -->
        <div class="messenger-sidebar">
            <div class="sidebar-section">
                <h5><i class="fas fa-users"></i> Online Users</h5>
                <div class="users-list" id="users-list">
                    <!-- Users will be loaded here -->
                </div>
            </div>
            
            <div class="sidebar-section">
                <h5><i class="fas fa-comments"></i> Recent Conversations</h5>
                <div class="conversations-list" id="conversations-list">
                    <!-- Conversations will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="messenger-chat">
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="chat-header-left">
                    <h4 id="current-chat-title">General Chat</h4>
                    <span class="chat-status" id="chat-status">Active</span>
                </div>
                <div class="chat-header-right">
                    <button class="btn btn-outline-primary btn-sm" id="search-messages-btn">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="pin-messages-btn">
                        <i class="fas fa-thumbtack"></i>
                    </button>
                    <button class="btn btn-outline-info btn-sm" id="chat-settings-btn">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>

            <!-- Messages Area -->
            <div class="messages-container" id="messages-container">
                <div class="messages-list" id="messages-list">
                    <!-- Messages will be loaded here -->
                </div>
                
                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typing-indicator" style="display: none;">
                    <span class="typing-text">Someone is typing...</span>
                </div>
            </div>

            <!-- Message Input -->
            <div class="message-input-container">
                <!-- Edit Message Preview (Telegram-like) -->
                <div class="edit-message-preview" id="edit-message-preview" style="display: none;">
                    <div class="edit-preview-content">
                        <div class="edit-preview-header">
                            <i class="fas fa-edit text-primary"></i>
                            <span class="edit-preview-text">Edit message</span>
                            <button class="btn btn-sm btn-outline-secondary edit-cancel-btn" onclick="cancelEditMode()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="edit-preview-message" id="edit-preview-message">
                            <!-- Original message content will be shown here -->
                        </div>
                    </div>
                </div>
                
                <div class="message-input-wrapper">
                    <div class="message-input-actions">
                        <button class="btn btn-sm btn-outline-secondary" id="attach-file-btn">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="emoji-btn">
                            <i class="fas fa-smile"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="mention-btn">
                            <i class="fas fa-at"></i>
                        </button>
                    </div>
                    <div class="message-input-main">
                        <textarea 
                            id="message-input" 
                            class="form-control" 
                            placeholder="Type your message..."
                            rows="3"
                        ></textarea>
                    </div>
                    <div class="message-input-send">
                        <button class="btn btn-primary" id="send-message-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Mention Dropdown -->
                <div class="mention-dropdown" id="mention-dropdown" style="display: none; position: absolute; bottom: 100%; left: 0; right: 0; z-index: 9999;">
                    <div class="mention-dropdown-header">
                        <i class="fas fa-at text-primary"></i>
                        <span>Mention someone</span>
                    </div>
                    <div class="mention-dropdown-list" id="mention-dropdown-list">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
                
                <!-- File Upload Progress -->
                <div class="upload-progress" id="upload-progress" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar" id="upload-progress-bar" role="progressbar"></div>
                    </div>
                    <span class="upload-text" id="upload-text">Uploading...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div class="context-menu" id="message-context-menu" style="display: none;">
    <div class="context-menu-item" onclick="replyToMessageFromContext()">
        <i class="fas fa-reply"></i>
        <span>Reply</span>
    </div>
    <div class="context-menu-item" onclick="editMessageFromContext()">
        <i class="fas fa-edit"></i>
        <span>Edit</span>
    </div>
    <div class="context-menu-item" onclick="pinMessageFromContext()">
        <i class="fas fa-thumbtack"></i>
        <span>Pin</span>
    </div>
    <div class="context-menu-item" onclick="copyMessageText()">
        <i class="fas fa-copy"></i>
        <span>Copy Text</span>
    </div>
    <div class="context-menu-item delete-option" onclick="deleteMessageFromContext()">
        <i class="fas fa-trash"></i>
        <span>Delete</span>
    </div>
</div>

<!-- Modals -->
<!-- Create Group Modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-group-form">
                    <div class="mb-3">
                        <label for="group-name" class="form-label">Group Name</label>
                        <input type="text" class="form-control" id="group-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="group-description" class="form-label">Description</label>
                        <textarea class="form-control" id="group-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Add Members</label>
                        <div class="members-selection" id="members-selection">
                            <!-- Members will be loaded here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="create-group-submit">Create Group</button>
            </div>
        </div>
    </div>
</div>

<!-- Search Messages Modal -->
<div class="modal fade" id="searchMessagesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Search Messages</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="search-messages-input" placeholder="Search messages...">
                </div>
                <div class="search-results" id="search-results">
                    <!-- Search results will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Upload Modal -->
<div class="modal fade" id="fileUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="upload-area" id="upload-area">
                    <div class="upload-prompt">
                        <i class="fas fa-cloud-upload-alt fa-3x text-muted"></i>
                        <p>Drag and drop files here or click to browse</p>
                        <input type="file" id="file-input" multiple style="display: none;">
                        <button class="btn btn-outline-primary" onclick="document.getElementById('file-input').click()">
                            Choose Files
                        </button>
                    </div>
                </div>
                <div class="uploaded-files" id="uploaded-files">
                    <!-- Uploaded files will be shown here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="upload-files-submit">Upload Files</button>
            </div>
        </div>
    </div>
</div>

<!-- Emoji Picker Modal -->
<div class="modal fade" id="emojiPickerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Select Emoji</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="emoji-categories">
                    <button class="btn btn-sm btn-outline-secondary emoji-category active" data-category="smileys">😊 Smileys</button>
                    <button class="btn btn-sm btn-outline-secondary emoji-category" data-category="animals">🐶 Animals</button>
                    <button class="btn btn-sm btn-outline-secondary emoji-category" data-category="food">🍕 Food</button>
                    <button class="btn btn-sm btn-outline-secondary emoji-category" data-category="activities">⚽ Activities</button>
                    <button class="btn btn-sm btn-outline-secondary emoji-category" data-category="objects">💡 Objects</button>
                    <button class="btn btn-sm btn-outline-secondary emoji-category" data-category="symbols">❤️ Symbols</button>
                </div>
                <div class="emoji-grid" id="emoji-grid">
                    <!-- Emojis will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pinned Messages Modal -->
<div class="modal fade" id="pinnedMessagesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-thumbtack text-warning"></i> Pinned Messages
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="pinned-messages-list">
                    <!-- Pinned messages will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- File Upload Modal -->
<div class="modal fade" id="fileUploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-upload"></i> Upload Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="upload-area" class="upload-area">
                    <i class="fas fa-cloud-upload-alt fa-3x"></i>
                    <p class="upload-prompt">Drag & drop files here or click to browse</p>
                    <input type="file" id="file-input" multiple style="display: none;">
                    <button class="btn btn-secondary" onclick="document.getElementById('file-input').click()">Browse Files</button>
                </div>
                <div id="upload-progress" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Search Messages Modal -->
<div class="modal fade" id="searchMessagesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-search"></i> Search Messages</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" id="search-messages-input" class="form-control mb-3" placeholder="Search messages...">
                <div id="search-results">
                    <!-- Search results will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Pinned Messages Modal -->
<div class="modal fade" id="pinnedMessagesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-thumbtack text-warning"></i> Pinned Messages
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="pinned-messages-list">
                    <!-- Pinned messages will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Create Group Modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-users"></i> Create New Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="group-name" class="form-label">Group Name</label>
                    <input type="text" class="form-control" id="group-name" required>
                </div>
                <div class="mb-3">
                    <label for="group-description" class="form-label">Description</label>
                    <textarea class="form-control" id="group-description" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Select Members</label>
                    <div id="group-members-list">
                        <!-- Available users will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createGroup()">Create Group</button>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
// Global variables
let currentUser = null;
let onlineUsers = [];
let messageReactions = {};
let typingTimeout = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('Messenger page loaded');
    
    // Initialize messenger functionality
    initializeMessenger();
    
    // Set up event listeners
    setupEventListeners();
    
    // Load initial data
    loadInitialData();
    
    // Start periodic updates
    startPeriodicUpdates();
});

function initializeMessenger() {
    console.log('Initializing messenger...');
    
    // Get current user
    currentUser = getCurrentUser();
    
    // Initialize SocketIO connection
    if (typeof io !== 'undefined') {
        window.messengerSocket = io();
        
        window.messengerSocket.on('connect', () => {
            console.log('Connected to messenger SocketIO');
            updateUserStatus(true);
        });
        
        window.messengerSocket.on('disconnect', () => {
            console.log('Disconnected from messenger SocketIO');
            updateUserStatus(false);
        });
        
        window.messengerSocket.on('new_message', (message) => {
            addMessageToUI(message);
        });
        
        window.messengerSocket.on('user_typing_start', (data) => {
            showTypingIndicator(data.user);
        });
        
        window.messengerSocket.on('user_typing_stop', (data) => {
            hideTypingIndicator(data.user);
        });
        
        window.messengerSocket.on('user_online_status', (data) => {
            updateOnlineUsersList();
        });
    }
}

function setupEventListeners() {
    // Send message button
    const sendBtn = document.getElementById('send-message-btn');
    const messageInput = document.getElementById('message-input');
    
    if (sendBtn && messageInput) {
        sendBtn.addEventListener('click', function() {
            if (currentEditMessageId) {
                saveEditedMessage();
            } else {
                sendMessage();
            }
        });
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (currentEditMessageId) {
                    saveEditedMessage();
                } else {
                sendMessage();
                }
            }
        });
        
        // Typing indicator
        messageInput.addEventListener('input', function() {
            handleTyping();
        });
        
            // Mention functionality
    messageInput.addEventListener('keydown', function(e) {
        handleMessageInputKeydown(e);
        handleMentionKeydown(e);
    });
    
    // Hide mention dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const mentionDropdown = document.getElementById('mention-dropdown');
        const mentionBtn = document.getElementById('mention-btn');
        
        if (mentionDropdown && mentionDropdownVisible) {
            if (!mentionDropdown.contains(e.target) && !mentionBtn.contains(e.target)) {
                hideMentionPicker();
            }
        }
        });
    }
    
    // File upload
    const attachBtn = document.getElementById('attach-file-btn');
    if (attachBtn) {
        attachBtn.addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('fileUploadModal'));
            modal.show();
        });
    }
    
    // Emoji picker
    const emojiBtn = document.getElementById('emoji-btn');
    if (emojiBtn) {
        emojiBtn.addEventListener('click', showEmojiPicker);
    }
    
    // Mention button
    const mentionBtn = document.getElementById('mention-btn');
    if (mentionBtn) {
        mentionBtn.addEventListener('click', () => {
            showMentionPicker();
        });
    }
    
    // Create group
    const createGroupBtn = document.getElementById('create-group-btn');
    if (createGroupBtn) {
        createGroupBtn.addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('createGroupModal'));
            modal.show();
        });
    }
    
    // Search messages
    const searchBtn = document.getElementById('search-messages-btn');
    if (searchBtn) {
        searchBtn.addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('searchMessagesModal'));
            modal.show();
        });
    }
    
    // Pin messages
    const pinBtn = document.getElementById('pin-messages-btn');
    if (pinBtn) {
        pinBtn.addEventListener('click', () => {
            showPinnedMessages();
        });
    }
    
    // Chat settings
    const settingsBtn = document.getElementById('chat-settings-btn');
    if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
            showChatSettings();
        });
    }
    
    // Media gallery
    const mediaBtn = document.getElementById('media-gallery-btn');
    if (mediaBtn) {
        mediaBtn.addEventListener('click', () => {
            showMediaGallery();
        });
    }
    
    // File upload modal events
    setupFileUploadEvents();
    
    // Search modal events
    setupSearchEvents();
    
    // Emoji picker setup
    setupEmojiPicker();
}

function loadInitialData() {
    console.log('Loading initial data...');
    
    // Load messages
    loadMessages();
    
    // Load users
    loadUsers();
    
    // Load pinned messages
    loadPinnedMessages();
    
    // Load recent conversations
    displayRecentConversations();
}

function loadMessages() {
    console.log('Loading messages...');
    fetch('/production/api/messenger/messages')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Messages loaded:', data);
            if (data.success && data.messages) {
                displayMessages(data.messages);
                console.log(`Displayed ${data.messages.length} messages`);
            } else {
                console.error('No messages data received:', data);
            }
        })
        .catch(error => {
            console.error('Error loading messages:', error);
            // Retry after 2 seconds
            setTimeout(loadMessages, 2000);
        });
}

function loadUsers() {
    fetch('/production/api/messenger/users/online')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                onlineUsers = data.users;
                displayUsers(data.users);
                updateOnlineCount(data.count);
            }
        })
        .catch(error => {
            console.error('Error loading users:', error);
        });
}

function loadPinnedMessages() {
    fetch('/production/api/messenger/pinned-messages')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPinnedMessages(data.messages);
            }
        })
        .catch(error => {
            console.error('Error loading pinned messages:', error);
        });
}

function displayMessages(messages) {
    const messagesList = document.getElementById('messages-list');
    if (!messagesList) {
        console.error('Messages list element not found');
        return;
    }
    
    console.log(`Displaying ${messages.length} messages`);
    
    // Clear existing messages
    messagesList.innerHTML = '';
    
    if (messages.length === 0) {
        console.log('No messages to display');
        messagesList.innerHTML = '<div class="text-center text-muted mt-4">No messages yet. Start the conversation!</div>';
        return;
    }
    
    // Add each message to UI
    messages.forEach(message => {
        addMessageToUI(message);
    });
    
    // Scroll to bottom after a short delay to ensure rendering
    setTimeout(scrollToBottom, 100);
}

function addMessageToUI(message) {
    const messagesList = document.getElementById('messages-list');
    if (!messagesList) return;
    
    const messageElement = createMessageElement(message);
    messagesList.appendChild(messageElement);
    
    scrollToBottom();
}

function createMessageElement(message) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message-item ${message.is_own ? 'own-message' : ''}`;
    messageDiv.setAttribute('data-message-id', message.id);
    
    // Create message HTML
    let messageHtml = `
        <div class="message-avatar">
            ${message.sender_name ? message.sender_name.charAt(0).toUpperCase() : 'U'}
        </div>
        <div class="message-content">
            <div class="message-header">
                <span class="message-sender">${message.sender_name || 'Unknown'}</span>
                <span class="message-time">
                    ${formatRelativeTime(message.created_at)}
                    ${message.is_edited ? `<span class="edited-indicator"> (edited ${formatRelativeTime(message.updated_at)})</span>` : ''}
                </span>
                ${message.is_pinned ? '<i class="fas fa-thumbtack text-warning"></i>' : ''}
            </div>
            <div class="message-text" oncontextmenu="showMessageContextMenu(event, ${message.id})">
                ${highlightMentions(escapeHtml(message.content))}
            </div>
        </div>
    `;
    
    // Add attachments if any
    if (message.attachments && message.attachments.length > 0) {
        messageHtml += '<div class="message-attachments">';
        message.attachments.forEach(attachment => {
            messageHtml += createAttachmentElement(attachment);
        });
        messageHtml += '</div>';
    }
    
    messageDiv.innerHTML = messageHtml;
    return messageDiv;
}

function createAttachmentElement(attachment) {
    const fileIcon = getFileIcon(attachment.file_type);
    const fileSize = formatFileSize(attachment.file_size);
    
    return `
        <div class="attachment-item">
            <i class="${fileIcon}"></i>
            <div class="attachment-info">
                <span class="attachment-name">${attachment.file_name}</span>
                <span class="attachment-size">${fileSize}</span>
            </div>
            <button class="btn btn-sm btn-outline-primary" onclick="downloadAttachment('${attachment.file_path}')">
                <i class="fas fa-download"></i>
            </button>
        </div>
    `;
}

function createReactionElement(reaction, messageId) {
    const hasReacted = reaction.user_ids.includes(currentUser.id);
    const buttonClass = hasReacted ? 'btn-primary' : 'btn-outline-secondary';
    
    return `
        <button class="btn btn-sm ${buttonClass} reaction-btn" 
                onclick="reactToMessage(${messageId}, '${reaction.type}')">
            ${reaction.type} ${reaction.count}
        </button>
    `;
}

function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const content = messageInput.value.trim();
    
    if (!content) return;
    
    fetch('/production/api/messenger/messages/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            content: content,
            room: 'general'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            addMessageToUI(data.message);
        } else {
            console.error('Error sending message:', data.error);
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
    });
}

function reactToMessage(messageId, reactionType) {
    // Hide the reaction popup immediately when a reaction is clicked
    const reactionOptions = document.getElementById(`reaction-options-${messageId}`);
    if (reactionOptions) {
        reactionOptions.style.display = 'none';
        // Clear any pending hover timeout
        if (hoverTimeout) {
            clearTimeout(hoverTimeout);
            hoverTimeout = null;
        }
    }
    
    fetch(`/production/api/messenger/messages/${messageId}/react`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            reaction_type: reactionType,
            action: 'add'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateMessageReactions(messageId, data.reactions);
        }
    })
    .catch(error => {
        console.error('Error reacting to message:', error);
    });
}

function pinMessage(messageId) {
    fetch(`/production/api/messenger/messages/${messageId}/pin`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            action: 'pin'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the pin icon immediately without refresh
            updateMessagePinStatus(messageId, true);
            showToast('Message pinned successfully!', 'success');
        } else {
            showToast('Failed to pin message', 'error');
        }
    })
    .catch(error => {
        console.error('Error pinning message:', error);
        showToast('Error pinning message', 'error');
    });
}

function updateMessagePinStatus(messageId, isPinned) {
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    if (!messageElement) return;
    
    const messageHeader = messageElement.querySelector('.message-header');
    if (!messageHeader) return;
    
    // Remove existing pin icon
    const existingPinIcon = messageHeader.querySelector('.fa-thumbtack');
    if (existingPinIcon) {
        existingPinIcon.remove();
    }
    
    // Add pin icon if message is pinned
    if (isPinned) {
        const pinIcon = document.createElement('i');
        pinIcon.className = 'fas fa-thumbtack text-warning';
        pinIcon.style.marginLeft = '8px';
        messageHeader.appendChild(pinIcon);
    }
    
    console.log(`Updated pin status for message ${messageId}: ${isPinned}`);
}

function deleteMessage(messageId) {
    if (!confirm('Are you sure you want to delete this message?')) return;
    
    fetch(`/production/api/messenger/messages/${messageId}/delete`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCSRFToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageElement) {
                messageElement.remove();
            }
            showToast('Message deleted successfully!', 'success');
        }
    })
    .catch(error => {
        console.error('Error deleting message:', error);
    });
}

function displayUsers(users) {
    const usersList = document.getElementById('users-list');
    if (!usersList) {
        console.error('Users list element not found');
        return;
    }
    
    console.log('Displaying users:', users);
    
    usersList.innerHTML = '';
    
    if (!users || users.length === 0) {
        usersList.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="fas fa-users fa-2x mb-2"></i>
                <p>No users online</p>
            </div>
        `;
        return;
    }
    
    users.forEach(user => {
        const userElement = document.createElement('div');
        userElement.className = `user-item ${user.is_online ? 'online' : ''}`;
        userElement.innerHTML = `
            <div class="user-avatar">
                ${user.name ? user.name.charAt(0).toUpperCase() : 'U'}
            </div>
            <div class="user-info">
                <span class="user-name">${user.name || user.username}</span>
                <span class="user-status">${user.is_online ? 'Online' : 'Offline'}</span>
            </div>
        `;
        usersList.appendChild(userElement);
    });
    
    console.log(`Displayed ${users.length} users`);
}

function displayRecentConversations() {
    const conversationsList = document.getElementById('conversations-list');
    if (!conversationsList) {
        console.error('Conversations list element not found');
        return;
    }
    
    console.log('Displaying recent conversations...');
    
    // For now, show a placeholder. In a real app, this would load from the backend
    conversationsList.innerHTML = `
        <div class="conversation-item active" onclick="switchConversation('general')">
            <div class="conversation-avatar">G</div>
            <div class="conversation-info">
                <span class="conversation-name">General Chat</span>
                <span class="conversation-last-message">Welcome to the team messenger!</span>
            </div>
        </div>
        <div class="conversation-item" onclick="switchConversation('support')">
            <div class="conversation-avatar">S</div>
            <div class="conversation-info">
                <span class="conversation-name">Support Team</span>
                <span class="conversation-last-message">How can we help you today?</span>
            </div>
        </div>
        <div class="conversation-item" onclick="switchConversation('development')">
            <div class="conversation-avatar">D</div>
            <div class="conversation-info">
                <span class="conversation-name">Development</span>
                <span class="conversation-last-message">New features are ready for testing</span>
            </div>
        </div>
    `;
    
    console.log('Recent conversations displayed');
}

function switchConversation(conversationId) {
    // Remove active class from all conversations
    const conversationItems = document.querySelectorAll('.conversation-item');
    conversationItems.forEach(item => item.classList.remove('active'));
    
    // Add active class to clicked conversation
    const clickedItem = event.currentTarget;
    clickedItem.classList.add('active');
    
    // Update chat title
    const conversationName = clickedItem.querySelector('.conversation-name').textContent;
    const chatTitle = document.getElementById('current-chat-title');
    if (chatTitle) {
        chatTitle.textContent = conversationName;
    }
    
    console.log(`Switched to conversation: ${conversationName}`);
}

function updateOnlineCount(count) {
    const countElement = document.getElementById('online-users-count');
    if (countElement) {
        countElement.textContent = `${count} online`;
    }
}

function updateUserStatus(isOnline) {
    fetch('/production/api/messenger/status', {
        method: 'GET'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('User status updated');
        }
    })
    .catch(error => {
        console.error('Error updating user status:', error);
    });
}

function handleTyping() {
    if (typingTimeout) {
        clearTimeout(typingTimeout);
    }
    
    // Emit typing start
    if (window.messengerSocket) {
        window.messengerSocket.emit('typing_start', {
            user: currentUser.name,
            room: 'general'
        });
    }
    
    // Set timeout to stop typing indicator
    typingTimeout = setTimeout(() => {
        if (window.messengerSocket) {
            window.messengerSocket.emit('typing_stop', {
                user: currentUser.name,
                room: 'general'
            });
        }
    }, 2000);
}

function showTypingIndicator(username) {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.querySelector('.typing-text').textContent = `${username} is typing...`;
        typingIndicator.style.display = 'block';
    }
}

function hideTypingIndicator(username) {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.style.display = 'none';
    }
}

function scrollToBottom() {
    const messagesList = document.getElementById('messages-list');
    if (messagesList) {
        messagesList.scrollTop = messagesList.scrollHeight;
    }
}

function formatRelativeTime(timestamp) {
    if (!timestamp) return 'Just now';
    
    const date = new Date(timestamp);
    const now = new Date();
    
    // Check if date is valid
    if (isNaN(date.getTime())) {
        return 'Just now';
    }
    
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMs < 0) return 'Just now'; // Future date
    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function getFileIcon(fileType) {
    const icons = {
        'pdf': 'fas fa-file-pdf',
        'doc': 'fas fa-file-word',
        'docx': 'fas fa-file-word',
        'xls': 'fas fa-file-excel',
        'xlsx': 'fas fa-file-excel',
        'ppt': 'fas fa-file-powerpoint',
        'pptx': 'fas fa-file-powerpoint',
        'jpg': 'fas fa-file-image',
        'jpeg': 'fas fa-file-image',
        'png': 'fas fa-file-image',
        'gif': 'fas fa-file-image',
        'mp4': 'fas fa-file-video',
        'mp3': 'fas fa-file-audio',
        'zip': 'fas fa-file-archive',
        'rar': 'fas fa-file-archive'
    };
    return icons[fileType] || 'fas fa-file';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCurrentUser() {
    return {
        id: {{ current_user.id if current_user.is_authenticated else 'null' }},
        name: '{{ current_user.get_full_name() if current_user.is_authenticated else "" }}'
    };
}

function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

function showToast(message, type = 'info') {
    // Simple toast notification
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

function startPeriodicUpdates() {
    // Update online users every 30 seconds
    setInterval(() => {
        loadUsers();
    }, 30000);
}

// File upload functions
function setupFileUploadEvents() {
    const fileInput = document.getElementById('file-input');
    const uploadArea = document.getElementById('upload-area');
    
    if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
    }
    
    if (uploadArea) {
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
    }
}

function handleFileSelect(event) {
    const files = event.target.files;
    handleFiles(files);
}

function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add('dragover');
}

function handleDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('dragover');
    const files = event.dataTransfer.files;
    handleFiles(files);
}

function handleFiles(files) {
    Array.from(files).forEach(file => {
        uploadFile(file);
    });
}

function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/production/api/messenger/files/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('File uploaded successfully!', 'success');
            // Add file to message input or send as message
            addFileToMessage(data.attachment);
        } else {
            showToast('Error uploading file: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error uploading file:', error);
        showToast('Error uploading file', 'error');
    });
}

function addFileToMessage(attachment) {
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.value += `\n[File: ${attachment.file_name}]`;
    }
}

// Search functions
function setupSearchEvents() {
    const searchInput = document.getElementById('search-messages-input');
    if (searchInput) {
        searchInput.addEventListener('input', debounce(performSearch, 500));
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function performSearch() {
    const searchInput = document.getElementById('search-messages-input');
    const query = searchInput.value.trim();
    
    if (query.length < 2) return;
    
    fetch(`/production/api/messenger/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySearchResults(data.results);
            }
        })
        .catch(error => {
            console.error('Error searching messages:', error);
        });
}

function displaySearchResults(results) {
    const resultsContainer = document.getElementById('search-results');
    if (!resultsContainer) return;
    
    resultsContainer.innerHTML = '';
    
    results.forEach(result => {
        const resultElement = document.createElement('div');
        resultElement.className = 'search-result-item';
        resultElement.innerHTML = `
            <div class="search-result-content">
                <div class="search-result-sender">${result.sender_name}</div>
                <div class="search-result-text">${result.highlighted_content}</div>
                <div class="search-result-time">${formatRelativeTime(result.created_at)}</div>
            </div>
        `;
        resultsContainer.appendChild(resultElement);
    });
}

function showPinnedMessages() {
    loadPinnedMessages();
    const modal = new bootstrap.Modal(document.getElementById('pinnedMessagesModal'));
    modal.show();
}

function displayPinnedMessages(messages) {
    const container = document.getElementById('pinned-messages-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    messages.forEach(message => {
        const messageElement = document.createElement('div');
        messageElement.className = 'pinned-message-item';
        messageElement.innerHTML = `
            <div class="pinned-message-content">
                <div class="pinned-message-sender">${message.sender_name}</div>
                <div class="pinned-message-text">${message.content}</div>
                <div class="pinned-message-time">Pinned ${formatRelativeTime(message.pinned_at)}</div>
            </div>
        `;
        container.appendChild(messageElement);
    });
}

function showMediaGallery() {
    const modalElement = document.getElementById('mediaGalleryModal');
    if (!modalElement) {
        // Create modal if it doesn't exist
        const modalHtml = `
            <div class="modal fade" id="mediaGalleryModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-images"></i> Media Gallery
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="media-gallery-grid">
                                <div class="text-center text-muted">
                                    <i class="fas fa-images fa-3x mb-3"></i>
                                    <p>Media gallery feature coming soon!</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    const modal = new bootstrap.Modal(document.getElementById('mediaGalleryModal'));
    modal.show();
    console.log('Media gallery opened');
}

function downloadAttachment(filePath) {
    window.open(filePath, '_blank');
}

function replyToMessage(messageId) {
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    if (messageElement) {
        const senderName = messageElement.querySelector('.message-sender').textContent;
        const messageInput = document.getElementById('message-input');
        messageInput.value = `@${senderName} `;
        messageInput.focus();
    }
}

function createGroup() {
    const groupName = document.getElementById('group-name').value.trim();
    const groupDescription = document.getElementById('group-description').value.trim();
    
    if (!groupName) {
        showToast('Group name is required!', 'error');
        return;
    }
    
    fetch('/production/api/groups', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({
            name: groupName,
            description: groupDescription
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Group created successfully!', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('createGroupModal'));
            modal.hide();
        } else {
            showToast('Error creating group: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error creating group:', error);
        showToast('Error creating group', 'error');
    });
}

function updateMessageReactions(messageId, reactions) {
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    if (!messageElement) return;
    
    const reactionsContainer = messageElement.querySelector('.message-reactions');
    if (reactionsContainer) {
        reactionsContainer.innerHTML = '';
        reactions.forEach(reaction => {
            const reactionElement = createReactionElement(reaction, messageId);
            reactionsContainer.innerHTML += reactionElement;
        });
    }
}

// Emoji picker functions
function setupEmojiPicker() {
    const emojiBtn = document.getElementById('emoji-btn');
    if (emojiBtn) {
        emojiBtn.addEventListener('click', showEmojiPicker);
    }
    
    // Setup emoji categories
    const categoryButtons = document.querySelectorAll('.emoji-category');
    categoryButtons.forEach(button => {
        button.addEventListener('click', () => {
            categoryButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            loadEmojisForCategory(button.dataset.category);
        });
    });
    
    // Load initial emojis
    loadEmojisForCategory('smileys');
}

function showEmojiPicker() {
    const modalElement = document.getElementById('emojiPickerModal');
    if (!modalElement) {
        console.error('Emoji picker modal not found');
        return;
    }
    
    // Initialize Bootstrap modal if not already initialized
    let modal = bootstrap.Modal.getInstance(modalElement);
    if (!modal) {
        modal = new bootstrap.Modal(modalElement);
    }
    
    modal.show();
    console.log('Emoji picker modal opened');
}

function loadEmojisForCategory(category) {
    const emojiGrid = document.getElementById('emoji-grid');
    if (!emojiGrid) return;
    
    const emojis = getEmojisForCategory(category);
    emojiGrid.innerHTML = '';
    
    emojis.forEach(emoji => {
        const emojiButton = document.createElement('button');
        emojiButton.className = 'btn btn-sm emoji-btn';
        emojiButton.textContent = emoji;
        emojiButton.onclick = () => insertEmoji(emoji);
        emojiGrid.appendChild(emojiButton);
    });
}

function getEmojisForCategory(category) {
    const emojiCategories = {
        smileys: ['😀', '😃', '😄', '😁', '😆', '😅', '😂', '🤣', '😊', '😇', '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚', '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩', '🥳', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣', '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬', '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗', '🤔', '🤭', '🤫', '🤥', '😶', '😐', '😑', '😯', '😦', '😧', '😮', '😲', '🥱', '😴', '🤤', '😪', '😵', '🤐', '🥴', '🤢', '🤮', '🤧', '😷', '🤒', '🤕'],
        animals: ['🐶', '🐱', '🐭', '🐹', '🐰', '🦊', '🐻', '🐼', '🐨', '🐯', '🦁', '🐮', '🐷', '🐸', '🐵', '🐔', '🐧', '🐦', '🐤', '🐣', '🦆', '🦅', '🦉', '🦇', '🐺', '🐗', '🐴', '🦄', '🐝', '🐛', '🦋', '🐌', '🐞', '🐜', '🦟', '🦗', '🕷️', '🕸️', '🦂', '🐢', '🐍', '🦎', '🦖', '🦕', '🐙', '🦑', '🦐', '🦞', '🦀', '🐡', '🐠', '🐟', '🐬', '🐳', '🐋', '🦈', '🐊', '🐅', '🐆', '🦓', '🦍', '🐘', '🦛', '🦏', '🐪', '🐫', '🦙', '🦒', '🐃', '🐂', '🐄', '🐎', '🐖', '🐏', '🐑', '🐐', '🦌', '🐕', '🐩', '🦮', '🐕‍🦺', '🐈', '🐈‍⬛', '🐓', '🦃', '🦚', '🦜', '🦢', '🦩', '🕊️', '🐇', '🦝', '🦨', '🦡', '🦫', '🦦', '🦥', '🐁', '🐀', '🐿️', '🦔'],
        food: ['🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🫐', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥', '🥝', '🍅', '🥑', '🥦', '🥬', '🥒', '🌶️', '🫑', '🌽', '🥕', '🫒', '🧄', '🧅', '🥔', '🍠', '🥐', '🥯', '🍞', '🥖', '🥨', '🧀', '🥚', '🍳', '🧈', '🥞', '🧇', '🥓', '🥩', '🍗', '🍖', '🦴', '🌭', '🍔', '🍟', '🍕', '🥪', '🥙', '🧆', '🌮', '🌯', '🫔', '🥗', '🥘', '🫕', '🥫', '🍝', '🍜', '🍲', '🍛', '🍣', '🍱', '🥟', '🦪', '🍤', '🍙', '🍚', '🍘', '🍥', '🥠', '🥮', '🍢', '🍡', '🍧', '🍨', '🍦', '🥧', '🧁', '🍰', '🎂', '🍮', '🍭', '🍬', '🍫', '🍿', '🍩', '🍪', '🌰', '🥜', '🍯', '🥛', '🍼', '🫖', '☕', '🍵', '🧃', '🥤', '🧋', '🍶', '🍺', '🍷', '🥂', '🥃', '🍸', '🍹', '🧉', '🍾', '🥄', '🍴', '🍽️', '🥣', '🥡', '🥢', '🧂'],
        activities: ['⚽', '🏀', '🏈', '⚾', '🥎', '🎾', '🏐', '🏉', '🥏', '🎱', '🪀', '🏓', '🏸', '🏒', '🏑', '🥍', '🏏', '🪃', '🥅', '⛳', '🪁', '🏹', '🎣', '🤿', '🥊', '🥋', '🎽', '🛹', '🛷️', '⛸️', '🥌', '🎿', '⛷️', '🏂', '🪂', '🏋️‍♀️', '🏋️', '🏋️‍♂️', '🤼‍♀️', '🤼', '🤼‍♂️', '🤸‍♀️', '🤸', '🤸‍♂️', '⛹️‍♀️', '⛹️', '⛹️‍♂️', '🤺', '🤾‍♀️', '🤾', '🤾‍♂️', '🏌️‍♀️', '🏌️', '🏌️‍♂️', '🏇', '🧘‍♀️', '🧘', '🧘‍♂️', '🏄‍♀️', '🏄', '🏄‍♂️', '🏊‍♀️', '🏊', '🏊‍♂️', '🤽‍♀️', '🤽', '🤽‍♂️', '🚣‍♀️', '🚣', '🚣‍♂️', '🧗‍♀️', '🧗', '🧗‍♂️', '🚵‍♀️', '🚵', '🚵‍♂️', '🚴‍♀️', '🚴', '🚴‍♂️', '🏆', '🥇', '🥈', '🥉', '🏅', '🎖️', '🏵️', '🎗️', '🎟️', '🎫', '🎪', '🤹‍♀️', '🤹', '🤹‍♂️', '🎭', '🩰', '🎨', '🎬', '🎤', '🎧', '🎼', '🎹', '🥁', '🪘', '🎷', '🎺', '🎸', '🪕', '🎻', '🎲', '♟️', '🎯', '🎳', '🎮', '🎰', '🧩', '🎨', '📱', '📲', '💻', '⌨️', '🖥️', '🖨️', '🖱️', '🖲️', '💽', '💾', '💿', '📀', '🧮', '🎥', '🎞️', '📽️', '📺', '📻', '📷', '📸', '📹', '📼', '📹', '📼', '🔍', '🔎', '🕯️', '💡', '🔦', '🏮', '🪔', '📔', '📕', '📖', '📗', '📘', '📙', '📚', '📓', '📒', '📃', '📜', '📄', '📰', '🗞️', '📑', '🔖', '🏷️', '💰', '🪙', '💴', '💵', '💶', '💷', '🪙', '💳', '🧾', '💸', '🪙', '💴', '💵', '💶', '💷', '🪙', '💳', '🧾', '💸'],
        objects: ['💡', '🔦', '🏮', '🪔', '📔', '📕', '📖', '📗', '📘', '📙', '📚', '📓', '📒', '📃', '📜', '📄', '📰', '🗞️', '📑', '🔖', '🏷️', '💰', '🪙', '💴', '💵', '💶', '💷', '🪙', '💳', '🧾', '💸', '🪙', '💴', '💵', '💶', '💷', '🪙', '💳', '🧾', '💸', '🪙', '💴', '💵', '💶', '💷', '🪙', '💳', '🧾', '💸', '🪙', '💴', '💵', '💶', '💷', '🪙', '💳', '🧾', '💸', '🪙', '💴', '💵', '💶', '💷', '🪙', '💳', '🧾', '💸', '🪙', '💴', '💵', '💶', '💷', '🪙', '💳', '🧾', '💸', '🪙', '💴', '💵', '💶', '💷', '🪙', '💳', '🧾', '💸', '🪙', '💴', '💵', '💶', '💷', '🪙', '💳', '🧾', '💸'],
        symbols: ['❤️', '🧡', '💛', '💚', '💙', '💜', '🖤', '🤍', '🤎', '💔', '❣️', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟', '☮️', '✝️', '☪️', '🕉️', '☸️', '✡️', '🔯', '🕎', '☯️', '☦️', '🛐', '⛎', '♈', '♉', '♊', '♋', '♌', '♍', '♎', '♏', '♐', '♑', '♒', '♓', '🆔', '⚛️', '🉑', '☢️', '☣️', '📴', '📳', '🈶', '🈚', '🈸', '🈺', '🈷️', '✴️', '🆚', '💮', '🉐', '㊙️', '㊗️', '🈴', '🈵', '🈹', '🈲', '🅰️', '🅱️', '🆎', '🆑', '🅾️', '🆘', '❌', '⭕', '🛑', '⛔', '📛', '🚫', '💯', '💢', '♨️', '🚷', '🚯', '🚳', '🚱', '📵', '🔞', '☢️', '☣️', '⬆️', '↗️', '➡️', '↘️', '⬇️', '↙️', '⬅️', '↖️', '↕️', '↔️', '↩️', '↪️', '⤴️', '⤵️', '🔃', '🔄', '🔙', '🔚', '🔛', '🔜', '🔝', '🛐', '⚛️', '🕉️', '✡️', '☸️', '☯️', '✝️', '☪️', '🕎', '🔯', '☦️', '🛐', '⛎', '♈', '♉', '♊', '♋', '♌', '♍', '♎', '♏', '♐', '♑', '♒', '♓', '🆔', '⚛️', '🉑', '☢️', '☣️', '📴', '📳', '🈶', '🈚', '🈸', '🈺', '🈷️', '✴️', '🆚', '💮', '🉐', '㊙️', '㊗️', '🈴', '🈵', '🈹', '🈲', '🅰️', '🅱️', '🆎', '🆑', '🅾️', '🆘', '❌', '⭕', '🛑', '⛔', '📛', '🚫', '💯', '💢', '♨️', '🚷', '🚯', '🚳', '🚱', '📵', '🔞', '☢️', '☣️']
    };
    
    return emojiCategories[category] || emojiCategories.smileys;
}

function insertEmoji(emoji) {
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        const cursorPos = messageInput.selectionStart;
        const text = messageInput.value;
        const newText = text.slice(0, cursorPos) + emoji + text.slice(cursorPos);
        messageInput.value = newText;
        messageInput.setSelectionRange(cursorPos + emoji.length, cursorPos + emoji.length);
        messageInput.focus();
    }
    
    // Close emoji picker
    const modal = bootstrap.Modal.getInstance(document.getElementById('emojiPickerModal'));
    if (modal) {
        modal.hide();
    } else {
        // Fallback: manually hide the modal
        const modalElement = document.getElementById('emojiPickerModal');
        if (modalElement) {
            modalElement.classList.remove('show');
            modalElement.style.display = 'none';
            document.body.classList.remove('modal-open');
            const backdrop = document.querySelector('.modal-backdrop');
            if (backdrop) {
                backdrop.remove();
            }
        }
    }
}

// Reply functionality
function replyToMessage(messageId, senderName) {
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.value = `@${senderName} `;
        messageInput.focus();
        console.log(`Reply to message ${messageId} from ${senderName}`);
    }
}

// Edit functionality (Telegram-like)
let currentEditMessageId = null;
let currentEditOriginalText = '';

function editMessage(messageId) {
    const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
    if (!messageElement) return;
    
    // Get the original message text (only the text content, not reactions)
    const messageText = messageElement.querySelector('.message-text');
    if (!messageText) return;
    
    // Extract only the text content, excluding any reaction elements
    let originalText = '';
    for (let child of messageText.childNodes) {
        if (child.nodeType === Node.TEXT_NODE) {
            originalText += child.textContent;
        }
    }
    originalText = originalText.trim();
    
    // Store current edit state
    currentEditMessageId = messageId;
    currentEditOriginalText = originalText;
    
    // Show edit preview (Telegram-like) - only text content
    const editPreview = document.getElementById('edit-message-preview');
    const editPreviewMessage = document.getElementById('edit-preview-message');
    
    if (editPreview && editPreviewMessage) {
        editPreviewMessage.textContent = originalText;
        editPreview.style.display = 'block';
    }
    
    // Populate message input with original text
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.value = originalText;
        messageInput.focus();
        messageInput.setSelectionRange(originalText.length, originalText.length);
    }
    
    // Change send button to save button
    const sendButton = document.getElementById('send-message-btn');
    if (sendButton) {
        sendButton.innerHTML = '<i class="fas fa-save"></i>';
    }
    
    console.log(`Edit mode activated for message ${messageId} with text: "${originalText}"`);
}

function saveEditedMessage() {
    if (!currentEditMessageId) return;
    
    const messageInput = document.getElementById('message-input');
    const newText = messageInput.value.trim();
    
    if (!newText) {
        showToast('Message cannot be empty', 'error');
        return;
    }
    
    console.log(`Saving edit for message ${currentEditMessageId} with text: "${newText}"`);
    
    // Send update to server
    fetch(`/production/api/messenger/messages/${currentEditMessageId}/edit`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ content: newText })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Server response:', data);
            
            // Find and update the existing message element
            const messageElement = document.querySelector(`[data-message-id="${currentEditMessageId}"]`);
            if (messageElement) {
                console.log(`Found existing message element: ${currentEditMessageId}`);
                
                // Update the message text content
                const messageText = messageElement.querySelector('.message-text');
                if (messageText) {
                    // Clear existing content but preserve reaction options
                    const reactionOptions = messageText.querySelector('.reaction-options');
                    messageText.innerHTML = '';
                    
                    // Add the new text content
                    const textNode = document.createTextNode(newText);
                    messageText.appendChild(textNode);
                    
                    // Restore reaction options if they existed
                    if (reactionOptions) {
                        messageText.appendChild(reactionOptions);
                    }
                    
                    console.log(`Updated message text to: "${newText}"`);
                }
                
                                 // Update the timestamp to show "edited"
                 const messageTime = messageElement.querySelector('.message-time');
                 if (messageTime) {
                     const originalTime = messageTime.textContent.split(' (')[0]; // Get original time
                     
                     // Use the server's updated_at timestamp if available, otherwise use current time
                     const editTimestamp = data.message && data.message.updated_at ? data.message.updated_at : new Date().toISOString();
                     const editedTime = formatRelativeTime(editTimestamp);
                     
                     console.log('Server response data:', data);
                     console.log('Edit timestamp from server:', editTimestamp);
                     console.log('Formatted edit time:', editedTime);
                     
                     messageTime.innerHTML = `${originalTime} <span class="edited-indicator">(edited ${editedTime})</span>`;
                     console.log(`Updated timestamp to show edited: ${originalTime} (edited ${editedTime})`);
                 }
                
                // Exit edit mode
                exitEditMode();
                showToast('Message edited successfully!', 'success');
            } else {
                console.error(`Message element not found for ID: ${currentEditMessageId}`);
                showToast('Error: Message element not found', 'error');
            }
        } else {
            console.error('Server returned error:', data);
            showToast('Failed to edit message', 'error');
        }
    })
    .catch(error => {
        console.error('Error editing message:', error);
        showToast('Error editing message', 'error');
    });
}

function cancelEditMode() {
    exitEditMode();
}

function exitEditMode() {
    // Hide edit preview
    const editPreview = document.getElementById('edit-message-preview');
    if (editPreview) {
        editPreview.style.display = 'none';
    }
    
    // Clear message input
    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.value = '';
        messageInput.placeholder = 'Type your message...';
    }
    
    // Restore send button
    const sendButton = document.getElementById('send-message-btn');
    if (sendButton) {
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
    }
    
    // Clear edit state
    currentEditMessageId = null;
    currentEditOriginalText = '';
    
    console.log('Edit mode exited');
}



// Chat settings functionality
function showChatSettings() {
    const modalElement = document.getElementById('chatSettingsModal');
    if (!modalElement) {
        // Create modal if it doesn't exist
        const modalHtml = `
            <div class="modal fade" id="chatSettingsModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-cog"></i> Chat Settings
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="settings-section">
                                <h6>Notifications</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="soundNotifications" checked>
                                    <label class="form-check-label" for="soundNotifications">
                                        Sound notifications
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="desktopNotifications" checked>
                                    <label class="form-check-label" for="desktopNotifications">
                                        Desktop notifications
                                    </label>
                                </div>
                            </div>
                            <div class="settings-section mt-3">
                                <h6>Display</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showTimestamps" checked>
                                    <label class="form-check-label" for="showTimestamps">
                                        Show timestamps
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="showUserAvatars" checked>
                                    <label class="form-check-label" for="showUserAvatars">
                                        Show user avatars
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveChatSettings()">Save Settings</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
    }
    
    const modal = new bootstrap.Modal(document.getElementById('chatSettingsModal'));
    modal.show();
    console.log('Chat settings opened');
}

function saveChatSettings() {
    const settings = {
        soundNotifications: document.getElementById('soundNotifications').checked,
        desktopNotifications: document.getElementById('desktopNotifications').checked,
        showTimestamps: document.getElementById('showTimestamps').checked,
        showUserAvatars: document.getElementById('showUserAvatars').checked
    };
    
    // Save settings to localStorage
    localStorage.setItem('chatSettings', JSON.stringify(settings));
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('chatSettingsModal'));
    modal.hide();
    
    showToast('Settings saved successfully!', 'success');
    console.log('Chat settings saved:', settings);
}

// Context Menu Functions
let currentContextMessageId = null;

function showMessageContextMenu(event, messageId) {
    event.preventDefault();
    event.stopPropagation();
    
    currentContextMessageId = messageId;
    
    const contextMenu = document.getElementById('message-context-menu');
    if (contextMenu) {
        // Position the context menu at the click position
        contextMenu.style.left = event.pageX + 'px';
        contextMenu.style.top = event.pageY + 'px';
        contextMenu.style.display = 'block';
        
        // Hide context menu when clicking outside
        setTimeout(() => {
            document.addEventListener('click', hideContextMenu);
        }, 0);
    }
}

function hideContextMenu() {
    const contextMenu = document.getElementById('message-context-menu');
    if (contextMenu) {
        contextMenu.style.display = 'none';
    }
    document.removeEventListener('click', hideContextMenu);
}

function replyToMessageFromContext() {
    if (currentContextMessageId) {
        replyToMessage(currentContextMessageId, 'Unknown');
        hideContextMenu();
    }
}

function pinMessageFromContext() {
    if (currentContextMessageId) {
        pinMessage(currentContextMessageId);
        hideContextMenu();
    }
}

function editMessageFromContext() {
    if (currentContextMessageId) {
        editMessage(currentContextMessageId);
        hideContextMenu();
    }
}

function copyMessageText() {
    if (currentContextMessageId) {
        const messageElement = document.querySelector(`[data-message-id="${currentContextMessageId}"]`);
        if (messageElement) {
            const messageText = messageElement.querySelector('.message-text');
            if (messageText) {
                // Get only the pure text content, no HTML, no extra spaces
                let text = messageText.textContent || messageText.innerText || '';
                
                // Remove mentions (anything starting with @)
                text = text.replace(/@\w+/g, '').trim();
                
                // Clean the text - remove extra spaces, newlines, etc.
                text = text.replace(/\s+/g, ' ').trim();
                
                console.log('Copying text (mentions removed):', text);
                
                // Try modern clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(() => {
                        showToast('Message copied to clipboard!', 'success');
                    }).catch(() => {
                        // Fallback to old method
                        fallbackCopyTextToClipboard(text);
                    });
                } else {
                    // Fallback for older browsers
                    fallbackCopyTextToClipboard(text);
                }
            }
        }
        hideContextMenu();
    }
}

function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showToast('Message copied to clipboard!', 'success');
        } else {
            showToast('Failed to copy message', 'error');
        }
    } catch (err) {
        showToast('Failed to copy message', 'error');
    }
    
    document.body.removeChild(textArea);
}

function deleteMessageFromContext() {
    if (currentContextMessageId) {
        if (confirm('Are you sure you want to delete this message?')) {
            console.log(`Attempting to delete message: ${currentContextMessageId}`);
            
            // Get CSRF token
            const csrfToken = getCSRFToken();
            console.log('CSRF Token:', csrfToken);
            
            // Delete message functionality
            fetch(`/production/api/messenger/messages/${currentContextMessageId}/delete`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                console.log('Delete response status:', response.status);
                console.log('Delete response headers:', response.headers);
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.log('Error response text:', text);
                        throw new Error(`HTTP error! status: ${response.status}, response: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Delete response data:', data);
                if (data.success) {
                    // Remove message from UI
                    const messageElement = document.querySelector(`[data-message-id="${currentContextMessageId}"]`);
                    if (messageElement) {
                        messageElement.remove();
                        console.log('Message removed from UI');
                    } else {
                        console.log('Message element not found in UI');
                    }
                    showToast('Message deleted successfully!', 'success');
                } else {
                    console.error('Delete failed:', data.error);
                    showToast(data.error || 'Failed to delete message', 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting message:', error);
                // Check if it's a 404 error (message not found)
                if (error.message.includes('404')) {
                    showToast('Message not found or already deleted', 'error');
                    // Remove from UI if it exists
                    const messageElement = document.querySelector(`[data-message-id="${currentContextMessageId}"]`);
                    if (messageElement) {
                        messageElement.remove();
                    }
                } else {
                    showToast('Error deleting message: ' + error.message, 'error');
                }
            });
        }
        hideContextMenu();
    }
}

// Mention System Functions
let mentionDropdownVisible = false;
let mentionSearchQuery = '';
let mentionUsers = [];
let selectedMentionIndex = -1;

function showMentionPicker() {
    console.log('showMentionPicker called');
    const mentionDropdown = document.getElementById('mention-dropdown');
    const messageInput = document.getElementById('message-input');
    
    console.log('mentionDropdown:', mentionDropdown);
    console.log('messageInput:', messageInput);
    
    if (mentionDropdown && messageInput) {
        // Position dropdown properly
        const inputContainer = messageInput.closest('.message-input-container');
        if (inputContainer) {
            // Position relative to the input container
            mentionDropdown.style.position = 'absolute';
            mentionDropdown.style.bottom = '100%';
            mentionDropdown.style.left = '0';
            mentionDropdown.style.right = '0';
            mentionDropdown.style.zIndex = '9999';
            mentionDropdown.style.display = 'block';
            mentionDropdown.style.visibility = 'visible';
            mentionDropdown.style.opacity = '1';
        }
        
        mentionDropdownVisible = true;
        selectedMentionIndex = -1;
        
        console.log('Loading users for mention...');
        // Load users for mention
        loadMentionUsers();
        
        // Focus on input
        messageInput.focus();
        console.log('Mention picker shown successfully');
        
        // Debug: Check if dropdown is actually visible
        setTimeout(() => {
            const rect = mentionDropdown.getBoundingClientRect();
            console.log('Dropdown position:', rect);
            console.log('Dropdown display:', mentionDropdown.style.display);
            console.log('Dropdown visibility:', mentionDropdown.style.visibility);
        }, 100);
    } else {
        console.error('Mention dropdown or message input not found');
    }
}

function hideMentionPicker() {
    const mentionDropdown = document.getElementById('mention-dropdown');
    if (mentionDropdown) {
        mentionDropdown.style.display = 'none';
        mentionDropdownVisible = false;
        selectedMentionIndex = -1;
    }
}

function loadMentionUsers(query = '') {
    console.log('loadMentionUsers called with query:', query);
    fetch(`/production/api/messenger/users/mention?q=${encodeURIComponent(query)}`)
        .then(response => {
            console.log('Mention users API response:', response);
            return response.json();
        })
        .then(data => {
            console.log('Mention users API data:', data);
            if (data.success) {
                mentionUsers = data.users;
                console.log('Loaded mention users:', mentionUsers);
                displayMentionUsers();
            } else {
                console.error('API returned error:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading mention users:', error);
        });
}

function displayMentionUsers() {
    console.log('displayMentionUsers called');
    const mentionList = document.getElementById('mention-dropdown-list');
    console.log('mentionList:', mentionList);
    if (!mentionList) {
        console.error('Mention list element not found');
        return;
    }
    
    mentionList.innerHTML = '';
    console.log('Displaying', mentionUsers.length, 'users');
    
    if (mentionUsers.length === 0) {
        mentionList.innerHTML = '<div class="mention-item"><span class="text-muted">No users found</span></div>';
        return;
    }
    
    mentionUsers.forEach((user, index) => {
        const mentionItem = document.createElement('div');
        mentionItem.className = 'mention-item';
        mentionItem.onclick = () => selectMentionUser(user);
        mentionItem.onmouseenter = () => {
            selectedMentionIndex = index;
            updateMentionSelection();
        };
        
        const avatar = user.avatar || user.name.charAt(0).toUpperCase();
        
        mentionItem.innerHTML = `
            <div class="mention-avatar">
                ${user.avatar ? `<img src="${user.avatar}" alt="${user.name}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">` : avatar}
            </div>
            <div class="mention-user-info">
                <div class="mention-user-name">${user.name}</div>
                <div class="mention-user-username">@${user.username}</div>
            </div>
            <i class="fas fa-chevron-right"></i>
        `;
        
        mentionList.appendChild(mentionItem);
    });
}

function selectMentionUser(user) {
    const messageInput = document.getElementById('message-input');
    if (!messageInput) return;
    
    // Get current cursor position
    const cursorPos = messageInput.selectionStart;
    const text = messageInput.value;
    
    // Find the last @ symbol before cursor
    const lastAtSymbol = text.lastIndexOf('@', cursorPos - 1);
    
    if (lastAtSymbol !== -1) {
        // Replace the @username with the selected user
        const beforeMention = text.substring(0, lastAtSymbol);
        const afterMention = text.substring(cursorPos);
        const newText = beforeMention + `@${user.username} ` + afterMention;
        
        messageInput.value = newText;
        
        // Set cursor position after the mention
        const newCursorPos = lastAtSymbol + user.username.length + 2; // +2 for @ and space
        messageInput.setSelectionRange(newCursorPos, newCursorPos);
    } else {
        // Just append the mention at the end
        messageInput.value += `@${user.username} `;
    }
    
    // Show success feedback
    showToast(`Mentioned @${user.username}`, 'success');
    
    // Hide mention dropdown
    hideMentionPicker();
    
    // Focus back on input
    messageInput.focus();
    
    // Trigger input event to update any real-time previews
    messageInput.dispatchEvent(new Event('input', { bubbles: true }));
}

function updateMentionSelection() {
    const mentionItems = document.querySelectorAll('.mention-item');
    mentionItems.forEach((item, index) => {
        if (index === selectedMentionIndex) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

// Handle mention dropdown keyboard navigation
function handleMentionKeydown(event) {
    if (!mentionDropdownVisible) return;
    
    const mentionItems = document.querySelectorAll('.mention-item');
    
    switch (event.key) {
        case 'ArrowDown':
            event.preventDefault();
            selectedMentionIndex = Math.min(selectedMentionIndex + 1, mentionUsers.length - 1);
            updateMentionSelection();
            break;
        case 'ArrowUp':
            event.preventDefault();
            selectedMentionIndex = Math.max(selectedMentionIndex - 1, -1);
            updateMentionSelection();
            break;
        case 'Enter':
            event.preventDefault();
            if (selectedMentionIndex >= 0 && selectedMentionIndex < mentionUsers.length) {
                selectMentionUser(mentionUsers[selectedMentionIndex]);
            }
            break;
        case 'Escape':
            event.preventDefault();
            hideMentionPicker();
            break;
    }
}

// Handle @ symbol detection in message input
function highlightMentions(text) {
    // Highlight @mentions with a tag-like appearance
    return text.replace(/@(\w+)/g, '<span class="mention-highlight"><i class="fas fa-at" style="font-size: 0.75rem; margin-right: 0.25rem;"></i>$1</span>');
}

function testMentionDropdown() {
    console.log('Testing mention dropdown...');
    const mentionDropdown = document.getElementById('mention-dropdown');
    const messageInput = document.getElementById('message-input');
    
    console.log('Dropdown element:', mentionDropdown);
    console.log('Message input:', messageInput);
    
    if (mentionDropdown) {
        console.log('Current dropdown styles:');
        console.log('- display:', mentionDropdown.style.display);
        console.log('- visibility:', mentionDropdown.style.visibility);
        console.log('- position:', mentionDropdown.style.position);
        console.log('- z-index:', mentionDropdown.style.zIndex);
        console.log('- bottom:', mentionDropdown.style.bottom);
        
        // Force show the dropdown
        mentionDropdown.style.display = 'block';
        mentionDropdown.style.visibility = 'visible';
        mentionDropdown.style.opacity = '1';
        mentionDropdown.style.position = 'absolute';
        mentionDropdown.style.bottom = '100%';
        mentionDropdown.style.left = '0';
        mentionDropdown.style.right = '0';
        mentionDropdown.style.zIndex = '9999';
        
        console.log('Forced dropdown to show');
        
        // Load test users
        mentionUsers = [
            { id: 1, name: 'Test User 1', username: 'test1', avatar: null },
            { id: 2, name: 'Test User 2', username: 'test2', avatar: null },
            { id: 3, name: 'Test User 3', username: 'test3', avatar: null }
        ];
        
        displayMentionUsers();
        
        setTimeout(() => {
            const rect = mentionDropdown.getBoundingClientRect();
            console.log('Dropdown position after force show:', rect);
        }, 100);
    }
}

function handleMessageInputKeydown(event) {
    const messageInput = document.getElementById('message-input');
    if (!messageInput) return;
    
    const text = messageInput.value;
    const cursorPos = messageInput.selectionStart;
    
    // Check if user typed @
    if (event.key === '@' || (event.key === 'a' && text[cursorPos - 1] === '@')) {
        // Show mention dropdown
        setTimeout(() => {
            showMentionPicker();
        }, 100);
    }
    
    // Check if user is typing after @
    if (text[cursorPos - 1] === '@' || (cursorPos > 0 && text[cursorPos - 2] === '@' && text[cursorPos - 1] !== ' ')) {
        // Extract search query after @
        const lastAtSymbol = text.lastIndexOf('@', cursorPos - 1);
        if (lastAtSymbol !== -1) {
            const searchQuery = text.substring(lastAtSymbol + 1, cursorPos).trim();
            if (searchQuery !== mentionSearchQuery) {
                mentionSearchQuery = searchQuery;
                loadMentionUsers(searchQuery);
            }
        }
    } else {
        // Hide mention dropdown if not typing after @
        if (mentionDropdownVisible) {
            hideMentionPicker();
        }
    }
}


</script>
<script src="{{ url_for('static', filename='js/team_messenger.js') }}"></script>
{% endblock %}
