{% extends 'base.html' %}

{% block title %}ðŸ’¬ Team Chat{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-comments"></i> Team Chat
            </h1>
            <p class="text-muted">Real-time collaboration with your team. Use @mentions to notify specific users.</p>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-comments"></i> Team Chat
                        </h5>
                        <div class="connection-status">
                            <span id="connection-indicator" class="badge bg-success">
                                <i class="fas fa-wifi"></i> Online
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Chat Messages Container -->
                    <div id="chat-messages" class="chat-container">
                        <!-- Messages will be loaded here -->
                    </div>
                    
                    <!-- Typing Indicators -->
                    <div id="typing-indicators" class="typing-indicators">
                        <!-- Typing indicators will appear here -->
                    </div>
                    
                    <!-- Message Input Area -->
                    <div class="chat-input-container">
                        <div class="input-group">
                            <button class="btn btn-outline-secondary" type="button" id="attach-file-btn" title="Attach File">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input type="file" id="file-input" style="display: none;" accept="image/*,.pdf,.doc,.docx,.txt">
                            
                            <div class="form-control message-input-wrapper" style="position: relative;">
                                <textarea 
                                    id="message-input" 
                                    class="form-control border-0" 
                                    placeholder="Type your message... Use @username to mention someone"
                                    rows="2"
                                    style="resize: none; outline: none; box-shadow: none;"
                                ></textarea>
                            </div>
                            
                            <button class="btn btn-primary" type="button" id="send-message-btn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Online Users Sidebar -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-users"></i> Online Users
                    </h5>
                </div>
                <div class="card-body">
                    <div id="online-users" class="online-users">
                        <!-- Online users will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- PWA Install Prompt -->
            <div class="card mt-3" id="pwa-install-card" style="display: none;">
                <div class="card-header bg-warning text-dark">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-download"></i> Install App
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-2">Install EA CRM as a PWA for better experience and offline access.</p>
                    <button class="btn btn-warning btn-sm" id="pwa-install-btn">
                        <i class="fas fa-download"></i> Install
                    </button>
                    <button class="btn btn-outline-secondary btn-sm ms-2" id="pwa-dismiss-btn">
                        <i class="fas fa-times"></i> Dismiss
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Notifications -->
<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
    <!-- Toast notifications will appear here -->
</div>

<!-- PWA Update Prompt -->
<div class="modal fade" id="pwa-update-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sync-alt"></i> Update Available
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>A new version of EA CRM is available. Would you like to update now?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Later</button>
                <button type="button" class="btn btn-primary" id="pwa-update-btn">Update Now</button>
            </div>
        </div>
    </div>
</div>

<!-- Offline Indicator -->
<div id="offline-indicator" class="position-fixed bottom-0 start-0 m-3" style="display: none; z-index: 1050;">
    <div class="alert alert-warning mb-0">
        <i class="fas fa-wifi-slash"></i> You're offline. Messages will be sent when you reconnect.
    </div>
</div>

<script>
// Initialize Enhanced Chat Manager when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the enhanced chat manager
    window.chatManager = new EnhancedChatManager();
    
    // Initialize PWA install manager
    if (typeof PWAInstallManager !== 'undefined') {
        window.pwaManager = new PWAInstallManager();
    }
    
    console.log('Enhanced Chat initialized');
});
</script>

<style>
/* Additional styles for chat interface */
.chat-container {
    height: 500px;
    overflow-y: auto;
    padding: 1rem;
    background: #f8f9fa;
}

.chat-input-container {
    border-top: 1px solid #dee2e6;
    padding: 1rem;
    background: white;
}

.message-input-wrapper {
    position: relative;
    padding: 0;
}

#message-input {
    border: none;
    padding: 0.75rem;
    font-size: 14px;
    line-height: 1.5;
}

#message-input:focus {
    box-shadow: none;
    border: none;
}

.typing-indicators {
    padding: 0.5rem 1rem;
    background: #f8f9fa;
    border-top: 1px solid #dee2e6;
    font-size: 12px;
    color: #6c757d;
}

.online-users {
    max-height: 300px;
    overflow-y: auto;
}

.connection-status {
    font-size: 12px;
}

#connection-indicator {
    font-size: 10px;
}

#offline-indicator {
    max-width: 300px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .chat-container {
        height: 400px;
    }
    
    .col-lg-4 {
        margin-top: 1rem;
    }
}
</style>
{% endblock %} 