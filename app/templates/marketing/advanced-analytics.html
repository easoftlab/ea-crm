{% extends "base.html" %}

{% block title %}Advanced Analytics - Marketing{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0 text-primary">
                        <i class="fas fa-chart-line me-2"></i>Advanced Analytics
                    </h1>
                    <p class="text-muted mb-0">Sophisticated marketing performance analysis</p>
                </div>
                <div class="d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-calendar me-1"></i>Time Range
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" data-range="7">Last 7 Days</a></li>
                            <li><a class="dropdown-item" href="#" data-range="30">Last 30 Days</a></li>
                            <li><a class="dropdown-item" href="#" data-range="90">Last 90 Days</a></li>
                            <li><a class="dropdown-item" href="#" data-range="365">Last Year</a></li>
                        </ul>
                    </div>
                    <button class="btn btn-outline-success" id="exportData">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Leads</h6>
                            <h3 class="mb-0" id="totalLeads">0</h3>
                            <small class="text-white-50">+12% from last month</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Conversion Rate</h6>
                            <h3 class="mb-0" id="conversionRate">0%</h3>
                            <small class="text-white-50">+5% from last month</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-percentage fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Revenue Generated</h6>
                            <h3 class="mb-0" id="revenueGenerated">$0</h3>
                            <small class="text-dark-50">+18% from last month</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Team Productivity</h6>
                            <h3 class="mb-0" id="teamProductivity">0%</h3>
                            <small class="text-white-50">+8% from last month</small>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-bar fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Charts -->
    <div class="row mb-4">
        <!-- Lead Funnel Analysis -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-funnel me-2"></i>Lead Funnel Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="leadFunnelChart" height="300"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Conversion Trends -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-trending-up me-2"></i>Conversion Trends
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="conversionTrendChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <!-- Team Performance Heatmap -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-fire me-2"></i>Team Performance Heatmap
                    </h5>
                </div>
                <div class="card-body">
                    <div id="teamHeatmap"></div>
                </div>
            </div>
        </div>
        
        <!-- Revenue Forecasting -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-crystal-ball me-2"></i>Revenue Forecasting
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="revenueForecastChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced Analytics Grid -->
    <div class="row mb-4">
        <!-- Customer Segmentation -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-users-cog me-2"></i>Customer Segmentation
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="customerSegmentationChart" height="250"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Channel Performance -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-broadcast-tower me-2"></i>Channel Performance
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="channelPerformanceChart" height="250"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Predictive Analytics -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-brain me-2"></i>Predictive Analytics
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="predictiveAnalyticsChart" height="250"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Metrics Dashboard -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>Custom Metrics Dashboard
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="metric-card text-center p-3 border rounded">
                                <h4 class="text-primary" id="avgLeadValue">$0</h4>
                                <p class="mb-0">Average Lead Value</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center p-3 border rounded">
                                <h4 class="text-success" id="leadQualityScore">0</h4>
                                <p class="mb-0">Lead Quality Score</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center p-3 border rounded">
                                <h4 class="text-warning" id="customerLifetimeValue">$0</h4>
                                <p class="mb-0">Customer Lifetime Value</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="metric-card text-center p-3 border rounded">
                                <h4 class="text-info" id="acquisitionCost">$0</h4>
                                <p class="mb-0">Customer Acquisition Cost</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real-time Analytics -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Real-time Analytics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Live Lead Generation</h6>
                            <div class="progress mb-3">
                                <div class="progress-bar bg-success" id="liveLeadProgress" style="width: 0%"></div>
                            </div>
                            <small class="text-muted">Leads generated today: <span id="leadsToday">0</span></small>
                        </div>
                        <div class="col-md-6">
                            <h6>Team Activity</h6>
                            <div class="progress mb-3">
                                <div class="progress-bar bg-primary" id="teamActivityProgress" style="width: 0%"></div>
                            </div>
                            <small class="text-muted">Active team members: <span id="activeMembers">0</span></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analytics Settings Modal -->
<div class="modal fade" id="analyticsSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Analytics Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Chart Preferences</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="showTrends" checked>
                            <label class="form-check-label" for="showTrends">Show trend lines</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="showPredictions" checked>
                            <label class="form-check-label" for="showPredictions">Show predictions</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="showAnomalies" checked>
                            <label class="form-check-label" for="showAnomalies">Highlight anomalies</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Data Refresh</h6>
                        <div class="mb-3">
                            <label for="refreshInterval" class="form-label">Auto-refresh interval</label>
                            <select class="form-select" id="refreshInterval">
                                <option value="30">30 seconds</option>
                                <option value="60" selected>1 minute</option>
                                <option value="300">5 minutes</option>
                                <option value="900">15 minutes</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="dataRetention" class="form-label">Data retention period</label>
                            <select class="form-select" id="dataRetention">
                                <option value="7">7 days</option>
                                <option value="30" selected>30 days</option>
                                <option value="90">90 days</option>
                                <option value="365">1 year</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveAnalyticsSettings">Save Settings</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/heatmap.js"></script>
<script>
// Advanced Analytics Dashboard
class AdvancedAnalytics {
    constructor() {
        this.charts = {};
        this.settings = {
            showTrends: true,
            showPredictions: true,
            showAnomalies: true,
            refreshInterval: 60000,
            dataRetention: 30
        };
        
        this.initializeCharts();
        this.loadAnalyticsData();
        this.setupRealTimeUpdates();
        this.loadSettings();
    }

    initializeCharts() {
        this.createLeadFunnelChart();
        this.createConversionTrendChart();
        this.createTeamHeatmap();
        this.createRevenueForecastChart();
        this.createCustomerSegmentationChart();
        this.createChannelPerformanceChart();
        this.createPredictiveAnalyticsChart();
    }

    createLeadFunnelChart() {
        const ctx = document.getElementById('leadFunnelChart').getContext('2d');
        this.charts.leadFunnel = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Awareness', 'Interest', 'Consideration', 'Intent', 'Purchase'],
                datasets: [{
                    data: [1000, 800, 600, 400, 200],
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    title: {
                        display: true,
                        text: 'Lead Conversion Funnel'
                    }
                }
            }
        });
    }

    createConversionTrendChart() {
        const ctx = document.getElementById('conversionTrendChart').getContext('2d');
        this.charts.conversionTrend = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Conversion Rate',
                    data: [2.1, 2.3, 2.8, 3.2, 3.5, 3.8],
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    createTeamHeatmap() {
        const container = document.getElementById('teamHeatmap');
        const heatmapInstance = h337.create({
            container: container,
            radius: 50,
            maxOpacity: 0.8,
            minOpacity: 0.1
        });

        // Sample heatmap data
        const data = {
            max: 100,
            data: [
                {x: 1, y: 1, value: 80},
                {x: 2, y: 1, value: 90},
                {x: 3, y: 1, value: 70},
                {x: 1, y: 2, value: 85},
                {x: 2, y: 2, value: 95},
                {x: 3, y: 2, value: 75}
            ]
        };

        heatmapInstance.setData(data);
    }

    createRevenueForecastChart() {
        const ctx = document.getElementById('revenueForecastChart').getContext('2d');
        this.charts.revenueForecast = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'],
                datasets: [{
                    label: 'Actual Revenue',
                    data: [50000, 55000, 60000, 65000, 70000, 75000],
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Forecasted Revenue',
                    data: [null, null, null, null, null, 75000, 80000, 85000],
                    borderColor: '#FF6384',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderDash: [5, 5],
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    createCustomerSegmentationChart() {
        const ctx = document.getElementById('customerSegmentationChart').getContext('2d');
        this.charts.customerSegmentation = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['High Value', 'Medium Value', 'Low Value', 'Prospects'],
                datasets: [{
                    data: [25, 35, 20, 20],
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    createChannelPerformanceChart() {
        const ctx = document.getElementById('channelPerformanceChart').getContext('2d');
        this.charts.channelPerformance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Social Media', 'Email', 'Direct', 'Referral', 'Organic'],
                datasets: [{
                    label: 'Leads Generated',
                    data: [120, 180, 90, 60, 150],
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    createPredictiveAnalyticsChart() {
        const ctx = document.getElementById('predictiveAnalyticsChart').getContext('2d');
        this.charts.predictiveAnalytics = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4', 'Week 5', 'Week 6'],
                datasets: [{
                    label: 'Actual Performance',
                    data: [85, 88, 92, 89, 94, 91],
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.4
                }, {
                    label: 'Predicted Performance',
                    data: [null, null, null, null, null, 91, 93, 95, 96],
                    borderColor: '#FF6384',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderDash: [5, 5],
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    loadAnalyticsData() {
        // Load key metrics
        this.updateKeyMetrics();
        
        // Load chart data
        this.loadChartData();
        
        // Load custom metrics
        this.loadCustomMetrics();
    }

    updateKeyMetrics() {
        // Simulate loading real data
        document.getElementById('totalLeads').textContent = '2,847';
        document.getElementById('conversionRate').textContent = '3.8%';
        document.getElementById('revenueGenerated').textContent = '$142,350';
        document.getElementById('teamProductivity').textContent = '87%';
    }

    loadChartData() {
        // In a real implementation, this would fetch data from the server
        console.log('Loading chart data...');
    }

    loadCustomMetrics() {
        document.getElementById('avgLeadValue').textContent = '$50';
        document.getElementById('leadQualityScore').textContent = '8.5';
        document.getElementById('customerLifetimeValue').textContent = '$1,250';
        document.getElementById('acquisitionCost').textContent = '$35';
    }

    setupRealTimeUpdates() {
        // Update real-time metrics
        setInterval(() => {
            this.updateRealTimeMetrics();
        }, 5000);
    }

    updateRealTimeMetrics() {
        const leadsToday = Math.floor(Math.random() * 50) + 20;
        const activeMembers = Math.floor(Math.random() * 5) + 8;
        
        document.getElementById('leadsToday').textContent = leadsToday;
        document.getElementById('activeMembers').textContent = activeMembers;
        
        // Update progress bars
        const leadProgress = (leadsToday / 50) * 100;
        const activityProgress = (activeMembers / 12) * 100;
        
        document.getElementById('liveLeadProgress').style.width = leadProgress + '%';
        document.getElementById('teamActivityProgress').style.width = activityProgress + '%';
    }

    loadSettings() {
        const savedSettings = localStorage.getItem('analyticsSettings');
        if (savedSettings) {
            this.settings = { ...this.settings, ...JSON.parse(savedSettings) };
        }
    }

    saveSettings() {
        localStorage.setItem('analyticsSettings', JSON.stringify(this.settings));
    }
}

// Initialize analytics when page loads
document.addEventListener('DOMContentLoaded', () => {
    new AdvancedAnalytics();
    
    // Export functionality
    document.getElementById('exportData').addEventListener('click', () => {
        // Implement export functionality
        alert('Export functionality would be implemented here');
    });
});
</script>
{% endblock %} 