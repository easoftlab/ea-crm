{% extends "base.html" %}

{% block title %}Admin Activity Dashboard{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="fas fa-users-cog"></i> Team Activity Dashboard</h2>
                <div>
                    <a href="{{ url_for('main.admin_manage_tasks') }}" class="btn btn-outline-primary">
                        <i class="fas fa-tasks"></i> Manage Tasks
                    </a>
                    <a href="{{ url_for('auth.admin_users') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-users"></i> User Management
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Personalized Greeting and Inspiration -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-primary text-white">
                <div class="card-body text-center">
                    <h4 class="mb-2" style="color: #2c3e50 !important;">
                        <i class="fas fa-crown"></i> Hello {{ current_user.first_name or current_user.username }}!
                    </h4>
                    <p class="mb-0 inspiration-text" id="adminInspirationLine" style="color: #2c3e50 !important;">
                        <!-- Inspiration line will be populated by JavaScript -->
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Overview Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white h-100">
                <div class="card-body d-flex flex-column justify-content-center">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Today's Total Leads</h6>
                            <h3>{{ team_daily_stats.total_leads or 0 }}</h3>
                        </div>
                        <div>
                            <i class="fas fa-plus-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white h-100">
                <div class="card-body d-flex flex-column justify-content-center">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Today's Follow-ups</h6>
                            <h3>{{ team_daily_stats.total_followups or 0 }}</h3>
                        </div>
                        <div>
                            <i class="fas fa-phone fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white h-100">
                <div class="card-body d-flex flex-column justify-content-center">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Today's Conversions</h6>
                            <h3>{{ team_daily_stats.total_conversions or 0 }}</h3>
                        </div>
                        <div>
                            <i class="fas fa-trophy fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white h-100">
                <div class="card-body d-flex flex-column justify-content-center">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-title">Active Users</h6>
                            <h3>{{ user_stats|length }}</h3>
                        </div>
                        <div>
                            <i class="fas fa-user-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Production Team Desktop Activity (ActivityWatch) -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-desktop"></i> Production Team Desktop Activity (ActivityWatch)
                    </h5>
                </div>
                <div class="card-body">
                    {% if production_users and production_users|length > 0 %}
                        {% for user in production_users %}
                            <h6 class="mt-4"><i class="fas fa-user"></i> {{ user.get_full_name() }} ({{ user.username }})</h6>
                            {% set activities = production_desktop_activities.get(user.id, []) %}
                            {% if activities and activities|length > 0 %}
                                <div class="table-responsive mb-3">
                                    <table class="table table-sm table-bordered table-striped mb-0">
                                        <thead>
                                            <tr>
                                                <th>Time</th>
                                                <th>App</th>
                                                <th>Title</th>
                                                <th>Duration (s)</th>
                                                <th>Type</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for act in activities %}
                                            <tr>
                                                <td>{{ act.timestamp.strftime('%H:%M:%S') }}</td>
                                                <td>{{ act.app }}</td>
                                                <td>{{ act.title }}</td>
                                                <td>{{ act.duration or '-' }}</td>
                                                <td>{{ act.activity_type or '-' }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <div class="text-muted mb-3">No desktop activity recorded for today.</div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <div class="text-muted">No production users found.</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- User Performance Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> User Performance Overview</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Today's Leads</th>
                                    <th>Today's Follow-ups</th>
                                    <th>Today's Calls</th>
                                    <th>Week's Calls</th>
                                    <th>Month's Calls</th>
                                    <th>Total Calls</th>
                                    <th>Week's Leads</th>
                                    <th>Week's Conversions</th>
                                    <th>Month's Leads</th>
                                    <th>Month's Conversions</th>
                                    <th>Last Activity</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user_id, stats in user_stats.items() %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                                                <span class="text-white fw-bold">{{ stats.user.username[0].upper() }}</span>
                                            </div>
                                            <div>
                                                <a href="{{ url_for('main.admin_user_activity', user_id=stats.user.id) }}" class="text-decoration-none">
                                                    <strong class="text-primary">{{ stats.user.get_full_name() }}</strong>
                                                </a>
                                                <br>
                                                <small class="text-muted">{{ stats.user.username }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'danger' if stats.user.role.name == 'Admin' else 'warning' if stats.user.role.name == 'Manager' else 'info' if stats.user.role.name == 'User' else 'secondary' }}">
                                            {{ stats.user.role.name }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ stats.daily.leads_created if stats.daily else 0 }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ stats.daily.followups_added if stats.daily else 0 }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning">{{ stats.today_calls }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ stats.week_calls }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ stats.month_calls }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ stats.total_calls }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-warning">{{ stats.weekly.leads_created if stats.weekly else 0 }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ stats.weekly.conversions if stats.weekly else 0 }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ stats.monthly.leads_created if stats.monthly else 0 }}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success">{{ stats.monthly.conversions if stats.monthly else 0 }}</span>
                                    </td>
                                    <td>
                                        {% if stats.recent_activities %}
                                            <small class="text-muted">{{ stats.recent_activities[0].created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                        {% else %}
                                            <small class="text-muted">No activity</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{{ url_for('main.admin_user_activity', user_id=stats.user.id) }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye"></i> View
                                            </a>
                                            <a href="{{ url_for('main.admin_manage_tasks') }}?user_id={{ stats.user.id }}" class="btn btn-sm btn-outline-success">
                                                <i class="fas fa-tasks"></i> Tasks
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Performance Charts -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> Team Performance This Week</h5>
                </div>
                <div class="card-body">
                    <canvas id="teamPerformanceChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Activity Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="activityDistributionChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Team Activities -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Recent Team Activities</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for user_id, stats in user_stats.items() %}
                        {% if stats.recent_activities %}
                        <div class="col-md-6 mb-3">
                            <div class="card border">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-user"></i> 
                                        <a href="{{ url_for('main.admin_user_activity', user_id=stats.user.id) }}" class="text-decoration-none">
                                            <span class="text-primary">{{ stats.user.get_full_name() }}</span>
                                        </a>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% for activity in stats.recent_activities[:3] %}
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <small class="text-muted">{{ activity.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                            <br>
                                            <span class="small">{{ activity.description }}</span>
                                        </div>
                                        <span class="badge bg-secondary small">{{ activity.activity_type|replace('_', ' ')|title }}</span>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Inspirational Lines for 22 Working Days
const inspirationalLines = [
    "Every call is an opportunity to change someone's life.",
    "Success is not final, failure is not fatal: it is the courage to continue that counts.",
    "The only way to do great work is to love what you do.",
    "Your attitude determines your direction.",
    "Make today amazing so tomorrow can be extraordinary.",
    "Small progress is still progress.",
    "Believe you can and you're halfway there.",
    "The future belongs to those who believe in the beauty of their dreams.",
    "Don't count the days, make the days count.",
    "Success is walking from failure to failure with no loss of enthusiasm.",
    "The harder you work, the luckier you get.",
    "Your potential is greater than your past.",
    "Every expert was once a beginner.",
    "The only limit to your impact is your imagination and commitment.",
    "Today's efforts are tomorrow's achievements.",
    "Focus on progress, not perfection.",
    "You are capable of more than you know.",
    "The best way to predict the future is to create it.",
    "Your voice matters, your story matters.",
    "Every 'no' brings you closer to 'yes'.",
    "You have the power to create change.",
    "Dream big, work hard, stay focused."
];

// Function to get today's inspirational line (sequential for admin)
function getTodaysInspiration() {
    const today = new Date();
    const dayOfMonth = today.getDate();
    
    // For admin, use sequential order based on day of month
    // This ensures admin sees predictable, sequential messages
    const lineIndex = (dayOfMonth - 1) % inspirationalLines.length;
    
    return inspirationalLines[lineIndex];
}

// Function to adjust font size based on text length
function adjustFontSize(element, text) {
    const maxFontSize = 1.1; // Maximum font size in rem
    const minFontSize = 0.8; // Minimum font size in rem
    const containerWidth = element.offsetWidth;
    
    // Set initial font size
    element.style.fontSize = maxFontSize + 'rem';
    element.textContent = text;
    
    // Check if text fits, if not, reduce font size
    while (element.scrollWidth > containerWidth && parseFloat(element.style.fontSize) > minFontSize) {
        const currentSize = parseFloat(element.style.fontSize);
        element.style.fontSize = (currentSize - 0.05) + 'rem';
    }
}

// Set the inspirational line when page loads
document.addEventListener('DOMContentLoaded', function() {
    const inspirationElement = document.getElementById('adminInspirationLine');
    if (inspirationElement) {
        const todaysInspiration = getTodaysInspiration();
        adjustFontSize(inspirationElement, todaysInspiration);
    }
});

// Adjust font size on window resize
window.addEventListener('resize', function() {
    const inspirationElement = document.getElementById('adminInspirationLine');
    if (inspirationElement) {
        const todaysInspiration = getTodaysInspiration();
        adjustFontSize(inspirationElement, todaysInspiration);
    }
});

// Team Performance Chart
const teamPerformanceCtx = document.getElementById('teamPerformanceChart').getContext('2d');
const teamPerformanceChart = new Chart(teamPerformanceCtx, {
    type: 'bar',
    data: {
        labels: ['{{ user_stats.keys()|list|join("', '") }}'],
        datasets: [{
            label: 'Leads Created',
            data: [{% for user_id, stats in user_stats.items() %}{{ stats.weekly.leads_created if stats.weekly else 0 }}{% if not loop.last %}, {% endif %}{% endfor %}],
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
        }, {
            label: 'Conversions',
            data: [{% for user_id, stats in user_stats.items() %}{{ stats.weekly.conversions if stats.weekly else 0 }}{% if not loop.last %}, {% endif %}{% endfor %}],
            backgroundColor: 'rgba(255, 99, 132, 0.6)',
            borderColor: 'rgba(255, 99, 132, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'Weekly Performance by User'
            }
        }
    }
});

// Activity Distribution Chart
const activityDistributionCtx = document.getElementById('activityDistributionChart').getContext('2d');
const activityDistributionChart = new Chart(activityDistributionCtx, {
    type: 'doughnut',
    data: {
        labels: ['Leads Created', 'Follow-ups', 'Conversions', 'Tasks'],
        datasets: [{
            data: [
                {{ team_weekly_stats.total_leads or 0 }},
                {{ team_weekly_stats.total_followups or 0 }},
                {{ team_weekly_stats.total_conversions or 0 }},
                {{ user_stats|length * 2 }}  // Estimated tasks
            ],
            backgroundColor: [
                'rgb(255, 99, 132)',
                'rgb(54, 162, 235)',
                'rgb(255, 205, 86)',
                'rgb(75, 192, 192)'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: 'Team Activity Distribution'
            }
        }
    }
});
</script>
{% endblock %} 