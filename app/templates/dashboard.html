{% extends 'base.html' %}
{% block title %}Dashboard{% endblock %}
{% macro status_dot(status) %}
  {% if status == 'New' %}
    <span class="align-middle" style="color: #007bff; font-size: 1.2em; vertical-align: middle;">●</span>
  {% elif status == 'Converted' %}
    <span class="align-middle" style="color: #28a745; font-size: 1.2em; vertical-align: middle;">●</span>
  {% elif status == 'Interested' %}
    <span class="align-middle" style="color: #28a745; font-size: 1.2em; vertical-align: middle;">●</span>
  {% elif status == 'Not Interested' %}
    <span class="align-middle" style="color: #dc3545; font-size: 1.2em; vertical-align: middle;">●</span>
  {% elif status == 'Follow Up' %}
    <span class="align-middle" style="color: #fd7e14; font-size: 1.2em; vertical-align: middle;">●</span>
  {% elif status == 'In Progress' %}
    <span class="align-middle" style="color: #6f42c1; font-size: 1.2em; vertical-align: middle;">●</span>
  {% else %}
    <span class="align-middle" style="color: #adb5bd; font-size: 1.2em; vertical-align: middle;">●</span>
  {% endif %}
{% endmacro %}
{% macro status_badge(status) %}
  {%- set key = status|lower|trim %}
  {%- set badge_map = {
    'new': 'primary',
    'converted': 'success',
    'not interested': 'danger',
    'follow up': 'warning text-dark',
    'in progress': 'info',
    'no answer': 'secondary',
    'call not reach': 'secondary',
    'wrong number': 'secondary',
    'voice mail': 'secondary',
    'scheduled for meeting': 'info',
    'do not call': 'dark',
    'interested': 'success'
  } %}
  {%- set badge = badge_map.get(key, 'secondary') %}
  {%- set parts = badge.split(' ') %}
  <span class="badge bg-{{ parts[0] }}{% if parts|length > 1 %} {{ parts[1] }}{% endif %} align-middle">{{ status }}</span>
{% endmacro %}
{% macro industry_badge(industry) %}
  {%- set key = industry|lower|trim %}
  {%- set badge_map = {
    'e-commerce / online retail': 'info',
    'fashion & apparel': 'primary',
    'jewelry & luxury goods': 'warning',
    'real estate': 'success',
    'photography studios': 'secondary',
    'wedding & event photographers': 'danger',
    'advertising & creative agencies': 'dark',
    'marketing firms': 'info',
    'magazine & publishing houses': 'primary',
    'automotive dealerships': 'success',
    'furniture & home decor brands': 'warning',
    'cosmetics & skincare brands': 'danger',
    'modeling agencies': 'info',
    'printing & packaging companies': 'secondary',
    'product manufacturers': 'primary',
    'auction houses': 'dark',
    'food & beverage brands': 'success',
    'eyewear & accessories brands': 'info',
    'stock photography agencies': 'secondary',
    'electronics & gadgets retailers': 'primary',
    'wellness photographer': 'success',
    'business + creativity coach': 'warning',
    'commercial studio & lifestyle photographer': 'danger',
    'lead photographer': 'info'
  } %}
  {%- set badge = badge_map.get(key, 'secondary') %}
  <span class="badge bg-{{ badge }}">{{ industry }}</span>
{% endmacro %}
{% set source_color_map = {
  'Google Maps / Search': 'primary',
  'LinkdIN': 'info',
  'Instagram': 'danger',
  'Directory Websites': 'warning text-dark',
  'Freelancer Marketplace': 'success',
  'Email Marketing': 'secondary',
  'Direct Clients (SEO)': 'dark',
  'PPC Campigns': 'primary',
  'Recomendations': 'success'
} %}
{% block content %}

<!-- Profile Completion Warning -->
{% if not profile_complete %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">
                    <h5 class="alert-heading mb-2">
                        <i class="fas fa-exclamation-triangle"></i> Profile Incomplete
                    </h5>
                    <p class="mb-2">
                        Your profile is missing required information. Please complete your profile to access all features.
                    </p>
                    {% if missing_profile_fields %}
                    <p class="mb-2"><strong>Missing fields:</strong></p>
                    <ul class="mb-2">
                        {% for field in missing_profile_fields[:5] %}
                        <li>{{ field }}</li>
                        {% endfor %}
                        {% if missing_profile_fields|length > 5 %}
                        <li>... and {{ missing_profile_fields|length - 5 }} more</li>
                        {% endif %}
                    </ul>
                    {% endif %}
                </div>
                <div class="ms-3">
                    <a href="{{ url_for('auth.profile') }}" class="btn btn-primary">
                        <i class="fas fa-user-edit"></i> Complete Profile
                    </a>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
</div>
{% endif %}

<div class="row mb-4">
  <div class="col-md-2">
    <div class="card text-white bg-dark mb-3" id="card-remain-leads" style="cursor:pointer;">
      <div class="card-body">
        <h5 class="card-title" style="font-size:0.9rem;">📊 Remain Leads</h5>
        <p class="card-text" style="font-size:2rem;">{{ total_remain_leads }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-white bg-info mb-3" id="card-new-leads" style="cursor:pointer;">
      <div class="card-body">
        <h5 class="card-title" style="font-size:0.9rem;">🆕 New Today</h5>
        <p class="card-text display-6">{{ new_leads_today }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-white bg-warning mb-3" id="card-followups" style="cursor:pointer;">
      <div class="card-body">
        <h5 class="card-title" style="font-size:0.9rem;">📅 Followup Dues</h5>
        <p class="card-text display-6">{{ follow_ups_due if follow_ups_due is not none and follow_ups_due != '' else 0 }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-white bg-success mb-3" id="card-converted" style="cursor:pointer;">
      <div class="card-body">
        <h5 class="card-title" style="font-size:0.9rem;">✅ Converted</h5>
        <p class="card-text display-6">{{ converted }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-white bg-primary mb-3" id="card-interested" style="cursor:pointer;">
      <div class="card-body">
        <h5 class="card-title" style="font-size:0.9rem;">🎯 Interested</h5>
        <p class="card-text display-6">{{ interested }}</p>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-white bg-warning mb-3" id="card-today-calls" style="cursor:pointer;">
      <div class="card-body">
        <h5 class="card-title" style="font-size:0.9rem;">🛎️ Today Calls</h5>
        <p class="card-text display-6">{{ today_calls }}</p>
      </div>
    </div>
  </div>
</div>
<!-- Filter/Search Bar -->
<div class="row mb-3">
  <div class="col">
    <form class="row g-2" id="filter-form" onsubmit="return false;">
      <div class="col-md-2">
        <select class="form-control" name="status" id="status-filter">
          <option value="">Status</option>
          {% for val in statuses %}<option value="{{ val }}" {% if status == val %}selected{% endif %}>{{ val }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-control" name="country" id="country-filter">
          <option value="">Country</option>
          {% for val in countries %}<option value="{{ val }}" {% if country == val %}selected{% endif %}>{{ val }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-control" name="industry" id="industry-filter">
          <option value="">Industry</option>
          {% for val in industries %}<option value="{{ val }}" {% if industry == val %}selected{% endif %}>{{ val }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-control" name="timezone" id="timezone-filter">
          <option value="">Timezone</option>
          {% for val in timezones %}<option value="{{ val }}" {% if timezone == val %}selected{% endif %}>{{ val }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <input type="text" class="form-control" name="search" id="search-input" placeholder="Search" value="{{ search }}">
      </div>
      <div class="col-md-2">
        <button class="btn btn-primary w-100" type="button" id="filter-btn">Filter</button>
      </div>
    </form>
  </div>
</div>
<!-- Export Buttons - Admin Only -->
{% if current_user.has_permission('admin') %}
<div class="mb-3 d-flex align-items-center gap-2">
  <button class="btn btn-success me-2" id="export-csv">Export CSV</button>
  <button class="btn btn-primary me-2" id="export-excel">Export Excel</button>
  <a href="/import_leads" class="btn btn-warning me-2">Import Leads</a>
  <button class="btn btn-primary" id="select-btn"><i class="bi bi-check-square"></i> Select</button>
  <button class="btn btn-danger" id="delete-btn"><i class="bi bi-trash"></i> Delete</button>
  <button class="btn btn-outline-danger" id="delete-all-btn"><i class="bi bi-x-circle"></i> Delete ALL</button>
</div>
{% else %}
<!-- Non-admin users see limited controls -->
<div class="mb-3 d-flex align-items-center gap-2">
</div>
{% endif %}
<!-- Leads Table -->
<div class="table-responsive">
  <table class="table table-striped table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th><span>🏢</span> Company</th>
        <th><span>🌍</span> Country/State</th>
        <th><span>🏷️</span> Industry</th>
        <th><span>👤</span> Contact</th>
        <th><span>💼</span> Position</th>
        <th><span>📞</span> Phone</th>
        <th><span>✉️</span> Email</th>
        <th><span>🟢</span> Status</th>
        <th><span>📅</span> Follow-up</th>
        <th class="main-row-created" style="display:none;">Created</th>
      </tr>
    </thead>
    <tbody id="leads-table-body" class="accordion" data-bs-parent="#leads-table-body">
      <!-- AJAX loaded rows -->
    </tbody>
  </table>
</div>
<!-- Pagination Controls -->
<nav aria-label="Leads pagination">
  <ul class="pagination justify-content-center" id="leads-pagination"></ul>
</nav>
<!-- Follow-up messages are now handled dynamically via JavaScript -->

<!-- No leads with specific status message -->
{% if status and leads|length == 0 %}
  <div class="text-center py-5" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; margin: 20px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    {% if status == 'Interested' %}
      <div class="display-1 text-muted mb-3" style="font-size: 4rem;">🎯</div>
      <h1 class="display-4 text-muted mb-3" style="font-size: 3rem; font-weight: 300; color: #6c757d;">No Interested leads</h1>
      <p class="lead text-muted" style="font-size: 1.25rem;">No leads with "Interested" status found.</p>
    {% elif status == 'Not Interested' %}
      <div class="display-1 text-muted mb-3" style="font-size: 4rem;">❌</div>
      <h1 class="display-4 text-muted mb-3" style="font-size: 3rem; font-weight: 300; color: #6c757d;">No Not Interested leads</h1>
      <p class="lead text-muted" style="font-size: 1.25rem;">No leads with "Not Interested" status found.</p>
    {% else %}
      <div class="display-1 text-muted mb-3" style="font-size: 4rem;">📊</div>
      <h1 class="display-4 text-muted mb-3" style="font-size: 3rem; font-weight: 300; color: #6c757d;">No leads found</h1>
      <p class="lead text-muted" style="font-size: 1.25rem;">No leads with "{{ status }}" status found.</p>
    {% endif %}
    <div class="mt-4">
      <span class="badge bg-info fs-6">No data available</span>
    </div>
  </div>
{% endif %}

<!-- No today's calls message -->
{% if request.args.get('updated_today') and leads|length == 0 %}
  <div class="text-center py-5" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; margin: 20px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div class="display-1 text-muted mb-3" style="font-size: 4rem;">🛎️</div>
    <h1 class="display-4 text-muted mb-3" style="font-size: 3rem; font-weight: 300; color: #6c757d;">No calls made today</h1>
    <p class="lead text-muted" style="font-size: 1.25rem;">Time to make some calls! Start reaching out to your leads and track your progress.</p>
    <div class="mt-4">
      <span class="badge bg-warning fs-6">Ready to call! 📞</span>
    </div>
  </div>
{% endif %}

<!-- No new leads today message -->
{% if request.args.get('created_today') and leads|length == 0 %}
  <div class="text-center py-5" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; margin: 20px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div class="display-1 text-muted mb-3" style="font-size: 4rem;">🆕</div>
    <h1 class="display-4 text-muted mb-3" style="font-size: 3rem; font-weight: 300; color: #6c757d;">No new leads today</h1>
    <p class="lead text-muted" style="font-size: 1.25rem;">Time to find some fresh leads! Start prospecting and building your pipeline.</p>
    <div class="mt-4">
      <span class="badge bg-info fs-6">Ready to prospect! 🔍</span>
    </div>
  </div>
{% endif %}

<!-- Edit Lead Modal -->
<div class="modal fade" id="editLeadModal" tabindex="-1" aria-labelledby="editLeadModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="editLeadForm" method="POST">
        <!-- CSRF token removed for compatibility -->
        <input type="hidden" name="lead_id" id="editLeadId">
        <div class="modal-header">
          <h5 class="modal-title" id="editLeadModalLabel">Edit Lead</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="editLeadStatus" class="form-label">Status</label>
            <input type="text" class="form-control" id="editLeadStatus" name="status">
          </div>
          <div class="mb-3">
            <label for="editLeadNotes" class="form-label">Notes</label>
            <textarea class="form-control" id="editLeadNotes" name="notes" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
<form id="csrf-form" style="display:none;">
  <!-- CSRF token removed for compatibility -->
</form>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Hide table for Today Calls and New Today when no results
    const urlParams = new URLSearchParams(window.location.search);
    const updatedToday = urlParams.get('updated_today');
    const createdToday = urlParams.get('created_today');
    const tableContainer = document.querySelector('.table-responsive');
    const tableBody = document.getElementById('leads-table-body');
    
    // Handle Today Calls with no results
    if (updatedToday && tableBody && tableBody.children.length === 0) {
      if (tableContainer) {
        tableContainer.style.display = 'none';
      }
      const paginationContainer = document.querySelector('nav[aria-label="Leads pagination"]');
      if (paginationContainer) {
        paginationContainer.style.display = 'none';
      }
    }
    
    // Handle New Today with no results
    if (createdToday && tableBody && tableBody.children.length === 0) {
      if (tableContainer) {
        tableContainer.style.display = 'none';
      }
      const paginationContainer = document.querySelector('nav[aria-label="Leads pagination"]');
      if (paginationContainer) {
        paginationContainer.style.display = 'none';
      }
    }
    
    // Edit Lead Modal logic
    var editLeadModal = document.getElementById('editLeadModal');
    var editLeadForm = document.getElementById('editLeadForm');
    var statusInput = document.getElementById('editLeadStatus');
    var notesInput = document.getElementById('editLeadNotes');
    var leadIdInput = document.getElementById('editLeadId');
    var editButtons = document.querySelectorAll('.edit-lead-btn');
    editButtons.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var leadId = this.getAttribute('data-lead-id');
        fetch('/lead/' + leadId)
          .then(response => response.json())
          .then(data => {
            leadIdInput.value = data.id;
            statusInput.value = data.status;
            notesInput.value = data.notes;
            editLeadForm.action = '/lead/' + data.id + '/edit';
          });
      });
    });
    // Choices.js for dashboard filters
    new Choices('#status-filter', { removeItemButton: true, allowHTML: false, addItems: true, duplicateItemsAllowed: false, placeholder: true, placeholderValue: 'Status' });
    new Choices('#country-filter', { removeItemButton: true, allowHTML: false, addItems: true, duplicateItemsAllowed: false, placeholder: true, placeholderValue: 'Country' });
    new Choices('#industry-filter', { removeItemButton: true, allowHTML: false, addItems: true, duplicateItemsAllowed: false, placeholder: true, placeholderValue: 'Industry' });
    new Choices('#timezone-filter', { removeItemButton: true, allowHTML: false, addItems: true, duplicateItemsAllowed: false, placeholder: true, placeholderValue: 'Timezone' });
    // Copy-on-click logic for phone/email
    document.querySelectorAll('.copy-on-click').forEach(function(el) {
      el.style.cursor = 'pointer';
      el.title = 'Click to copy';
      el.addEventListener('click', function(e) {
        var text = el.getAttribute('data-copy');
        if (text) {
          navigator.clipboard.writeText(text);
          el.classList.add('bg-success', 'text-white');
          el.title = 'Copied!';
          setTimeout(function() {
            el.classList.remove('bg-success', 'text-white');
            el.title = 'Click to copy';
          }, 1000);
        }
      });
    });
    // Status dropdown AJAX update
    document.querySelectorAll('.status-dropdown').forEach(function(drop) {
      drop.addEventListener('change', function(e) {
        var leadId = this.getAttribute('data-lead-id');
        var newStatus = this.value;
        fetch('/lead/' + leadId + '/edit', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'Content-Type': 'application/json'
          },
          body: 'status=' + encodeURIComponent(newStatus)
        }).then(function(resp) {
          if (resp.ok) {
            drop.classList.add('bg-success', 'text-white');
            setTimeout(function() {
              drop.classList.remove('bg-success', 'text-white');
            }, 1000);
          }
        });
      });
    });
    // Click-to-edit Notes logic
    document.querySelectorAll('.editable-notes').forEach(function(span) {
      span.addEventListener('click', function() {
        var leadId = this.getAttribute('data-lead-id');
        this.classList.add('d-none');
        var textarea = document.querySelector('.edit-notes-textarea[data-lead-id="' + leadId + '"]');
        textarea.classList.remove('d-none');
        textarea.focus();
        // Add blur and Escape key logic
        function revertNotesEdit() {
          textarea.classList.add('d-none');
          span.classList.remove('d-none');
        }
        textarea.addEventListener('blur', revertNotesEdit, { once: true });
        textarea.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            revertNotesEdit();
          }
        }, { once: true });
      });
    });
    // Click-to-edit Follow-up date logic
    document.querySelectorAll('.editable-followup').forEach(function(span) {
      span.addEventListener('click', function() {
        var leadId = this.getAttribute('data-lead-id');
        this.classList.add('d-none');
        var input = document.querySelector('.edit-followup-input[data-lead-id="' + leadId + '"]');
        input.classList.remove('d-none');
        input.value = span.textContent.trim() === 'Click to set follow-up' ? '' : span.textContent.trim();
        input.focus();
        // Initialize Flatpickr
        if (!input._flatpickr) {
          flatpickr(input, {
            dateFormat: 'Y-m-d',
            allowInput: true,
            defaultDate: input.value || new Date(),
            minDate: 'today'
          });
        }
        // Blur/Escape logic
        function revertFollowupEdit() {
          input.classList.add('d-none');
          span.classList.remove('d-none');
        }
        input.addEventListener('blur', revertFollowupEdit, { once: true });
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            revertFollowupEdit();
          }
        }, { once: true });
      });
    });
    // Click-to-edit Company Website logic
    document.querySelectorAll('.editable-website').forEach(function(span) {
      span.addEventListener('click', function(e) {
        var leadId = this.getAttribute('data-lead-id');
        this.classList.add('d-none');
        var input = document.querySelector('.edit-website-input[data-lead-id="' + leadId + '"]');
        input.classList.remove('d-none');
        input.focus();
        // Blur/Escape logic
        function revertWebsiteEdit() {
          input.classList.add('d-none');
          span.classList.remove('d-none');
        }
        input.addEventListener('blur', revertWebsiteEdit, { once: true });
        input.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            revertWebsiteEdit();
          }
        }, { once: true });
      });
    });
    // Add JS for toggling edit mode for all main fields
    document.querySelectorAll('.btn-edit-details').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var leadId = this.getAttribute('data-lead-id');
        console.log('Edit button clicked for leadId:', leadId);
        // Revert all other leads to display mode
        document.querySelectorAll('.lead-details-editable').forEach(function(wrapper) {
          if (wrapper.getAttribute('data-lead-id') !== leadId) {
            wrapper.style.background = '';
            wrapper.querySelectorAll('.display-website, .display-contacts, .display-industry, .display-country, .display-state, .display-timezone').forEach(function(el) { el.classList.remove('d-none'); });
            wrapper.querySelectorAll('.edit-website-input, .edit-contacts, .edit-industry-input, .edit-country-input, .edit-state-input, .edit-timezone-input').forEach(function(el) { el.classList.add('d-none'); });
          }
        });
        // Enable edit mode for the selected lead (scoped to this wrapper only)
        var wrapper = this.closest('.lead-details-editable');
        if (wrapper) {
          console.log('Toggling fields inside wrapper for leadId:', leadId, wrapper);
          wrapper.style.background = '#fffbe6'; // highlight for debug
          wrapper.querySelectorAll('.display-website, .display-contacts, .display-industry, .display-country, .display-state, .display-timezone').forEach(function(el) { el.classList.add('d-none'); });
          wrapper.querySelectorAll('.edit-website-input, .edit-contacts, .edit-industry-input, .edit-country-input, .edit-state-input, .edit-timezone-input').forEach(function(el) { el.classList.remove('d-none'); });
        } else {
          console.log('No wrapper found for leadId:', leadId);
        }
      });
    });
    // Update Lead Details AJAX logic
    document.querySelectorAll('.btn-update-details').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var leadId = this.getAttribute('data-lead-id');
        var status = document.querySelector('.status-dropdown[data-lead-id="' + leadId + '"]').value;
        var followupInput = document.querySelector('.edit-followup-input[data-lead-id="' + leadId + '"]');
        var followupDate = followupInput ? followupInput.value : '';
        var notesTextarea = document.querySelector('.edit-notes-textarea[data-lead-id="' + leadId + '"]');
        var notesValue = notesTextarea ? notesTextarea.value : '';
        var formData = new FormData();
        formData.append('lead_id', leadId);
        formData.append('status', status);
        formData.append('followup_date', followupDate);
        formData.append('notes', notesValue);
        formData.append('csrf_token', '{{ csrf_token() }}');
        console.log('CSRF Token:', '{{ csrf_token() }}');
        fetch('/update_lead', {
          method: 'POST',
          credentials: 'same-origin',
          body: formData
        })
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.indexOf('application/json') !== -1) {
            return response.json();
          } else {
            throw new Error('Not JSON');
          }
        })
        .then(data => {
          if (data.success) {
            var followupSpan = document.querySelector('.display-followup[data-lead-id="' + leadId + '"]');
            if (followupSpan) followupSpan.textContent = data.followup_date || 'Click to set follow-up';
            var statusDropdown = document.querySelector('.status-dropdown[data-lead-id="' + leadId + '"]');
            if (statusDropdown) statusDropdown.value = data.status;
            // Optionally update notes if returned
            if (data.notes !== undefined) {
              var notesSpan = document.querySelector('.editable-notes[data-lead-id="' + leadId + '"]');
              if (notesSpan) notesSpan.textContent = data.notes || 'Click to add notes';
            }
            var mainRowNotes = document.querySelector('.main-row-notes[data-lead-id="' + leadId + '"]');
            if (mainRowNotes) mainRowNotes.textContent = data.notes || '';
            var mainRowStatus = document.querySelector('.main-row-status[data-lead-id="' + leadId + '"]');
            if (mainRowStatus) mainRowStatus.textContent = data.status || '';
            
            // Check if status changed from 'New' to something else
            var originalStatus = mainRowStatus ? mainRowStatus.textContent.trim() : '';
            var newStatus = data.status || '';
            
            // If status changed from 'New' to something else, remove the lead from current view
            if (originalStatus === 'New' && newStatus !== 'New') {
              var mainRow = document.querySelector('tr[data-bs-target="#details-' + leadId + '"]');
              var detailsRow = document.getElementById('details-' + leadId);
              if (mainRow) mainRow.remove();
              if (detailsRow) detailsRow.remove();
              
              // Check if we need to fetch more data to fill the page
              var remainingRows = document.querySelectorAll('#leads-table-body tr').length;
              if (remainingRows < perPage) {
                // Fetch additional leads to fill the page
                fetchAdditionalLeads();
              }
              
              var toast = document.createElement('div');
              toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
              toast.textContent = 'Lead status updated! Lead moved to ' + newStatus + ' category.';
              document.body.appendChild(toast);
              setTimeout(() => toast.remove(), 3000);
              return; // Exit early since we removed the rows
            }
            
            // Update status display if lead remains in view
            let key = (data.status || '').toLowerCase().trim();
            let dotColor = {
              'new': '#007bff',
              'converted': '#28a745',
              'not interested': '#dc3545',
              'follow up': '#fd7e14',
              'in progress': '#6f42c1',
              'no answer': '#adb5bd',
              'call not reach': '#adb5bd',
              'wrong number': '#adb5bd',
              'voice mail': '#adb5bd',
              'scheduled for meeting': '#0dcaf0',
              'do not call': '#212529',
              'interested': '#28a745'
            }[key] || '#adb5bd';
            let badgeClass = {
              'new': 'primary',
              'converted': 'success',
              'not interested': 'danger',
              'follow up': 'warning text-dark',
              'in progress': 'info',
              'no answer': 'secondary',
              'call not reach': 'secondary',
              'wrong number': 'secondary',
              'voice mail': 'secondary',
              'scheduled for meeting': 'info',
              'do not call': 'dark',
              'interested': 'success'
            }[key] || 'secondary';
            let badgeParts = badgeClass.split(' ');
            let badgeHtml = `<span class="badge bg-${badgeParts[0]}${badgeParts[1] ? ' ' + badgeParts[1] : ''} align-middle">${data.status}</span>`;
            let dotHtml = `<span class="align-middle" style="color: ${dotColor}; font-size: 1.2em; vertical-align: middle;">●</span>`;
            var statusCell = document.querySelector('tr[data-bs-target="#details-' + leadId + '"] td:nth-child(8)');
            if (statusCell) {
              statusCell.innerHTML = dotHtml + ' ' + badgeHtml + `<span class="main-row-status d-none" data-lead-id="${leadId}">${data.status}</span>`;
            }
            var mainRowFollowup = document.querySelector('.main-row-followup[data-lead-id="' + leadId + '"]');
            if (mainRowFollowup) mainRowFollowup.textContent = data.followup_date || '-';
            
            // Update follow-up history if provided
            if (data.followup_history && data.followup_history.length > 0) {
              var historyContainer = document.querySelector('#details-' + leadId + ' .col-md-12.mb-3 .mt-2');
              if (historyContainer) {
                var historyHtml = data.followup_history.map(history => 
                  `<div class="badge bg-info me-2 mb-1">
                    ${history.number === 1 ? '1st' : history.number === 2 ? '2nd' : history.number === 3 ? '3rd' : history.number + 'th'} Follow-up: ${history.date}
                  </div>`
                ).join('');
                historyContainer.innerHTML = historyHtml;
              }
            }
            
            var detailsRow = document.getElementById('details-' + leadId);
            if (detailsRow && detailsRow.classList.contains('show')) {
              var collapseInstance = bootstrap.Collapse.getOrCreateInstance(detailsRow);
              collapseInstance.hide();
            }
            var toast = document.createElement('div');
            toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
            toast.textContent = 'Lead updated successfully! Refreshing page...';
            document.body.appendChild(toast);
            setTimeout(() => {
              toast.remove();
              // Auto-refresh the page after successful update, preserving current filters
              const currentUrl = window.location.href;
              window.location.href = currentUrl;
            }, 1500);
          } else {
            var toast = document.createElement('div');
            toast.className = 'alert alert-danger position-fixed top-0 end-0 m-3';
            toast.textContent = 'Update failed: ' + (data.error || 'Unknown error');
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
          }
        })
        .catch(err => {
          var toast = document.createElement('div');
          toast.className = 'alert alert-danger position-fixed top-0 end-0 m-3';
          toast.textContent = 'Network error: ' + err.message;
          document.body.appendChild(toast);
          setTimeout(() => toast.remove(), 3000);
        });
      });
    });

    // Delete Lead AJAX logic
    document.querySelectorAll('.btn-danger').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var leadId = this.getAttribute('data-lead-id');
        if (!leadId) return;
        if (!confirm('Are you sure you want to delete this lead? This cannot be undone.')) return;
        var formData = new FormData();
        formData.append('lead_id', leadId);
        formData.append('csrf_token', '{{ csrf_token() }}');
        fetch('/delete_lead', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Remove the main and details rows from the table
            var mainRow = document.querySelector('tr[data-bs-target="#details-' + leadId + '"]');
            var detailsRow = document.getElementById('details-' + leadId);
            if (mainRow) mainRow.remove();
            if (detailsRow) detailsRow.remove();
            var toast = document.createElement('div');
            toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
            toast.textContent = 'Lead deleted successfully!';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
          } else {
            var toast = document.createElement('div');
            toast.className = 'alert alert-danger position-fixed top-0 end-0 m-3';
            toast.textContent = 'Delete failed: ' + (data.error || 'Unknown error');
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
          }
        });
      });
    });

    // Reset edit mode on collapse
    document.querySelectorAll('tr.collapse').forEach(function(row) {
      row.addEventListener('hidden.bs.collapse', function() {
        var leadId = this.id.replace('details-', '');
        var editableDiv = this.querySelector('.lead-details-editable');
        if (editableDiv) {
          // Hide all edit fields and show display fields
          editableDiv.querySelectorAll('.edit-website-input, .edit-notes-textarea, .edit-followup-input, .edit-contacts, .edit-industry-input, .edit-country-input, .edit-state-input, .edit-timezone-input').forEach(function(el) {
            el.classList.add('d-none');
          });
          editableDiv.querySelectorAll('.display-website, .editable-notes, .editable-followup, .display-contacts, .display-industry, .display-country, .display-state, .display-timezone').forEach(function(el) {
            el.classList.remove('d-none');
          });
        }
      });
    });

    // Click-to-copy for phone and email using event delegation with fallback
    document.body.addEventListener('click', function(e) {
      if (e.target.classList.contains('copy-phone')) {
        e.preventDefault(); // Prevent default behavior
        let value = e.target.textContent.trim().replace(/[^+\d]/g, '');
        copyToClipboard(value);
      } else if (e.target.classList.contains('copy-email')) {
        e.preventDefault(); // Prevent default behavior
        let value = e.target.textContent.trim();
        copyToClipboard(value);
      }
    });

    function copyToClipboard(value) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(value).then(function() {
          showCopyToast(value);
        }, function() {
          fallbackCopyTextToClipboard(value);
        });
      } else {
        fallbackCopyTextToClipboard(value);
      }
    }

    function fallbackCopyTextToClipboard(text) {
      var textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      textArea.style.top = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      try {
        document.execCommand('copy');
        showCopyToast(text);
      } catch (err) {}
      document.body.removeChild(textArea);
    }

    function showCopyToast(value) {
      var toast = document.createElement('div');
      toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
      toast.textContent = value + ' copied!';
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 1500);
    }

    // AJAX search/filter for dashboard
    const leadsTableBody = document.getElementById('leads-table-body');
    const searchInput = document.querySelector('input[name="search"]');
    const statusSelect = document.querySelector('select[name="status"]');
    const countrySelect = document.querySelector('select[name="country"]');
    const industrySelect = document.querySelector('select[name="industry"]');
    const timezoneSelect = document.querySelector('select[name="timezone"]');
    const filterBtn = document.querySelector('button[type="submit"], button#filter-btn, .btn-filter');

    // Update status dot and badge mapping in JS and Jinja:
    let statusDotColor = {
      'new': '#007bff',
      'converted': '#28a745',
      'not interested': '#dc3545',
      'follow up': '#fd7e14',
      'in progress': '#6f42c1',
      'no answer': '#adb5bd',
      'call not reach': '#adb5bd',
      'wrong number': '#adb5bd',
      'voice mail': '#adb5bd',
      'scheduled for meeting': '#0dcaf0',
      'do not call': '#212529',
      'interested': '#28a745'
    };
    let statusBadgeClass = {
      'new': 'primary',
      'converted': 'success',
      'not interested': 'danger',
      'follow up': 'warning text-dark',
      'in progress': 'info',
      'no answer': 'secondary',
      'call not reach': 'secondary',
      'wrong number': 'secondary',
      'voice mail': 'secondary',
      'scheduled for meeting': 'info',
      'do not call': 'dark',
      'interested': 'success'
    };
    let statusDot = (status) => {
      let key = (status || '').toLowerCase().trim();
      return `<span class="align-middle" style="color: ${statusDotColor[key] || '#adb5bd'}; font-size: 1.2em; vertical-align: middle;">●</span>`;
    };
    let statusBadge = (status) => {
      let key = (status || '').toLowerCase().trim();
      let badge = statusBadgeClass[key];
      if (!badge) badge = 'secondary';
      // Split all classes and join with space, always include 'badge' and 'align-middle'
      let classes = badge.split(' ').map(cls => (cls.startsWith('bg-') || cls.startsWith('text-')) ? cls : 'bg-' + cls).join(' ');
      if (!classes.includes('bg-')) classes = 'bg-secondary ' + classes;
      return `<span class="badge ${classes} align-middle">${status}</span>`;
    };

    // Add JS industry_badge function for AJAX rendering
    function industry_badge(industry) {
      if (!industry) return '';
      const key = (industry || '').toLowerCase().trim();
      const badge_map = {
        'e-commerce / online retail': 'info',
        'fashion & apparel': 'primary',
        'jewelry & luxury goods': 'warning',
        'real estate': 'success',
        'photography studios': 'secondary',
        'wedding & event photographers': 'danger',
        'advertising & creative agencies': 'dark',
        'marketing firms': 'info',
        'magazine & publishing houses': 'primary',
        'automotive dealerships': 'success',
        'furniture & home decor brands': 'warning',
        'cosmetics & skincare brands': 'danger',
        'modeling agencies': 'info',
        'printing & packaging companies': 'secondary',
        'product manufacturers': 'primary',
        'auction houses': 'dark',
        'food & beverage brands': 'success',
        'eyewear & accessories brands': 'info',
        'stock photography agencies': 'secondary',
        'electronics & gadgets retailers': 'primary',
        'wellness photographer': 'success',
        'business + creativity coach': 'warning',
        'commercial studio & lifestyle photographer': 'danger',
        'lead photographer': 'info'
      };
      const badge = badge_map[key] || 'secondary';
      return `<span class="badge bg-${badge}">${industry}</span>`;
    }

    function renderLeadRow(lead) {
      // Render the main row and details row for a lead (simplified for demo; expand as needed)
      let contact = lead.contacts[0] || {name: '', position: '', phones: [], emails: []};
      let phone = contact.phones[0] || '';
      let email = contact.emails[0] || '';
      let sourceColor = {
        'Google Maps / Search': 'primary',
        'LinkdIN': 'info',
        'Instagram': 'danger',
        'Directory Websites': 'warning text-dark',
        'Freelancer Marketplace': 'success',
        'Email Marketing': 'secondary',
        'Direct Clients (SEO)': 'dark',
        'PPC Campigns': 'primary',
        'Recomendations': 'success'
      }[lead.source] || 'secondary';
      let mainRow = `
        <tr data-bs-toggle="collapse" data-bs-target="#details-${lead.id}" aria-expanded="false" aria-controls="details-${lead.id}" style="cursor:pointer; background-color: #f9f9f9;">
          <td><input type="checkbox" class="select-lead-checkbox" value="${lead.id}" style="display:none; margin-right:4px;"/> <strong>${lead.company_name}</strong></td>
          <td>${lead.country}${lead.state ? ', ' + lead.state : ''}</td>
          <td>${industry_badge(lead.industry)}</td>
          <td>${contact.name}</td>
          <td>${contact.position || ''}</td>
          <td class="copy-phone">${phone}</td>
          <td class="copy-email">${email}</td>
          <td>${statusDot(lead.status)} ${statusBadge(lead.status)}<span class="main-row-status d-none" data-lead-id="${lead.id}">${lead.status}</span></td>
          <td><span class="main-row-followup" data-lead-id="${lead.id}">${lead.followup_date || '-'}</span></td>
          <td class="main-row-created" style="display:none;">${lead.created_at}</td>
        </tr>
      `;
      let detailsRow = `
        <tr class="collapse bg-light" id="details-${lead.id}" data-bs-parent="#leads-table-body">
          <td colspan="9">
            <div class="p-3 lead-details-editable" data-lead-id="${lead.id}" style="border:2px dashed #f39c12;">
              <div class="row">
                <div class="col-md-4 mb-2">
                  <strong>Company Website:</strong>
                  <span class="editable-website" data-lead-id="${lead.id}" style="cursor:pointer;">${lead.company_website}</span>
                  <a href="${lead.company_website}" target="_blank" rel="noopener" class="ms-1 website-link" data-lead-id="${lead.id}" title="Open website">🔗</a>
                  <input type="text" class="form-control form-control-sm edit-website-input d-none mt-2" data-lead-id="${lead.id}" value="${lead.company_website}" placeholder="https://company.com" autocomplete="off">
                  <div class="mt-1"><span class="badge bg-${sourceColor}">${lead.source}</span></div>
                  <div class="mt-1">${industry_badge(lead.industry)}</div>
                </div>
                <div class="col-md-4 mb-2">
                  <strong>Notes:</strong>
                  <span class="editable-notes truncate-notes" data-lead-id="${lead.id}">${lead.notes || 'Click to add notes'}</span>
                  ${lead.notes && lead.notes.length > 200 ? `<span class="read-more-link" data-lead-id="${lead.id}">Read more…</span>` : ''}
                  <textarea class="form-control form-control-sm edit-notes-textarea d-none mt-2" data-lead-id="${lead.id}" rows="3">${lead.notes || ''}</textarea>
                </div>
                <div class="col-md-4 mb-2">
                  <strong>Created:</strong> ${lead.created_at}<br>
                  <strong>Updated:</strong> ${lead.updated_at}<br>
                  <strong>Follow-up:</strong>
                  <span class="editable-followup" data-lead-id="${lead.id}">${lead.followup_date || 'Click to set follow-up'}</span>
                  <input type="text" class="form-control form-control-sm edit-followup-input d-none mt-2" data-lead-id="${lead.id}" value="${lead.followup_date || ''}" placeholder="YYYY-MM-DD" autocomplete="off">
                </div>
              </div>
                            ${lead.followup_history && lead.followup_history.length > 0 ? `
              <div class="row">
                <div class="col-md-12 mb-3">
                  <strong>Follow-up History:</strong>
                  <div class="mt-2">
                    ${lead.followup_history.map(history => {
                      let badgeClass = 'bg-info'; // Default blue for 1st
                      if (history.number === 2) badgeClass = 'bg-warning'; // Yellow for 2nd
                      else if (history.number === 3) badgeClass = 'bg-danger'; // Red for 3rd
                      else if (history.number > 3) badgeClass = 'bg-secondary'; // Gray for 4th+
                      
                      return `<div class="badge ${badgeClass} me-2 mb-1">
                        ${history.number === 1 ? '1st' : history.number === 2 ? '2nd' : history.number === 3 ? '3rd' : history.number + 'th'} Follow-up: ${history.date} (${history.status})
                      </div>`;
                    }).join('')}
                  </div>
                </div>
              </div>
              ` : ''}
              <div class="row">
                <div class="col-md-12">
                  <strong>All Contacts:</strong>
                  <ul class="list-unstyled mb-0 display-contacts" data-lead-id="${lead.id}">
                    ${lead.contacts.map(c => `
                      <div class="row">
                        <div class="col-md-4 mb-2">
                          <span class="fw-bold">${c.name}</span> (${c.position || ''})<br>
                          ${c.phones.map(p => `<span class="me-2 copy-phone">${p}</span>`).join('')}
                          ${c.emails.map(e => `<span class="me-2 copy-email">${e}</span>`).join('')}
                          ${c.socials.map(s => `<span class="me-2"><a href="${s.url}" target="_blank">${s.type || 'Social'}</a></span>`).join('')}
                        </div>
                      </div>`).join('')}
                  </ul>
                  <div class="edit-contacts d-none" data-lead-id="${lead.id}" style="background:#ffe4b2;display:block;">
                    ${lead.contacts.map(c => `
                      <div class="mb-2 border rounded p-2">
                        <input type="text" class="form-control form-control-sm mb-1" value="${c.name}" placeholder="Name">
                        <input type="text" class="form-control form-control-sm mb-1" value="${c.position || ''}" placeholder="Position">
                        ${c.phones.map(p => `<input type="text" class="form-control form-control-sm mb-1" value="${p}" placeholder="Phone">`).join('')}
                        ${c.emails.map(e => `<input type="email" class="form-control form-control-sm mb-1" value="${e}" placeholder="Email">`).join('')}
                        ${c.socials.map(s => `<input type="text" class="form-control form-control-sm mb-1" value="${s.url}" placeholder="Social URL"><input type="text" class="form-control form-control-sm mb-1" value="${s.type || ''}" placeholder="Social Type">`).join('')}
                      </div>`).join('')}
                  </div>
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-md-3">
                  <strong>Industry:</strong> <span class="display-industry" data-lead-id="${lead.id}">${lead.industry}</span>
                  <input type="text" class="form-control form-control-sm edit-industry-input d-none" data-lead-id="${lead.id}" value="${lead.industry}" placeholder="Industry" style="background:#e2f7e2;display:block;">
                </div>
                <div class="col-md-3">
                  <strong>Country:</strong> <span class="display-country" data-lead-id="${lead.id}">${lead.country}</span>
                  <input type="text" class="form-control form-control-sm edit-country-input d-none" data-lead-id="${lead.id}" value="${lead.country}" placeholder="Country" style="background:#e2f7e2;display:block;">
                </div>
                <div class="col-md-3">
                  <strong>State:</strong> <span class="display-state" data-lead-id="${lead.id}">${lead.state || ''}</span>
                  <input type="text" class="form-control form-control-sm edit-state-input d-none" data-lead-id="${lead.id}" value="${lead.state || ''}" placeholder="State" style="background:#e2f7e2;display:block;">
                </div>
                <div class="col-md-3">
                  <strong>Timezone:</strong> <span class="display-timezone" data-lead-id="${lead.id}">${lead.timezone || ''}</span>
                  <input type="text" class="form-control form-control-sm edit-timezone-input d-none" data-lead-id="${lead.id}" value="${lead.timezone || ''}" placeholder="Timezone" style="background:#e2f7e2;display:block;">
                </div>
              </div>
              <div class="row mt-2">
                <div class="col-md-12 mb-2">
                  <strong>Status:</strong>
                  <select class="form-select form-select-sm status-dropdown d-inline w-auto" data-lead-id="${lead.id}">
                    <option value="New" ${lead.status === 'New' ? 'selected' : ''}>New</option>
                    <option value="Not Interested" ${lead.status === 'Not Interested' ? 'selected' : ''}>Not Interested</option>
                    <option value="Call not reach" ${lead.status === 'Call not reach' ? 'selected' : ''}>Call not reach</option>
                    <option value="Follow Up" ${lead.status === 'Follow Up' ? 'selected' : ''}>Follow Up</option>
                    <option value="Wrong Number" ${lead.status === 'Wrong Number' ? 'selected' : ''}>Wrong Number</option>
                    <option value="Voice Mail" ${lead.status === 'Voice Mail' ? 'selected' : ''}>Voice Mail</option>
                    <option value="Converted" ${lead.status === 'Converted' ? 'selected' : ''}>Converted</option>
                    <option value="Scheduled for Meeting" ${lead.status === 'Scheduled for Meeting' ? 'selected' : ''}>Scheduled for Meeting</option>
                    <option value="In Progress" ${lead.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                    <option value="No Answer" ${lead.status === 'No Answer' ? 'selected' : ''}>No Answer</option>
                    <option value="Do Not Call" ${lead.status === 'Do Not Call' ? 'selected' : ''}>Do Not Call</option>
                    <option value="Interested" ${lead.status === 'Interested' ? 'selected' : ''}>Interested</option>
                  </select>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-12 d-flex justify-content-center gap-3">
                  <button type="button" class="btn btn-warning btn-edit-details" data-lead-id="${lead.id}">Edit</button>
                  <button type="button" class="btn btn-success btn-update-details" data-lead-id="${lead.id}">Update</button>
                  <button type="button" class="btn btn-danger" data-lead-id="${lead.id}">Delete</button>
                </div>
              </div>
            </div>
          </td>
        </tr>
      `;
      return mainRow + detailsRow;
    }

    let currentPage = 1;
    let perPage = 20;
    function renderPagination(total, page, perPage) {
      const totalPages = Math.ceil(total / perPage);
      const pag = document.getElementById('leads-pagination');
      pag.innerHTML = '';
      if (totalPages <= 1) return;
      // Previous
      pag.innerHTML += `<li class="page-item${page === 1 ? ' disabled' : ''}"><a class="page-link" href="#" data-page="${page-1}">Previous</a></li>`;
      // Page numbers
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || Math.abs(i - page) <= 2) {
          pag.innerHTML += `<li class="page-item${i === page ? ' active' : ''}"><a class="page-link" href="#" data-page="${i}">${i}</a></li>`;
        } else if (i === page - 3 || i === page + 3) {
          pag.innerHTML += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
        }
      }
      // Next
      pag.innerHTML += `<li class="page-item${page === totalPages ? ' disabled' : ''}"><a class="page-link" href="#" data-page="${page+1}">Next</a></li>`;
      // Click handlers
      pag.querySelectorAll('a.page-link').forEach(a => {
        a.addEventListener('click', function(e) {
          e.preventDefault();
          const newPage = parseInt(this.getAttribute('data-page'));
          if (!isNaN(newPage) && newPage !== page) {
            currentPage = newPage;
            fetchAndRenderLeads();
          }
        });
      });
    }
    function fetchAndRenderLeads() {
      // Get filter values from URL parameters first, then fall back to form values
      const urlParams = new URLSearchParams(window.location.search);
      const searchValue = urlParams.get('search') || searchInput.value;
      const statusValue = urlParams.get('status') || statusSelect.value;
      const countryValue = urlParams.get('country') || countrySelect.value;
      const industryValue = urlParams.get('industry') || industrySelect.value;
      const timezoneValue = urlParams.get('timezone') || timezoneSelect.value;
      
      let params = new URLSearchParams({
        search: searchValue,
        status: statusValue,
        country: countryValue,
        industry: industryValue,
        timezone: timezoneValue,
        page: currentPage,
        per_page: perPage
      });
      
      // Add followup_range if present in URL
      const followupRange = urlParams.get('followup_range');
      if (followupRange) {
        params.append('followup_range', followupRange);
      }
      
      leadsTableBody.innerHTML = '<tr><td colspan="9" class="text-center">Loading...</td></tr>';
      fetch('/ajax_search_leads?' + params.toString(), {
        credentials: 'same-origin'
      })
        .then(res => {
          if (!res.ok) throw new Error('Network response was not ok');
          return res.json();
        })
        .then(data => {
          if (!data.leads) throw new Error('Invalid response format');
          let leads = data.leads;
          if (leads.length === 0) {
            leadsTableBody.innerHTML = '<tr><td colspan="9" class="text-center">No leads found.</td></tr>';
          } else {
            leadsTableBody.innerHTML = leads.map(renderLeadRow).join('');
            attachEditEventListeners();
          }
          renderPagination(data.total, data.page, data.per_page);
        })
        .catch(err => {
          leadsTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading leads: ' + err.message + '</td></tr>';
        });
    }

    // Function to initialize filters from URL parameters
    function initializeFiltersFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('search')) searchInput.value = urlParams.get('search');
      if (urlParams.get('status')) statusSelect.value = urlParams.get('status');
      if (urlParams.get('country')) countrySelect.value = urlParams.get('country');
      if (urlParams.get('industry')) industrySelect.value = urlParams.get('industry');
      if (urlParams.get('timezone')) timezoneSelect.value = urlParams.get('timezone');
    }

    // Function to re-attach all edit event listeners after AJAX render
    function attachEditEventListeners() {
      // Click-to-edit Notes logic
      document.querySelectorAll('.editable-notes').forEach(function(span) {
        span.addEventListener('click', function() {
          var leadId = this.getAttribute('data-lead-id');
          this.classList.add('d-none');
          var textarea = document.querySelector('.edit-notes-textarea[data-lead-id="' + leadId + '"]');
          textarea.classList.remove('d-none');
          textarea.focus();
          function revertNotesEdit() {
            textarea.classList.add('d-none');
            span.classList.remove('d-none');
          }
          textarea.addEventListener('blur', revertNotesEdit, { once: true });
          textarea.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
              revertNotesEdit();
            }
          }, { once: true });
        });
      });
      // Click-to-edit Follow-up date logic
      document.querySelectorAll('.editable-followup').forEach(function(span) {
        span.addEventListener('click', function() {
          var leadId = this.getAttribute('data-lead-id');
          this.classList.add('d-none');
          var input = document.querySelector('.edit-followup-input[data-lead-id="' + leadId + '"]');
          input.classList.remove('d-none');
          input.value = span.textContent.trim() === 'Click to set follow-up' ? '' : span.textContent.trim();
          input.focus();
          if (!input._flatpickr) {
            flatpickr(input, {
              dateFormat: 'Y-m-d',
              allowInput: true,
              defaultDate: input.value || new Date(),
              minDate: 'today'
            });
          }
          function revertFollowupEdit() {
            input.classList.add('d-none');
            span.classList.remove('d-none');
          }
          input.addEventListener('blur', revertFollowupEdit, { once: true });
          input.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
              revertFollowupEdit();
            }
          }, { once: true });
        });
      });
      // Click-to-edit Company Website logic
      document.querySelectorAll('.editable-website').forEach(function(span) {
        span.addEventListener('click', function(e) {
          var leadId = this.getAttribute('data-lead-id');
          this.classList.add('d-none');
          var input = document.querySelector('.edit-website-input[data-lead-id="' + leadId + '"]');
          input.classList.remove('d-none');
          input.focus();
          function revertWebsiteEdit() {
            input.classList.add('d-none');
            span.classList.remove('d-none');
          }
          input.addEventListener('blur', revertWebsiteEdit, { once: true });
          input.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
              revertWebsiteEdit();
            }
          }, { once: true });
        });
      });
      // Edit, Update, Delete button logic
      document.querySelectorAll('.btn-edit-details').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var leadId = this.getAttribute('data-lead-id');
          document.querySelectorAll('.lead-details-editable').forEach(function(wrapper) {
            if (wrapper.getAttribute('data-lead-id') !== leadId) {
              wrapper.style.background = '';
              wrapper.querySelectorAll('.display-website, .display-contacts, .display-industry, .display-country, .display-state, .display-timezone').forEach(function(el) { el.classList.remove('d-none'); });
              wrapper.querySelectorAll('.edit-website-input, .edit-contacts, .edit-industry-input, .edit-country-input, .edit-state-input, .edit-timezone-input').forEach(function(el) { el.classList.add('d-none'); });
            }
          });
          var wrapper = this.closest('.lead-details-editable');
          if (wrapper) {
            wrapper.style.background = '#fffbe6';
            wrapper.querySelectorAll('.display-website, .display-contacts, .display-industry, .display-country, .display-state, .display-timezone').forEach(function(el) { el.classList.add('d-none'); });
            wrapper.querySelectorAll('.edit-website-input, .edit-contacts, .edit-industry-input, .edit-country-input, .edit-state-input, .edit-timezone-input').forEach(function(el) { el.classList.remove('d-none'); });
          }
        });
      });
      document.querySelectorAll('.btn-update-details').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var leadId = this.getAttribute('data-lead-id');
          var status = document.querySelector('.status-dropdown[data-lead-id="' + leadId + '"]').value;
          var followupInput = document.querySelector('.edit-followup-input[data-lead-id="' + leadId + '"]');
          var followupDate = followupInput ? followupInput.value : '';
          var notesTextarea = document.querySelector('.edit-notes-textarea[data-lead-id="' + leadId + '"]');
          var notesValue = notesTextarea ? notesTextarea.value : '';
          var formData = new FormData();
          formData.append('lead_id', leadId);
          formData.append('status', status);
          formData.append('followup_date', followupDate);
          formData.append('notes', notesValue);
          formData.append('csrf_token', '{{ csrf_token() }}');
          fetch('/update_lead', {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
          })
          .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.indexOf('application/json') !== -1) {
              return response.json();
            } else {
              throw new Error('Not JSON');
            }
          })
          .then(data => {
            if (data.success) {
              var followupSpan = document.querySelector('.display-followup[data-lead-id="' + leadId + '"]');
              if (followupSpan) followupSpan.textContent = data.followup_date || 'Click to set follow-up';
              var statusDropdown = document.querySelector('.status-dropdown[data-lead-id="' + leadId + '"]');
              if (statusDropdown) statusDropdown.value = data.status;
              if (data.notes !== undefined) {
                var notesSpan = document.querySelector('.editable-notes[data-lead-id="' + leadId + '"]');
                if (notesSpan) notesSpan.textContent = data.notes || 'Click to add notes';
              }
              var mainRowNotes = document.querySelector('.main-row-notes[data-lead-id="' + leadId + '"]');
              if (mainRowNotes) mainRowNotes.textContent = data.notes || '';
              var mainRowStatus = document.querySelector('.main-row-status[data-lead-id="' + leadId + '"]');
              if (mainRowStatus) mainRowStatus.textContent = data.status || '';
              
              // Check if status changed from 'New' to something else
              var originalStatus = mainRowStatus ? mainRowStatus.textContent.trim() : '';
              var newStatus = data.status || '';
              
              // If status changed from 'New' to something else, remove the lead from current view
              if (originalStatus === 'New' && newStatus !== 'New') {
                var mainRow = document.querySelector('tr[data-bs-target="#details-' + leadId + '"]');
                var detailsRow = document.getElementById('details-' + leadId);
                if (mainRow) mainRow.remove();
                if (detailsRow) detailsRow.remove();
                
                // Check if we need to fetch more data to fill the page
                var remainingRows = document.querySelectorAll('#leads-table-body tr').length;
                if (remainingRows < perPage) {
                  // Fetch additional leads to fill the page
                  fetchAdditionalLeads();
                }
                
                var toast = document.createElement('div');
                toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
                toast.textContent = 'Lead status updated! Lead moved to ' + newStatus + ' category.';
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
                return; // Exit early since we removed the rows
              }
              
              // Update status display if lead remains in view
              let key = (data.status || '').toLowerCase().trim();
              let dotColor = {
                'new': '#007bff',
                'converted': '#28a745',
                'not interested': '#dc3545',
                'follow up': '#fd7e14',
                'in progress': '#6f42c1',
                'no answer': '#adb5bd',
                'call not reach': '#adb5bd',
                'wrong number': '#adb5bd',
                'voice mail': '#adb5bd',
                'scheduled for meeting': '#0dcaf0',
                'do not call': '#212529',
                'interested': '#28a745'
              }[key] || '#adb5bd';
              let badgeClass = {
                'new': 'primary',
                'converted': 'success',
                'not interested': 'danger',
                'follow up': 'warning text-dark',
                'in progress': 'info',
                'no answer': 'secondary',
                'call not reach': 'secondary',
                'wrong number': 'secondary',
                'voice mail': 'secondary',
                'scheduled for meeting': 'info',
                'do not call': 'dark',
                'interested': 'success'
              }[key] || 'secondary';
              let badgeParts = badgeClass.split(' ');
              let badgeHtml = `<span class="badge bg-${badgeParts[0]}${badgeParts[1] ? ' ' + badgeParts[1] : ''} align-middle">${data.status}</span>`;
              let dotHtml = `<span class="align-middle" style="color: ${dotColor}; font-size: 1.2em; vertical-align: middle;">●</span>`;
              var statusCell = document.querySelector('tr[data-bs-target="#details-' + leadId + '"] td:nth-child(8)');
              if (statusCell) {
                statusCell.innerHTML = dotHtml + ' ' + badgeHtml + `<span class="main-row-status d-none" data-lead-id="${leadId}">${data.status}</span>`;
              }
              var mainRowFollowup = document.querySelector('.main-row-followup[data-lead-id="' + leadId + '"]');
              if (mainRowFollowup) mainRowFollowup.textContent = data.followup_date || '-';
              
              // Update follow-up history if provided
              if (data.followup_history && data.followup_history.length > 0) {
                var historyContainer = document.querySelector('#details-' + leadId + ' .col-md-12.mb-3 .mt-2');
                if (historyContainer) {
                  var historyHtml = data.followup_history.map(history => {
                    let badgeClass = 'bg-info'; // Default blue for 1st
                    if (history.number === 2) badgeClass = 'bg-warning'; // Yellow for 2nd
                    else if (history.number === 3) badgeClass = 'bg-danger'; // Red for 3rd
                    else if (history.number > 3) badgeClass = 'bg-secondary'; // Gray for 4th+
                    
                    return `<div class="badge ${badgeClass} me-2 mb-1">
                      ${history.number === 1 ? '1st' : history.number === 2 ? '2nd' : history.number === 3 ? '3rd' : history.number + 'th'} Follow-up: ${history.date} (${history.status})
                    </div>`;
                  }).join('');
                  historyContainer.innerHTML = historyHtml;
                }
              }
              
              var detailsRow = document.getElementById('details-' + leadId);
              if (detailsRow && detailsRow.classList.contains('show')) {
                var collapseInstance = bootstrap.Collapse.getOrCreateInstance(detailsRow);
                collapseInstance.hide();
              }
              var toast = document.createElement('div');
              toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
              toast.textContent = 'Lead updated successfully! Refreshing page...';
              document.body.appendChild(toast);
              setTimeout(() => {
                toast.remove();
                // Auto-refresh the page after successful update, preserving current filters
                const currentUrl = window.location.href;
                window.location.href = currentUrl;
              }, 1500);
            } else {
              var toast = document.createElement('div');
              toast.className = 'alert alert-danger position-fixed top-0 end-0 m-3';
              toast.textContent = 'Update failed: ' + (data.error || 'Unknown error');
              document.body.appendChild(toast);
              setTimeout(() => toast.remove(), 3000);
            }
          })
          .catch(err => {
            var toast = document.createElement('div');
            toast.className = 'alert alert-danger position-fixed top-0 end-0 m-3';
            toast.textContent = 'Network error: ' + err.message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
          });
        });
      });
      // Delete button logic
      document.querySelectorAll('.btn-danger').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var leadId = this.getAttribute('data-lead-id');
          if (!leadId) return;
          if (!confirm('Are you sure you want to delete this lead? This cannot be undone.')) return;
          var formData = new FormData();
          formData.append('lead_id', leadId);
          formData.append('csrf_token', '{{ csrf_token() }}');
          fetch('/delete_lead', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              var mainRow = document.querySelector('tr[data-bs-target="#details-' + leadId + '"]');
              var detailsRow = document.getElementById('details-' + leadId);
              if (mainRow) mainRow.remove();
              if (detailsRow) detailsRow.remove();
              var toast = document.createElement('div');
              toast.className = 'alert alert-success position-fixed top-0 end-0 m-3';
              toast.textContent = 'Lead deleted successfully!';
              document.body.appendChild(toast);
              setTimeout(() => toast.remove(), 2000);
            } else {
              var toast = document.createElement('div');
              toast.className = 'alert alert-danger position-fixed top-0 end-0 m-3';
              toast.textContent = 'Delete failed: ' + (data.error || 'Unknown error');
              document.body.appendChild(toast);
              setTimeout(() => toast.remove(), 3000);
            }
          });
        });
      });
    }

    // Function to update URL with current filters
    function updateURLWithFilters() {
      const urlParams = new URLSearchParams();
      if (searchInput.value) urlParams.set('search', searchInput.value);
      if (statusSelect.value) urlParams.set('status', statusSelect.value);
      if (countrySelect.value) urlParams.set('country', countrySelect.value);
      if (industrySelect.value) urlParams.set('industry', industrySelect.value);
      if (timezoneSelect.value) urlParams.set('timezone', timezoneSelect.value);
      
      const newURL = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
      window.history.pushState({}, '', newURL);
    }

    // Function to apply filters and reload data
    function applyFilters() {
      updateURLWithFilters();
      currentPage = 1;
      fetchAndRenderLeads();
    }

    // Trigger AJAX search on input/filter change
    [searchInput, statusSelect, countrySelect, industrySelect, timezoneSelect].forEach(function(el) {
      if (el) {
        el.addEventListener('input', function() { 
          currentPage = 1; 
          applyFilters();
        });
        el.addEventListener('change', function() { 
          currentPage = 1; 
          applyFilters();
        });
      }
    });
    
    // Filter button click handler
    if (document.getElementById('filter-btn')) {
      document.getElementById('filter-btn').addEventListener('click', function(e) {
        e.preventDefault();
        currentPage = 1;
        applyFilters();
      });
    }

    // After page load, attach all edit event listeners
    attachEditEventListeners();
    initializeFiltersFromURL(); // Initialize filters from URL parameters
    fetchAndRenderLeads(); // Call fetchAndRenderLeads() on page load

    // Update the href of the website link when the website input is edited and saved
    document.querySelectorAll('.edit-website-input').forEach(function(input) {
      input.addEventListener('change', function() {
        var leadId = this.getAttribute('data-lead-id');
        var link = document.querySelector('.website-link[data-lead-id="' + leadId + '"]');
        if (link) {
          link.href = this.value;
        }
      });
    });

    // Minimal, isolated dashboard card click handlers
    document.getElementById('card-new-leads').onclick = function() {
      // Set filter to today only
      const today = new Date().toISOString().slice(0, 10);
      document.querySelector('input[name="search"]').value = '';
      document.querySelector('select[name="status"]').value = '';
      document.querySelector('select[name="country"]').value = '';
      document.querySelector('select[name="industry"]').value = '';
      document.querySelector('select[name="timezone"]').value = '';
      window.location.href = '?date=' + today;
    };
    document.getElementById('card-followups').onclick = function() {
      // Show followup dues in the table via AJAX
      // Clear all filters
      document.querySelector('input[name="search"]').value = '';
      document.querySelector('select[name="status"]').value = '';
      document.querySelector('select[name="country"]').value = '';
      document.querySelector('select[name="industry"]').value = '';
      document.querySelector('select[name="timezone"]').value = '';
      
      // Remove any existing messages first
      const existingMessages = document.querySelectorAll('.text-center.py-5');
      existingMessages.forEach(msg => {
        if (msg.querySelector('.display-1') && 
            (msg.querySelector('.display-1').textContent.includes('📅') || 
             msg.querySelector('.display-1').textContent.includes('🛎️') ||
             msg.querySelector('.display-1').textContent.includes('🆕'))) {
          msg.remove();
        }
      });
      
      // Set a global followupRange variable and reload the table
      window.history.replaceState(null, '', '?followup_range=pending');
      fetchAndRenderLeadsWithFollowupRange('pending');
    };

    // Add this function to support followup_range AJAX filtering
    function fetchAndRenderLeadsWithFollowupRange(followupRange) {
      let params = new URLSearchParams({
        search: searchInput.value,
        status: statusSelect.value,
        country: countrySelect.value,
        industry: industrySelect.value,
        timezone: timezoneSelect.value,
        page: currentPage,
        per_page: perPage,
        followup_range: followupRange
      });
      leadsTableBody.innerHTML = '<tr><td colspan="9" class="text-center">Loading...</td></tr>';
      fetch('/ajax_search_leads?' + params.toString(), {
        credentials: 'same-origin'
      })
        .then(res => {
          if (!res.ok) throw new Error('Network response was not ok');
          return res.json();
        })
        .then(data => {
          if (!data.leads) throw new Error('Invalid response format');
          let leads = data.leads;
          if (leads.length === 0) {
            // Hide table and show followup message for followup dues
            const tableContainer = document.querySelector('.table-responsive');
            const paginationContainer = document.querySelector('nav[aria-label="Leads pagination"]');
            
            if (tableContainer) tableContainer.style.display = 'none';
            if (paginationContainer) paginationContainer.style.display = 'none';
            
            // Remove any existing messages first
            const existingMessages = document.querySelectorAll('.text-center.py-5');
            existingMessages.forEach(msg => {
              if (msg.querySelector('.display-1') && 
                  (msg.querySelector('.display-1').textContent.includes('📅') || 
                   msg.querySelector('.display-1').textContent.includes('🛎️'))) {
                msg.remove();
              }
            });
            
            // Show follow-up message
            const messageContainer = document.createElement('div');
            messageContainer.className = 'text-center py-5 followup-message';
            messageContainer.style.cssText = 'background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px; margin: 20px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
            messageContainer.innerHTML = `
              <div class="display-1 text-muted mb-3" style="font-size: 4rem;">📅</div>
              <h1 class="display-4 text-muted mb-3" style="font-size: 3rem; font-weight: 300; color: #6c757d;">No followup dues</h1>
              <p class="lead text-muted" style="font-size: 1.25rem;">You're all caught up! Time to make some new calls and create followups.</p>
              <div class="mt-4">
                <span class="badge bg-success fs-6">Ready to call! 📞</span>
              </div>
            `;
            
            // Insert message after the table container
            if (tableContainer) {
              tableContainer.parentNode.insertBefore(messageContainer, tableContainer.nextSibling);
            }
          } else {
            // Show table and pagination if leads exist
            const tableContainer = document.querySelector('.table-responsive');
            const paginationContainer = document.querySelector('nav[aria-label="Leads pagination"]');
            
            if (tableContainer) tableContainer.style.display = '';
            if (paginationContainer) paginationContainer.style.display = '';
            
            // Remove any existing messages
            const existingMessages = document.querySelectorAll('.text-center.py-5');
            existingMessages.forEach(msg => {
              if (msg.querySelector('.display-1') && 
                  (msg.querySelector('.display-1').textContent.includes('📅') || 
                   msg.querySelector('.display-1').textContent.includes('🛎️') ||
                   msg.querySelector('.display-1').textContent.includes('🆕'))) {
                msg.remove();
              }
            });
            
            leadsTableBody.innerHTML = leads.map(renderLeadRow).join('');
            attachEditEventListeners();
            renderPagination(data.total, data.page, data.per_page);
          }
        })
        .catch(err => {
          leadsTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error loading leads: ' + err.message + '</td></tr>';
        });
    }
    document.getElementById('card-converted').onclick = function() {
      window.location.href = '/converted';
    };
    document.getElementById('card-interested').onclick = function() {
      // Show all Interested leads
      document.querySelector('input[name="search"]').value = '';
      document.querySelector('select[name="status"]').value = '';
      document.querySelector('select[name="country"]').value = '';
      document.querySelector('select[name="industry"]').value = '';
      document.querySelector('select[name="timezone"]').value = '';
      window.location.href = '?status=Interested';
    };
    document.getElementById('card-today-calls').onclick = function() {
      // Show all leads that were updated today (today's calls)
      document.querySelector('input[name="search"]').value = '';
      document.querySelector('select[name="status"]').value = '';
      document.querySelector('select[name="country"]').value = '';
      document.querySelector('select[name="industry"]').value = '';
      document.querySelector('select[name="timezone"]').value = '';
      
      // Show all leads (we'll filter by updated date on the server side)
      window.location.href = '?updated_today=true';
    };

    // Remain Leads card click: show all New leads
    var remainLeadsCard = document.getElementById('card-remain-leads');
    if (remainLeadsCard) {
      remainLeadsCard.addEventListener('click', function() {
        // Clear all filters and show New leads
        document.querySelector('input[name="search"]').value = '';
        document.querySelector('select[name="status"]').value = '';
        document.querySelector('select[name="country"]').value = '';
        document.querySelector('select[name="industry"]').value = '';
        document.querySelector('select[name="timezone"]').value = '';
        
        // Remove any existing messages
        const existingMessages = document.querySelectorAll('.text-center.py-5');
        existingMessages.forEach(msg => {
          if (msg.querySelector('.display-1') && 
              (msg.querySelector('.display-1').textContent.includes('📅') || 
               msg.querySelector('.display-1').textContent.includes('🛎️') ||
               msg.querySelector('.display-1').textContent.includes('🆕'))) {
            msg.remove();
          }
        });
        
        // Show table and pagination
        const tableContainer = document.querySelector('.table-responsive');
        const paginationContainer = document.querySelector('nav[aria-label="Leads pagination"]');
        if (tableContainer) tableContainer.style.display = '';
        if (paginationContainer) paginationContainer.style.display = '';
        
        // Redirect to show New leads (default behavior)
        window.location.href = '/';
      });
    }
    
    // New Leads Today card click: show only today's new leads
    var newLeadsTodayCard = document.getElementById('card-new-leads');
    if (newLeadsTodayCard) {
      newLeadsTodayCard.addEventListener('click', function() {
        // Clear all filters
        document.querySelector('input[name="search"]').value = '';
        document.querySelector('select[name="status"]').value = '';
        document.querySelector('select[name="country"]').value = '';
        document.querySelector('select[name="industry"]').value = '';
        document.querySelector('select[name="timezone"]').value = '';
        
        // Remove any existing messages
        const existingMessages = document.querySelectorAll('.text-center.py-5');
        existingMessages.forEach(msg => {
          if (msg.querySelector('.display-1') && 
              (msg.querySelector('.display-1').textContent.includes('📅') || 
               msg.querySelector('.display-1').textContent.includes('🛎️') ||
               msg.querySelector('.display-1').textContent.includes('🆕'))) {
            msg.remove();
          }
        });
        
        // Show table and pagination
        const tableContainer = document.querySelector('.table-responsive');
        const paginationContainer = document.querySelector('nav[aria-label="Leads pagination"]');
        if (tableContainer) tableContainer.style.display = '';
        if (paginationContainer) paginationContainer.style.display = '';
        
        // Redirect to show today's new leads
        var today = new Date();
        var yyyy = today.getFullYear();
        var mm = String(today.getMonth() + 1).padStart(2, '0');
        var dd = String(today.getDate()).padStart(2, '0');
        var todayStr = yyyy + '-' + mm + '-' + dd;
        window.location.href = '?created_today=' + todayStr;
      });
    }

    // Add multi-select and delete logic - Admin only
    let selecting = false;
    
    // Check if user is admin (buttons will only exist for admin users)
    const selectBtn = document.getElementById('select-btn');
    const deleteBtn = document.getElementById('delete-btn');
    const deleteAllBtn = document.getElementById('delete-all-btn');
    
    if (selectBtn) {
      selectBtn.onclick = function() {
        selecting = !selecting;
        document.querySelectorAll('.select-lead-checkbox').forEach(cb => cb.style.display = selecting ? '' : 'none');
      };
    }
    
    function getSelectedLeadIds() {
      return Array.from(document.querySelectorAll('.select-lead-checkbox:checked')).map(cb => cb.value);
    }
    
    if (deleteBtn) {
      deleteBtn.onclick = function() {
        const ids = getSelectedLeadIds();
        if (ids.length === 0) { alert('No leads selected!'); return; }
        if (!confirm('Delete selected leads?')) return;
        fetch('/delete_lead', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ lead_ids: ids, csrf_token: '{{ csrf_token() }}' })
        }).then(() => location.reload());
      };
    }
    
    if (deleteAllBtn) {
      deleteAllBtn.onclick = function() {
        if (!confirm('Delete ALL leads? This cannot be undone!')) return;
        fetch('/delete_lead', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ delete_all: true, csrf_token: '{{ csrf_token() }}' })
        }).then(() => location.reload());
      };
    }

    // Function to fetch additional leads to fill the page
    function fetchAdditionalLeads() {
      const urlParams = new URLSearchParams(window.location.search);
      const searchValue = urlParams.get('search') || searchInput.value;
      const statusValue = urlParams.get('status') || statusSelect.value;
      const countryValue = urlParams.get('country') || countrySelect.value;
      const industryValue = urlParams.get('industry') || industrySelect.value;
      const timezoneValue = urlParams.get('timezone') || timezoneSelect.value;
      
      // Calculate how many more leads we need
      const existingRows = document.querySelectorAll('#leads-table-body tr').length;
      const neededRows = perPage - existingRows;
      
      if (neededRows <= 0) return; // No need to fetch more
      
      let params = new URLSearchParams({
        search: searchValue,
        status: statusValue,
        country: countryValue,
        industry: industryValue,
        timezone: timezoneValue,
        page: currentPage + 1, // Get next page
        per_page: neededRows + 5 // Fetch a few extra to ensure we have enough
      });
      
      const followupRange = urlParams.get('followup_range');
      if (followupRange) {
        params.append('followup_range', followupRange);
      }
      
      fetch('/ajax_search_leads?' + params.toString(), {
        credentials: 'same-origin'
      })
        .then(res => {
          if (!res.ok) throw new Error('Network response was not ok');
          return res.json();
        })
        .then(data => {
          if (data.leads && data.leads.length > 0) {
            let leads = data.leads;
            if (followupRange) {
              leads = leads.filter(lead => lead.status === 'Follow Up');
            } else if (!statusValue) {
              leads = leads.filter(lead => lead.status === 'New');
            }
            
            // Add only the needed number of leads
            const leadsToAdd = leads.slice(0, neededRows);
            
            if (leadsToAdd.length > 0) {
              const newRows = leadsToAdd.map(renderLeadRow).join('');
              document.getElementById('leads-table-body').insertAdjacentHTML('beforeend', newRows);
              attachEditEventListeners();
            }
          }
        })
        .catch(err => {
          console.log('Error fetching additional leads:', err);
        });
    }
  });
</script>
<script>
let currentNotesLeadId = null;
document.body.addEventListener('click', function(e) {
  if (e.target.classList.contains('read-more-link')) {
    currentNotesLeadId = e.target.getAttribute('data-lead-id');
    const notesSpan = document.querySelector(`.editable-notes[data-lead-id="${currentNotesLeadId}"]`);
    document.getElementById('modal-notes-textarea').value = notesSpan ? notesSpan.textContent : '';
    const modal = new bootstrap.Modal(document.getElementById('notesModal'));
    modal.show();
  }
});
let saveNotesModalBtn = document.getElementById('save-notes-modal');
if (saveNotesModalBtn) {
  saveNotesModalBtn.addEventListener('click', function() {
    const newNotes = document.getElementById('modal-notes-textarea').value;
    if (currentNotesLeadId) {
      fetch('/update_lead', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `lead_id=${encodeURIComponent(currentNotesLeadId)}&notes=${encodeURIComponent(newNotes)}&csrf_token={{ csrf_token() }}`
      }).then(resp => resp.json()).then(data => {
        const notesSpan = document.querySelector(`.editable-notes[data-lead-id="${currentNotesLeadId}"]`);
        if (notesSpan) notesSpan.textContent = newNotes;
        bootstrap.Modal.getInstance(document.getElementById('notesModal')).hide();
      });
    }
  });
}
</script>
<!-- Notes Modal -->
<div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl" style="max-width:95vw;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="notesModalLabel">Full Notes</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea id="modal-notes-textarea" class="form-control" rows="16" style="min-height:60vh;"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="save-notes-modal">Save</button>
      </div>
    </div>
  </div>
</div>
<!-- End Notes Modal -->

<style>
.truncate-notes {
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
  text-overflow: ellipsis;
  max-height: 4.5em;
  white-space: pre-line;
}
.read-more-link {
  color: #0d6efd;
  cursor: pointer;
  text-decoration: underline;
  font-size: 0.95em;
}
#select-btn, #delete-btn, #delete-all-btn {
  min-width: 110px;
  font-weight: 500;
  letter-spacing: 0.5px;
  transition: box-shadow 0.2s, background 0.2s;
}
#select-btn:focus, #delete-btn:focus, #delete-all-btn:focus {
  box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);
}
#delete-btn:hover, #delete-all-btn:hover {
  filter: brightness(0.95);
}
#delete-all-btn {
  border-width: 2px;
}
</style>
{% endblock %} 